<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>pyWeb Literate Programming 3.3 &#8212; PyWebTool 3.2 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=61cd365c" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=c662bb8c" />
    <script src="_static/documentation_options.js?v=828ea960"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="pyWeb Literate Programming 3.3 - Test Suite" href="pyweb_test.html" />
    <link rel="prev" title="pyWeb Literate Programming" href="index.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="pyweb-literate-programming-3-3">
<h1><a class="toc-backref" href="#id6" role="doc-backlink">pyWeb Literate Programming 3.3</a><a class="headerlink" href="#pyweb-literate-programming-3-3" title="Link to this heading">¶</a></h1>
<p><strong>Yet Another Literate Programming Tool</strong></p>
<nav class="contents" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#pyweb-literate-programming-3-3" id="id6">pyWeb Literate Programming 3.3</a></p>
<ul>
<li><p><a class="reference internal" href="#introduction" id="id7">Introduction</a></p>
<ul>
<li><p><a class="reference internal" href="#background" id="id8">Background</a></p></li>
<li><p><a class="reference internal" href="#other-tools" id="id9">Other Tools</a></p></li>
<li><p><a class="reference internal" href="#py-web-lp" id="id10"><strong>py-web-lp</strong></a></p></li>
<li><p><a class="reference internal" href="#acknowledgements" id="id11">Acknowledgements</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#installing" id="id12">Installing</a></p></li>
<li><p><a class="reference internal" href="#using" id="id13">Using</a></p>
<ul>
<li><p><a class="reference internal" href="#create-web-file" id="id14">Create WEB File</a></p></li>
<li><p><a class="reference internal" href="#tangle-source-files" id="id15">Tangle Source Files</a></p></li>
<li><p><a class="reference internal" href="#weave-documentation" id="id16">Weave Documentation</a></p></li>
<li><p><a class="reference internal" href="#running-py-web-lp-to-tangle-and-weave" id="id17">Running <strong>py-web-lp</strong> to Tangle and Weave</a></p>
<ul>
<li><p><a class="reference internal" href="#command-line-options" id="id18">Command Line Options</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#bootstrapping" id="id19">Bootstrapping</a></p></li>
<li><p><a class="reference internal" href="#dependencies" id="id20">Dependencies</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#more-advanced-usage" id="id21">More Advanced Usage</a></p>
<ul>
<li><p><a class="reference internal" href="#tangle-test-and-weave-with-test-results" id="id22">Tangle, Test, and Weave with Test Results</a></p></li>
<li><p><a class="reference internal" href="#template-changes" id="id23">Template Changes</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#the-py-web-lp-markup-language" id="id24">The <strong>py-web-lp</strong> Markup Language</a></p>
<ul>
<li><p><a class="reference internal" href="#concepts" id="id25">Concepts</a></p></li>
<li><p><a class="reference internal" href="#boilerplate" id="id26">Boilerplate</a></p>
<ul>
<li><p><a class="reference internal" href="#latex" id="id27">LaTeX</a></p></li>
<li><p><a class="reference internal" href="#html" id="id28">HTML</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#structural-tags" id="id29">Structural Tags</a></p></li>
<li><p><a class="reference internal" href="#inline-tags" id="id30">Inline Tags</a></p></li>
<li><p><a class="reference internal" href="#content-tags" id="id31">Content Tags</a></p></li>
<li><p><a class="reference internal" href="#additional-features" id="id32">Additional Features</a></p></li>
<li><p><a class="reference internal" href="#controlling-indentation" id="id33">Controlling Indentation</a></p></li>
<li><p><a class="reference internal" href="#tracking-source-line-numbers" id="id34">Tracking Source Line Numbers</a></p></li>
<li><p><a class="reference internal" href="#expression-context" id="id35">Expression Context</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#architecture-and-design-overview" id="id36">Architecture and Design Overview</a></p>
<ul>
<li><p><a class="reference internal" href="#overall-structure" id="id37">Overall Structure</a></p></li>
<li><p><a class="reference internal" href="#core-web-representation" id="id38">Core WEB Representation</a></p></li>
<li><p><a class="reference internal" href="#reading-and-parsing" id="id39">Reading and Parsing</a></p></li>
<li><p><a class="reference internal" href="#emitters" id="id40">Emitters</a></p></li>
<li><p><a class="reference internal" href="#weaving" id="id41">Weaving</a></p></li>
<li><p><a class="reference internal" href="#tangling" id="id42">Tangling</a></p></li>
<li><p><a class="reference internal" href="#application" id="id43">Application</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#implementation" id="id44">Implementation</a></p>
<ul>
<li><p><a class="reference internal" href="#base-classes" id="id45">Base Classes</a></p>
<ul>
<li><p><a class="reference internal" href="#web-class" id="id46">Web Class</a></p></li>
<li><p><a class="reference internal" href="#chunk-class-hierarchy" id="id47">Chunk Class Hierarchy</a></p></li>
<li><p><a class="reference internal" href="#command-class-hierarchy" id="id48">Command Class Hierarchy</a></p>
<ul>
<li><p><a class="reference internal" href="#the-typeid-class" id="id49">The TypeId Class</a></p></li>
<li><p><a class="reference internal" href="#the-command-class" id="id50">The Command Class</a></p></li>
<li><p><a class="reference internal" href="#the-hastext-classes" id="id51">The HasText Classes</a></p></li>
<li><p><a class="reference internal" href="#the-textcommand-class" id="id52">The TextCommand Class</a></p></li>
<li><p><a class="reference internal" href="#the-codecommand-class" id="id53">The CodeCommand Class</a></p></li>
<li><p><a class="reference internal" href="#the-referencecommand-class" id="id54">The ReferenceCommand Class</a></p></li>
<li><p><a class="reference internal" href="#the-xrefcommand-classes" id="id55">The XrefCommand Classes</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#output-serialization" id="id56">Output Serialization</a></p>
<ul>
<li><p><a class="reference internal" href="#the-weaver-subclass" id="id57">The Weaver Subclass</a></p>
<ul>
<li><p><a class="reference internal" href="#common-base-template" id="id58">Common Base Template</a></p></li>
<li><p><a class="reference internal" href="#debug-macros" id="id59">Debug Macros</a></p></li>
<li><p><a class="reference internal" href="#rst-macros" id="id60">RST Macros</a></p></li>
<li><p><a class="reference internal" href="#html-macros" id="id61">HTML Macros</a></p></li>
<li><p><a class="reference internal" href="#latex-macros" id="id62">LaTeX Macros</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#the-tangler-subclasses" id="id63">The Tangler Subclasses</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#input-parsing" id="id64">Input Parsing</a></p>
<ul>
<li><p><a class="reference internal" href="#the-webreader-class" id="id65">The WebReader Class</a></p></li>
<li><p><a class="reference internal" href="#the-tokenizer-class" id="id66">The Tokenizer Class</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#other-application-components" id="id67">Other Application Components</a></p>
<ul>
<li><p><a class="reference internal" href="#error-class" id="id68">Error class</a></p></li>
<li><p><a class="reference internal" href="#action-class-hierarchy" id="id69">Action Class Hierarchy</a></p></li>
<li><p><a class="reference internal" href="#actionsequence-class" id="id70">ActionSequence Class</a></p></li>
<li><p><a class="reference internal" href="#weaveaction-class" id="id71">WeaveAction Class</a></p></li>
<li><p><a class="reference internal" href="#tangleaction-class" id="id72">TangleAction Class</a></p></li>
<li><p><a class="reference internal" href="#loadaction-class" id="id73">LoadAction Class</a></p></li>
<li><p><a class="reference internal" href="#the-application-class" id="id74">The Application Class</a></p></li>
<li><p><a class="reference internal" href="#logging-setup" id="id75">Logging Setup</a></p></li>
<li><p><a class="reference internal" href="#the-main-function" id="id76">The Main Function</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#pyweb-module-file" id="id77"><strong>pyWeb</strong> Module File</a></p>
<ul>
<li><p><a class="reference internal" href="#python-library-imports" id="id78">Python Library Imports</a></p></li>
<li><p><a class="reference internal" href="#overheads" id="id79">Overheads</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#handy-scripts" id="id80">Handy Scripts</a></p>
<ul>
<li><p><a class="reference internal" href="#tangle-py-script" id="id81"><code class="docutils literal notranslate"><span class="pre">tangle.py</span></code> Script</a></p></li>
<li><p><a class="reference internal" href="#weave-py-script" id="id82"><code class="docutils literal notranslate"><span class="pre">weave.py</span></code> Script</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#to-do" id="id83">To Do</a></p>
<ul>
<li><p><a class="reference internal" href="#additional-features-for-3-3" id="id84">Additional Features for 3.3</a></p></li>
<li><p><a class="reference internal" href="#other-extensions-for-3-4" id="id85">Other Extensions for 3.4</a></p></li>
<li><p><a class="reference internal" href="#some-additional-ideas" id="id86">Some additional ideas</a></p></li>
<li><p><a class="reference internal" href="#from-the-code" id="id87">From the code</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#change-log" id="id88">Change Log</a></p></li>
<li><p><a class="reference internal" href="#indices" id="id89">Indices</a></p>
<ul>
<li><p><a class="reference internal" href="#files" id="id90">Files</a></p></li>
<li><p><a class="reference internal" href="#macros" id="id91">Macros</a></p></li>
<li><p><a class="reference internal" href="#user-identifiers" id="id92">User Identifiers</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
<section id="introduction">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">Introduction</a><a class="headerlink" href="#introduction" title="Link to this heading">¶</a></h2>
<p>Literate programming was pioneered by Knuth as a method for
developing readable, understandable presentations of programs.
These would present a program in a literate fashion for people
to read and understand; this would be in parallel with presentation as source text
for a compiler to process and both would be generated from a common source file.</p>
<p>One intent is to synchronize the program source with the
documentation about that source.  If the program and the documentation
have a common origin, then the traditional gaps between intent
(expressed in the documentation) and action (expressed in the
working program) are significantly reduced.</p>
<p><strong>py-web-lp</strong> is a literate programming tool that combines the actions
of <em>weaving</em> a document with <em>tangling</em> source files.
It is independent of any source language.
While is designed to work with RST document markup, it should be amenable to any other
flavor of markup.
It uses a small set of markup tags to define chunks of code and
documentation.</p>
<section id="background">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">Background</a><a class="headerlink" href="#background" title="Link to this heading">¶</a></h3>
<p>The following is an almost verbatim quote from Briggs’ <em>nuweb</em> documentation,
and provides an apt summary of Literate Programming.</p>
<blockquote>
<div><p>In 1984, Knuth introduced the idea of <em>literate programming</em> and
described a pair of tools to support the practise (Donald E. Knuth,
“Literate Programming”, <em>The Computer Journal</em> 27 (1984), no. 2, 97-111.)
His approach was to combine Pascal code with T<sub>e</sub>X documentation to
produce a new language, <code class="docutils literal notranslate"><span class="pre">WEB</span></code>, that offered programmers a superior
approach to programming. He wrote several programs in <code class="docutils literal notranslate"><span class="pre">WEB</span></code>,
including <code class="docutils literal notranslate"><span class="pre">weave</span></code> and <code class="docutils literal notranslate"><span class="pre">tangle</span></code>, the programs used to support
literate programming.
The idea was that a programmer wrote one document, the web file, that
combined documentation written in T<sub>e</sub>X (Donald E. Knuth,
T<sub>e</sub>X book, Computers and Typesetting, 1986) with code (written in Pascal).</p>
<p>Running <code class="docutils literal notranslate"><span class="pre">tangle</span></code> on the web file would produce a complete
Pascal program, ready for compilation by an ordinary Pascal compiler.
The primary function of <code class="docutils literal notranslate"><span class="pre">tangle</span></code> is to allow the programmer to
present elements of the program in any desired order, regardless of
the restrictions imposed by the programming language. Thus, the
programmer is free to present his program in a top-down fashion,
bottom-up fashion, or whatever seems best in terms of promoting
understanding and maintenance.</p>
<p>Running <code class="docutils literal notranslate"><span class="pre">weave</span></code> on the web file would produce a  T<sub>e</sub>X file, ready
to be processed by  T<sub>e</sub>X. The resulting document included a variety of
automatically generated indices and cross-references that made it much
easier to navigate the code. Additionally, all of the code sections
were automatically prettyprinted, resulting in a quite impressive
document.</p>
<p>Knuth also wrote the programs for T<sub>e</sub>X and <code class="docutils literal notranslate"><span class="pre">METAFONT</span></code>
entirely in <code class="docutils literal notranslate"><span class="pre">WEB</span></code>, eventually publishing them in book
form. These are probably the
largest programs ever published in a readable form.</p>
</div></blockquote>
</section>
<section id="other-tools">
<h3><a class="toc-backref" href="#id9" role="doc-backlink">Other Tools</a><a class="headerlink" href="#other-tools" title="Link to this heading">¶</a></h3>
<p>Numerous tools have been developed based on Knuth’s initial
work.  A relatively complete survey is available at sites
like <a class="reference external" href="http://www.literateprogramming.com">Literate Programming</a>,
and the OASIS
<a class="reference external" href="http://www.oasis-open.org/cover/xmlLitProg.html">XML Cover Pages: Literate Programming with SGML and XML</a>.</p>
<p>The immediate predecessors to this <strong>py-web-lp</strong> tool are
<a class="reference external" href="http://www.ross.net/funnelweb">FunnelWeb</a>,
<a class="reference external" href="http://www.eecs.harvard.edu/~nr/noweb/">noweb</a> and
<a class="reference external" href="http://sourceforge.net/projects/nuweb/">nuweb</a>.  The ideas lifted from these other
tools created the foundation for <strong>py-web-lp</strong>.</p>
<p>There are several Python-oriented literate programming tools.
These include
<a class="reference external" href="http://personalpages.tds.net/~edream/front.html&quot;">LEO</a>,
<a class="reference external" href="http://interscript.sourceforge.net/">interscript</a>,
<a class="reference external" href="http://www.danbala.com/python/lpy/">lpy</a>,
<a class="reference external" href="http://www.egenix.com/files/python/SoftwareDescriptions.html#py2html.py">py2html</a>,
<a class="reference external" href="https://github.com/slott56/PyLit-3">PyLit-3</a></p>
<p>The <em>FunnelWeb</em> tool is independent of any programming language
and only mildly dependent on T<sub>e</sub>X.
It has 19 commands, many of which duplicate features of HTML or
L<sub>a</sub>T<sub>e</sub>X.</p>
<p>The <em>noweb</em> tool was written by Norman Ramsey.
This tool uses a sophisticated multi-processing framework, via Unix
pipes, to permit flexible manipulation of the source file to tangle
and weave the programming language and documentation markup files.</p>
<p>The <em>nuweb</em> Simple Literate Programming Tool was developed by
Preston Briggs (<a class="reference external" href="mailto:preston&#37;&#52;&#48;tera&#46;com">preston<span>&#64;</span>tera<span>&#46;</span>com</a>).  His work was supported by ARPA,
through ONR grant N00014-91-J-1989.  It is written
in C, and very focused on producing L<sub>a</sub>T<sub>e</sub>X documents.  It can
produce HTML, but this is clearly added after the fact.  It cannot be
easily extended, and is not object-oriented.</p>
<p>The <em>LEO</em> tool is a structured GUI editor for creating
source.  It uses XML and <em>noweb</em>-style chunk management.  It is more
than a simple weave and tangle tool.</p>
<p>The <em>interscript</em> tool is very large and sophisticated, but doesn’t gracefully
tolerate HTML markup in the document.  It can create a variety of
markup languages from the interscript source, making it suitable for
creating HTML as well as L<sub>a</sub>T<sub>e</sub>X.</p>
<p>The <em>lpy</em> tool can produce very complex HTML representations of
a Python program.  It works by locating documentation markup embedded
in Python comments and docstrings.  This is called “inverted literate
programming”.</p>
<p>The <em>py2html</em> tool does very sophisticated syntax coloring.</p>
<p>The <em>PyLit-3</em> tool is perhaps the very best approach to Literate
programming, since it leverages an existing lightweight markup language
and it’s output formatting. However, it’s limited in the presentation order,
making it difficult to present a complex Python module out of the proper
Python required presentation.</p>
</section>
<section id="py-web-lp">
<h3><a class="toc-backref" href="#id10" role="doc-backlink"><strong>py-web-lp</strong></a><a class="headerlink" href="#py-web-lp" title="Link to this heading">¶</a></h3>
<p><strong>py-web-lp</strong> works with any
programming language. It can work with any markup language, but is currently
configured to work with RST.  This philosophy
comes from <em>FunnelWeb</em>
<em>noweb</em>, <em>nuweb</em> and <em>interscript</em>.  The primary differences
between <strong>py-web-lp</strong> and other tools are the following.</p>
<ul class="simple">
<li><p><strong>py-web-lp</strong> is object-oriented, permitting easy extension.
<em>noweb</em> extensions
are separate processes that communicate through a sophisticated protocol.
<em>nuweb</em> is not easily extended without rewriting and recompiling
the C programs.</p></li>
<li><p><strong>py-web-lp</strong> is built in the very portable Python programming
language.  This allows it to run anywhere that Python 3.3 runs, with
only the addition of docutils.  This makes it a useful
tool for programmers in any language.</p></li>
<li><p><strong>py-web-lp</strong> is much simpler than <em>FunnelWeb</em>, <em>LEO</em> or <em>Interscript</em>.  It has
a very limited selection of commands, but can still produce
complex programs and HTML documents.</p></li>
<li><p><strong>py-web-lp</strong> does not invent a complex markup language like <em>Interscript</em>.
Because <em>Iterscript</em> has its own markup, it can generate L<sub>a</sub>T<sub>e</sub>X or HTML or other
output formats from a unique input format.  While powerful, it seems simpler to
avoid inventing yet another sophisticated markup language.  The language <strong>py-web-lp</strong>
uses is very simple, and the author’s use their preferred markup language almost
exclusively.</p></li>
<li><p><strong>py-web-lp</strong> supports the forward literate programming philosophy,
where a source document creates programming language and markup language.
The alternative, deriving the document from markup embedded in
program comments (“inverted literate programming”), seems less appealing.
The disadvantage of inverted literate programming is that the final document
can’t reflect the original author’s preferred order of exposition,
since that informtion generally isn’t part of the source code.</p></li>
<li><p><strong>py-web-lp</strong> also specifically rejects some features of <em>nuweb</em>
and <em>FunnelWeb</em>.  These include the macro capability with parameter
substitution, and multiple references to a chunk.  These two capabilities
can be used to grow object-like applications from non-object programming
languages (<em>e.g.</em> C or Pascal).  Since most modern languages (Python,
Java, C++) are object-oriented, this macro capability is more of a problem
than a help.</p></li>
<li><p>Since <strong>py-web-lp</strong> is built in the Python interpreter, a source document
can include Python expressions that are evaluated during weave operation to
produce time stamps, source file descriptions or other information in the woven
or tangled output.</p></li>
</ul>
<p><strong>py-web-lp</strong> works with any programming language; it can work with any markup language.
The initial release supports RST via simple templates.</p>
<p>The following is extensively quoted from Briggs’ <em>nuweb</em> documentation,
and provides an excellent background in the advantages of the very
simple approach started by <em>nuweb</em> and adopted by <strong>py-web-lp</strong>.</p>
<blockquote>
<div><p>The need to support arbitrary
programming languages has many consequences:</p>
<dl class="field-list simple">
<dt class="field-odd">Deferred prettyprinting<span class="colon">:</span></dt>
<dd class="field-odd"><p>Both <code class="docutils literal notranslate"><span class="pre">WEB</span></code> and <code class="docutils literal notranslate"><span class="pre">CWEB</span></code> are able to
prettyprint the code sections of their documents because they
understand the language well enough to parse it. Since we want to use
<em>any</em> language, we’ve got to abandon this feature.
Instead of doing it in this tool, we push of any pretty-printing to L<sub>a</sub>T<sub>e</sub>X or RST post-processing, where minted and pygments can be employed.</p>
</dd>
<dt class="field-even">Limited index of identifiers<span class="colon">:</span></dt>
<dd class="field-even"><p>Because <code class="docutils literal notranslate"><span class="pre">WEB</span></code> knows about Pascal,
it is able to construct an index of all the identifiers occurring in
the code sections (filtering out keywords and the standard type
identifiers). Unfortunately, this isn’t as easy in our case. We don’t
know what an identifier looks like in each language and we certainly
don’t know all the keywords.  We provide a mechanism to mark
identifiers, and we use a pretty standard pattern for recognizing
identifiers almost most programming languages.</p>
</dd>
</dl>
<p>Of course, we’ve got to have some compensation for our losses or the
whole idea would be a waste. Here are the advantages I [Briggs] can see:</p>
<dl class="field-list simple">
<dt class="field-odd">Simplicity<span class="colon">:</span></dt>
<dd class="field-odd"><p>The majority of the commands in <code class="docutils literal notranslate"><span class="pre">WEB</span></code> are concerned with control of the
automatic prettyprinting. Since we don’t prettyprint, many commands are
eliminated. A further set of commands is subsumed by L<sub>a</sub>T<sub>e</sub>X
and may also be eliminated. As a result, our set of commands is reduced to
only about seven members (explained in the next section).
This simplicity is also reflected in the size of this tool,
which is quite a bit smaller than the tools used with other approaches.</p>
</dd>
<dt class="field-even">No prettyprinting<span class="colon">:</span></dt>
<dd class="field-even"><p>Everyone disagrees about how their code should look, so automatic
formatting annoys many people. One approach is to provide ways to
control the formatting. Our approach is simpler – we perform no
automatic formatting and therefore allow the programmer complete
control of code layout.</p>
</dd>
<dt class="field-odd">Control<span class="colon">:</span></dt>
<dd class="field-odd"><p>We also offer the programmer reasonably complete control of the
layout of his output files (the files generated during tangling).
Of course, this is essential for languages that are sensitive to layout;
but it is also important in many practical situations, <em>e.g.</em>, debugging.</p>
</dd>
<dt class="field-even">Speed<span class="colon">:</span></dt>
<dd class="field-even"><p>Since [<strong>py-web-lp</strong>] doesn’t do too much, it runs very quickly.
It combines the functions of <code class="docutils literal notranslate"><span class="pre">tangle</span></code> and <code class="docutils literal notranslate"><span class="pre">weave</span></code> into a single
program that performs both functions at once.</p>
</dd>
<dt class="field-odd">Chunk numbers<span class="colon">:</span></dt>
<dd class="field-odd"><p>Inspired by the example of <strong>noweb</strong>, [<strong>py-web-lp</strong>] refers to all program code
chunks by a simple, ascending sequence number through the file.
This becomes the HTML anchor name, also.</p>
</dd>
<dt class="field-even">Multiple file output<span class="colon">:</span></dt>
<dd class="field-even"><p>The programmer may specify more than one output file in a single [<strong>py-web-lp</strong>]
source file. This is required when constructing programs in a combination of
languages (say, Fortran and C). It’s also an advantage when constructing
very large programs.</p>
</dd>
</dl>
</div></blockquote>
</section>
<section id="acknowledgements">
<h3><a class="toc-backref" href="#id11" role="doc-backlink">Acknowledgements</a><a class="headerlink" href="#acknowledgements" title="Link to this heading">¶</a></h3>
<dl class="simple">
<dt>This application is very directly based on (derived from?) work that</dt><dd><p>preceded this, particularly the following:</p>
</dd>
</dl>
<ul class="simple">
<li><p>Ross N. Williams’ <em>FunnelWeb</em> <a class="reference external" href="http://www.ross.net/funnelweb/">http://www.ross.net/funnelweb/</a></p></li>
<li><p>Norman Ramsey’s <em>noweb</em> <a class="reference external" href="http://www.eecs.harvard.edu/~nr/noweb/">http://www.eecs.harvard.edu/~nr/noweb/</a></p></li>
<li><p>Preston Briggs’ <em>nuweb</em> <a class="reference external" href="http://sourceforge.net/projects/nuweb/">http://sourceforge.net/projects/nuweb/</a>
Currently supported by Charles Martin and Marc W. Mengel</p></li>
</ul>
<p>Also, after using John Skaller’s <em>interscript</em> <a class="reference external" href="http://interscript.sourceforge.net/">http://interscript.sourceforge.net/</a>
for two large development efforts, I finally understood the feature set I really wanted.</p>
<p>Jason Fruit and others contributed to the previous version.</p>
</section>
</section>
<section id="installing">
<h2><a class="toc-backref" href="#id12" role="doc-backlink">Installing</a><a class="headerlink" href="#installing" title="Link to this heading">¶</a></h2>
<p>This requires Python 3.12.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">py</span><span class="o">-</span><span class="n">web</span><span class="o">-</span><span class="n">lp</span>
</pre></div>
</div>
<p>This will install a <code class="docutils literal notranslate"><span class="pre">pyweb</span></code> module.
Running the various commands is done with the <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">-m</span> <span class="pre">pyweb</span></code> command.</p>
</section>
<section id="using">
<h2><a class="toc-backref" href="#id13" role="doc-backlink">Using</a><a class="headerlink" href="#using" title="Link to this heading">¶</a></h2>
<p><strong>py-web-lp</strong> supports two use cases: <a class="reference internal" href="#tangle-source-files">Tangle Source Files</a> and <a class="reference internal" href="#weave-documentation">Weave Documentation</a>.
These are often combined to both tangle and weave an application and its documentation.
The work starts with creating a WEB file with both the documentation and code.</p>
<section id="create-web-file">
<h3><a class="toc-backref" href="#id14" role="doc-backlink">Create WEB File</a><a class="headerlink" href="#create-web-file" title="Link to this heading">¶</a></h3>
<p>See <a class="reference internal" href="#the-py-web-lp-markup-language">The py-web-lp Markup Language</a> for more details on the language.
For a simple example, we’ll use the following WEB file: <code class="docutils literal notranslate"><span class="pre">examples/hw.w</span></code>.</p>
<pre class="literal-block">###########
Hello World
###########

This file has a <em>small</em> example.

&#64;d The Body Of The Script &#64;{
print(&quot;Hello, World!&quot;)
&#64;}

The Python module includes a small script.

&#64;o hw.py &#64;{
&#64;&lt;The Body...&#64;&gt;
&#64;}</pre>
<p>This example will create an RST markup document.
The WEB file includes some <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> chunks to define code blocks.
The <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> is the definition of a chunk with the longish name <code class="docutils literal notranslate"><span class="pre">The</span> <span class="pre">Body</span> <span class="pre">Of</span> <span class="pre">The</span> <span class="pre">Script</span></code>.
The <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> defines an output file to be tangled.
This file has a reference to the <code class="docutils literal notranslate"><span class="pre">The</span> <span class="pre">Body</span> <span class="pre">Of</span> <span class="pre">The</span> <span class="pre">Script</span></code> chunk.</p>
<p>When tangling, the code will be used to build the file(s) defined by the <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> chunk(s).
In this example, it will write the <code class="docutils literal notranslate"><span class="pre">hw.py</span></code> file by tangling the referenced chunk.</p>
<p>When weaving, the <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> chunks will have some additional RST markup inserted to create a readable document.
The output file will have a name based on the source WEB document.
In this case it will be <code class="docutils literal notranslate"><span class="pre">hw.rst</span></code>.</p>
</section>
<section id="tangle-source-files">
<h3><a class="toc-backref" href="#id15" role="doc-backlink">Tangle Source Files</a><a class="headerlink" href="#tangle-source-files" title="Link to this heading">¶</a></h3>
<p>A user initiates this process when they have a complete <code class="docutils literal notranslate"><span class="pre">.w</span></code> file that contains  a description of source files.
These source files are described with <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> commands in the WEB file.</p>
<p>The use case is successful when the source files are produced.</p>
<p>The use case is a failure when the source files cannot be produced, due to  errors in the <code class="docutils literal notranslate"><span class="pre">.w</span></code> file.
The log messages detail the problems found.</p>
<p>A typical command to tangle (without weaving) is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">pyweb</span> <span class="o">-</span><span class="n">xw</span> <span class="n">examples</span><span class="o">/</span><span class="n">hw</span><span class="o">.</span><span class="n">w</span> <span class="o">-</span><span class="n">o</span> <span class="n">examples</span>
</pre></div>
</div>
<p>The outputs will be defined by the <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> commands in the source.
The <code class="docutils literal notranslate"><span class="pre">-o</span></code> option writes the resulting tangled files to the named directory.
The <code class="docutils literal notranslate"><span class="pre">-xw</span></code> option excludes weaving.</p>
</section>
<section id="weave-documentation">
<h3><a class="toc-backref" href="#id16" role="doc-backlink">Weave Documentation</a><a class="headerlink" href="#weave-documentation" title="Link to this heading">¶</a></h3>
<p>A user initiates this process when they have a <code class="docutils literal notranslate"><span class="pre">.w</span></code> file that contains  a document to produce.
The document is described by the entire WEB file.
The default is to use ReSTructured Text (RST) markup.
The output file will have the <code class="docutils literal notranslate"><span class="pre">.rst</span></code> suffix.</p>
<p>The use case is successful when the documentation file is produced.</p>
<p>The use case is a failure when the documentation file cannot be produced, due to  errors in the <code class="docutils literal notranslate"><span class="pre">.w</span></code> file.
The log messages detail the problems found.</p>
<p>A typical command to weave (without tangling) is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">pyweb</span> <span class="o">-</span><span class="n">xt</span> <span class="n">examples</span><span class="o">/</span><span class="n">hw</span><span class="o">.</span><span class="n">w</span> <span class="o">-</span><span class="n">o</span> <span class="n">examples</span>
</pre></div>
</div>
<p>The output will be named <code class="docutils literal notranslate"><span class="pre">examples/hw.rst</span></code>.
The <code class="docutils literal notranslate"><span class="pre">-o</span></code> option made sure the file was written to the <code class="docutils literal notranslate"><span class="pre">examples</span></code> directory.
The <code class="docutils literal notranslate"><span class="pre">-xt</span></code> option excludes tangling.</p>
</section>
<section id="running-py-web-lp-to-tangle-and-weave">
<h3><a class="toc-backref" href="#id17" role="doc-backlink">Running <strong>py-web-lp</strong> to Tangle and Weave</a><a class="headerlink" href="#running-py-web-lp-to-tangle-and-weave" title="Link to this heading">¶</a></h3>
<p>The following command will run both weaving and tanglging:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>-m<span class="w"> </span>pyweb<span class="w"> </span>examples/hw.w<span class="w"> </span>-o<span class="w"> </span>examples
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> commands in <code class="docutils literal notranslate"><span class="pre">examples/hw.w</span></code> define the files to tangle.
It will also weave the output, and create <code class="docutils literal notranslate"><span class="pre">examples/hw.rst</span></code>.
This can be processed by tools like <strong>docutils</strong> to create an HTML file.</p>
<section id="command-line-options">
<h4><a class="toc-backref" href="#id18" role="doc-backlink">Command Line Options</a><a class="headerlink" href="#command-line-options" title="Link to this heading">¶</a></h4>
<p>Currently, the following command line options are accepted.</p>
<dl class="option-list">
<dt><kbd><span class="option">-v</span></kbd></dt>
<dd><p>Verbose logging.</p>
</dd>
<dt><kbd><span class="option">-s</span></kbd></dt>
<dd><p>Silent operation.</p>
</dd>
</dl>
<dl class="simple">
<dt>-c <em>x</em></dt><dd><p>Change the command character from <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> to <code class="docutils literal notranslate"><span class="pre">*x*</span></code>.</p>
</dd>
<dt>-w <em>weaver</em></dt><dd><p>Choose a particular documentation weaver template. Currently the choices
are <code class="docutils literal notranslate"><span class="pre">rst</span></code>, <code class="docutils literal notranslate"><span class="pre">tex</span></code>, and <code class="docutils literal notranslate"><span class="pre">html</span></code>.</p>
</dd>
</dl>
<dl class="option-list">
<dt><kbd><span class="option">-x<var>w</var></span></kbd></dt>
<dd><p>Exclude weaving.  This does tangling of source program files only.</p>
</dd>
<dt><kbd><span class="option">-x<var>t</var></span></kbd></dt>
<dd><p>Exclude tangling.  This does weaving of the document file only.</p>
</dd>
</dl>
<dl class="simple">
<dt>-p <em>command</em></dt><dd><p>Permit errors in the given list of commands.  The most common
version is <code class="docutils literal notranslate"><span class="pre">-pi</span></code> to permit errors in locating an include file.
For more, see the <a class="reference internal" href="#tangle-test-and-weave-with-test-results">Tangle, Test, and Weave with Test Results</a> section.</p>
</dd>
<dt>-o <em>directory</em></dt><dd><p>The directory to which to write output files.</p>
</dd>
</dl>
</section>
</section>
<section id="bootstrapping">
<h3><a class="toc-backref" href="#id19" role="doc-backlink">Bootstrapping</a><a class="headerlink" href="#bootstrapping" title="Link to this heading">¶</a></h3>
<p><strong>py-web-lp</strong> is written using <strong>py-web-lp</strong>.
The distribution includes the original <code class="docutils literal notranslate"><span class="pre">.w</span></code> files as well as a <code class="docutils literal notranslate"><span class="pre">.py</span></code> module.</p>
<p>The bootstrap procedure is to run a “known good” <code class="docutils literal notranslate"><span class="pre">pyweb</span></code> to transform a working copy into a new version of <code class="docutils literal notranslate"><span class="pre">pyweb</span></code>.
We provide the previous release in the <code class="docutils literal notranslate"><span class="pre">bootstrap</span></code> directory.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">bootstrap</span><span class="o">/</span><span class="n">pyweb</span><span class="o">.</span><span class="n">py</span> <span class="n">pyweb</span><span class="o">.</span><span class="n">w</span>
<span class="n">rst2html</span><span class="o">.</span><span class="n">py</span> <span class="n">pyweb</span><span class="o">.</span><span class="n">rst</span> <span class="n">pyweb</span><span class="o">.</span><span class="n">html</span>
</pre></div>
</div>
<p>The resulting <code class="docutils literal notranslate"><span class="pre">pyweb.html</span></code> file is the updated documentation.
The <code class="docutils literal notranslate"><span class="pre">pyweb.py</span></code> is the updated candidate release of <strong>py-web-lp</strong>.</p>
<p>Similarly, the tests built from a <code class="docutils literal notranslate"><span class="pre">.w</span></code> files.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>pyweb.py<span class="w"> </span>tests/pyweb_test.w<span class="w"> </span>-o<span class="w"> </span>tests
<span class="nv">PYTHONPATH</span><span class="o">=</span>..<span class="w"> </span>pytest
rst2html.py<span class="w"> </span>tests/pyweb_test.rst<span class="w"> </span>tests/pyweb_test.html
</pre></div>
</div>
</section>
<section id="dependencies">
<h3><a class="toc-backref" href="#id20" role="doc-backlink">Dependencies</a><a class="headerlink" href="#dependencies" title="Link to this heading">¶</a></h3>
<p><strong>py-web-lp</strong> requires Python 3.12 or newer.</p>
<p>Dependencies are summarized in the <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code>.</p>
<p>This does not <strong>format</strong> the output.</p>
<p>If you create RST output, you’ll want to use either <a class="reference external" href="https://docutils.sourceforge.io">docutils</a> or <a class="reference external" href="https://www.sphinx-doc.org/en/master/">Sphinx</a> to translate the RST to HTML or LaTeX or any of the other formats available.</p>
<p>This overview documentation contains PlantUML diagrams.
See <a class="reference external" href="https://plantuml.com/">https://plantuml.com/</a> for more information.</p>
</section>
</section>
<section id="more-advanced-usage">
<h2><a class="toc-backref" href="#id21" role="doc-backlink">More Advanced Usage</a><a class="headerlink" href="#more-advanced-usage" title="Link to this heading">¶</a></h2>
<p>Here are two more advanced use cases that help define the role for this tool.</p>
<section id="tangle-test-and-weave-with-test-results">
<h3><a class="toc-backref" href="#id22" role="doc-backlink">Tangle, Test, and Weave with Test Results</a><a class="headerlink" href="#tangle-test-and-weave-with-test-results" title="Link to this heading">¶</a></h3>
<p>A user initiates this process when the final document should include test output  from the source files created by the tangle operation.
This is an extension to  the example shown earlier.</p>
<pre class="literal-block">###########
Hello World
###########

This file has a <em>small</em> example.

&#64;d The Body Of The Script &#64;{
print(&quot;Hello, World!&quot;)
&#64;}

The Python module includes a small script.

&#64;o hw.py &#64;{
&#64;&lt;The Body...&#64;&gt;
&#64;}

Example Output
==============

&#64;i examples/hw_output.log</pre>
<p>The use case is successful when the documentation file is produced, including current test output.</p>
<p>The use case is a failure when the documentation file cannot be produced, due to
errors in the <code class="docutils literal notranslate"><span class="pre">.w</span></code> file.
The log will detail the problems preventing processing.</p>
<p>The use case can also be a failure when the documentation file does not include correct test output.</p>
<p>The sequence is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">pyweb</span> <span class="o">-</span><span class="n">xw</span> <span class="o">-</span><span class="n">pi</span> <span class="n">examples</span><span class="o">/</span><span class="n">hw</span><span class="o">.</span><span class="n">w</span> <span class="o">-</span><span class="n">o</span> <span class="n">examples</span>
<span class="n">python</span> <span class="n">examples</span><span class="o">/</span><span class="n">hw</span><span class="o">.</span><span class="n">py</span> <span class="o">&gt;</span><span class="n">examples</span><span class="o">/</span><span class="n">hw_output</span><span class="o">.</span><span class="n">log</span>
<span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">pyweb</span> <span class="o">-</span><span class="n">xt</span> <span class="n">examples</span><span class="o">/</span><span class="n">hw</span><span class="o">.</span><span class="n">w</span> <span class="o">-</span><span class="n">o</span> <span class="n">examples</span>
</pre></div>
</div>
<p>The first step uses <code class="docutils literal notranslate"><span class="pre">-xw</span></code> to excludes document weaving.
The <code class="docutils literal notranslate"><span class="pre">-pi</span></code> option will permits errors on the <code class="docutils literal notranslate"><span class="pre">&#64;i</span></code> command.
This is necessary in the event that the log file does not yet exist.</p>
<p>The second step runs the test, creating a log file.</p>
<p>The third step weaves the final document, including the test output file.
The <code class="docutils literal notranslate"><span class="pre">-xt</span></code> option excludes tangling, since output file had already been produced.</p>
</section>
<section id="template-changes">
<h3><a class="toc-backref" href="#id23" role="doc-backlink">Template Changes</a><a class="headerlink" href="#template-changes" title="Link to this heading">¶</a></h3>
<p>The woven document is based – primarily – on the text in the source WEB file.
This is processed using a small set of Jinja2 macros to modify behavior.
To fine-tune the results, we can adjust the templates used by this application.</p>
<p>One way to do this is to work with the <code class="docutils literal notranslate"><span class="pre">weave.py</span></code> script which shows how to create a customized subclass of <code class="docutils literal notranslate"><span class="pre">Weaver</span></code>.
The <a class="reference internal" href="#handy-scripts">Handy Scripts</a> section shows this script and how to build it from a few <code class="docutils literal notranslate"><span class="pre">pyweb</span></code> components.</p>
<p>A future extension will allow defining macros in the WEB document, or in the <code class="docutils literal notranslate"><span class="pre">pyweb.toml</span></code> configuration file.</p>
</section>
</section>
<section id="the-py-web-lp-markup-language">
<h2><a class="toc-backref" href="#id24" role="doc-backlink">The <strong>py-web-lp</strong> Markup Language</a><a class="headerlink" href="#the-py-web-lp-markup-language" title="Link to this heading">¶</a></h2>
<p>The essence of literate programming is a markup language that includes both code as well as documentation.
For tangling, the code is relevant.
For weaving, both code and documentation are relevant.</p>
<p>The source document is a “Web” document that includes the code.
It’s important to understand the <code class="docutils literal notranslate"><span class="pre">.w</span></code> file as the only source for code and documentation.
The code is tangled out  of the source web file.</p>
<p>The <strong>py-web-lp</strong> tool parses the <code class="docutils literal notranslate"><span class="pre">.w</span></code> file, and performs the tangle and weave operations.
It <em>tangles</em> each individual output file from the program source chunks.
It <em>weaves</em> the final documentation file file from the entire sequence of chunks provided, mixing the author’s  original documentation with some markup around the embedded program source.</p>
<section id="concepts">
<h3><a class="toc-backref" href="#id25" role="doc-backlink">Concepts</a><a class="headerlink" href="#concepts" title="Link to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">.w</span></code> file has two tiers of markup in it.</p>
<ul class="simple">
<li><p>At the top, a file will have <strong>py-web-lp</strong> markup to distinguish
documentation chunks from code chunks.</p></li>
<li><p>Within the documentation chunks, there can be markup for the target publication tool chain.
This might be RST, LaTeX, HTML, or some other markup language.</p></li>
</ul>
<p>The <strong>py-web-lp</strong> markup decomposes the source document a sequence of <em>Chunks</em>.</p>
<p class="plantuml">
<img src="_images/plantuml-0bff076f813d017a60bee35cd131d50c7c41d245.png" alt="object web
object chunk
object documentation
object &quot;source code&quot; as code

web *-- chunk
chunk *-- documentation
chunk *-- code"/>
</p>
<p>The chunks have the following two overall sets of features:</p>
<ul>
<li><p>Program source code to be <em>tangled</em> and <em>woven</em>. There are two important varieties:</p>
<ul class="simple">
<li><p>“defined” chunks that have names,</p></li>
<li><p>“output” chunks that lead to writing a tangled file.</p></li>
</ul>
<p>Output chunks can have references to defined code chunks defined anywhere else in the web file.
This permits tangling output files in a compiler-friendly order, separate from a sensible presentation order.</p>
</li>
<li><p>Documentation to be <em>woven</em>.  These are the blocks of text between commands.</p></li>
</ul>
<p>The bulk of the file is typically documentation chunks that describe the program in
some publication-oriented markup language like RST, HTML, or LaTeX.</p>
<p>All code chunks have two transformations applied:</p>
<ul class="simple">
<li><p>When Tangling, the indentation is adjusted to match the context in which they were originally defined.
This assures that Python (which relies on indentation) parses correctly.
For other languages, proper indentation is expected but not required.</p></li>
<li><p>When Weaving, selected characters can be quoted so they don’t break the publication tool.
For HTML, <code class="docutils literal notranslate"><span class="pre">&amp;</span></code>, <code class="docutils literal notranslate"><span class="pre">&lt;</span></code>, <code class="docutils literal notranslate"><span class="pre">&gt;</span></code> are quoted properly.
For LaTeX, a few escapes are used to avoid problems with the <code class="docutils literal notranslate"><span class="pre">fancyvrb</span></code> environment.</p></li>
</ul>
<p>The non-code documentation chunks are not transformed up in any way.
Everything that’s not explicitly a code chunk is output without modification.</p>
<p>All of the <strong>py-web-lp</strong> tags begin with <code class="docutils literal notranslate"><span class="pre">&#64;</span></code>.
This is sometimes called the command prefix.
(This can be changed.)
The tags were historically referred to as “commands.”
For Python code using decorators, the symbol must be doubled, <code class="docutils literal notranslate"><span class="pre">&#64;&#64;</span></code>, because all <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> symbols are commands, irrespective of context.</p>
<p>The <em>Structural</em> tags (historically called “major commands”) partition the input and define the various chunks.
The <em>Inline</em> tags are (called “minor commands”) are used to control the woven and tangled output from the defined chunks.
There are <em>Content</em> tags which generate  summary cross-reference content in woven files.</p>
</section>
<section id="boilerplate">
<h3><a class="toc-backref" href="#id26" role="doc-backlink">Boilerplate</a><a class="headerlink" href="#boilerplate" title="Link to this heading">¶</a></h3>
<p>There is some mandatory “boilerplate” required to make a working document.
Requirements vary by markup language.</p>
<section id="latex">
<h4><a class="toc-backref" href="#id27" role="doc-backlink">LaTeX</a><a class="headerlink" href="#latex" title="Link to this heading">¶</a></h4>
<p>The LaTeX templates use <code class="docutils literal notranslate"><span class="pre">\\fancyvrb</span></code>.
The following is required.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>\\<span class="n">usepackage</span><span class="p">{</span><span class="n">fancyvrb</span><span class="p">}</span>
</pre></div>
</div>
<p>Some minimal boilerplate document looks like this:</p>
<pre class="literal-block">\documentclass{article}
\usepackage{fancyvrb}
\title{ <em>Title</em> }
\author{ <em>Author</em> }

\begin{document}

\maketitle
\tableofcontents

<em>Your Document Starts Here</em>

\end{document}</pre>
</section>
<section id="html">
<h4><a class="toc-backref" href="#id28" role="doc-backlink">HTML</a><a class="headerlink" href="#html" title="Link to this heading">¶</a></h4>
<p>There’s often a fairly large amount of HTML boilerplate.
Currently, the templates used do <strong>not</strong> provide any CSS classes.
For more sophisticated HTML documents, it may be necessary to
provide customized templates with CSS classes to make the
document look good.</p>
</section>
</section>
<section id="structural-tags">
<h3><a class="toc-backref" href="#id29" role="doc-backlink">Structural Tags</a><a class="headerlink" href="#structural-tags" title="Link to this heading">¶</a></h3>
<p>There are two definitional tags; these define the various chunks
in an input file.</p>
<p><code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> <em>file</em> <code class="docutils literal notranslate"><span class="pre">&#64;{</span></code> <em>text</em> <code class="docutils literal notranslate"><span class="pre">&#64;}</span></code></p>
<blockquote>
<div><p>The <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> (output) command defines a named output file chunk.
The text is tangled to the named
file with no alteration.  It is woven into the document
in an appropriate fixed-width font.</p>
<p>There are options available to specify comment conventions
for the tangled output; this allows inclusion of source
line numbers.</p>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> <em>options</em> <em>name</em> <code class="docutils literal notranslate"><span class="pre">&#64;{</span></code> <em>text</em> <code class="docutils literal notranslate"><span class="pre">&#64;}</span></code></p>
<blockquote>
<div><p>The <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> (define) command defines a named chunk of program source.
This text is tangled or woven when it is referenced by the <em>reference</em> inline tag.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">-indent</span></code> and <code class="docutils literal notranslate"><span class="pre">-noindent</span></code> options specify the indentation for this particular chunk.
In rare cases, it can be helpful to override the indentation context.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">-style</span> <span class="pre">*name*</span></code> option specifies a parameter that’s provided to the <code class="docutils literal notranslate"><span class="pre">begin_code()</span></code> and <code class="docutils literal notranslate"><span class="pre">end_code()</span></code> macro.
This permits a macro to fine-tune the presentation for a specific chunk.
This can help when writing LaTeX that has a mixture of example block styles.</p>
<p>A special case extension uses <code class="docutils literal notranslate"><span class="pre">&#64;[</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;]</span></code> to bracket text instead of program source. A <em>reference</em> tag can expand this somewhere else in the text.
It’s not clear what the use case for this is.</p>
</div></blockquote>
<p>Each <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> tag is followed by a chunk which is delimited by <code class="docutils literal notranslate"><span class="pre">&#64;{</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;}</span></code> tags.
At the end of that chunk, there is an optional “major” tag.</p>
<p><code class="docutils literal notranslate"><span class="pre">&#64;|</span></code></p>
<blockquote>
<div><p>A chunk may define user identifiers.
The list of defined identifiers is placed in the chunk, separated by the <code class="docutils literal notranslate"><span class="pre">&#64;|</span></code> separator.
This is used to create the index material.</p>
</div></blockquote>
<p>Additionally, these tags provide for the inclusion of additional input files.
This is necessary for decomposing a long document into easy-to-edit sections.</p>
<p><code class="docutils literal notranslate"><span class="pre">&#64;i</span></code> <em>file</em></p>
<blockquote>
<div><p>The <code class="docutils literal notranslate"><span class="pre">&#64;i</span></code> (include) command includes another file.  The previous chunk
is ended.  The file is processed completely, then a new chunk
is started for the text after the <code class="docutils literal notranslate"><span class="pre">&#64;i</span></code> command.</p>
</div></blockquote>
<p>All material that is not explicitly in a <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> or <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> named chunk is implicitly collected into a sequence of anonymous document source chunks.
These anonymous chunks form the backbone of the document that is woven.
The anonymous chunks are never tangled into output program source files.
They are woven into the document without any alteration.</p>
<p>Note that white space (line breaks (<code class="docutils literal notranslate"><span class="pre">'\n'</span></code>), tabs and spaces) have no effect on the input parsing.
They are completely preserved on output.</p>
<p>The following example has three chunks:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Some</span> <span class="n">RST</span><span class="o">-</span><span class="nb">format</span> <span class="n">documentation</span> <span class="n">that</span> <span class="n">describes</span> <span class="n">the</span> <span class="n">following</span> <span class="n">piece</span> <span class="n">of</span> <span class="n">the</span>
<span class="n">program</span><span class="o">.</span>

<span class="nd">@o</span> <span class="n">myFile</span><span class="o">.</span><span class="n">py</span>
<span class="o">@</span><span class="p">{</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="nb">print</span><span class="p">(</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="p">)</span>
<span class="o">@|</span> <span class="n">math</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span>
<span class="o">@</span><span class="p">}</span>

<span class="n">Some</span> <span class="n">more</span> <span class="n">RST</span> <span class="n">documentation</span><span class="o">.</span>
</pre></div>
</div>
<p>This starts with an anonymous chunk of documentation.
It includes a named output chunk which will write to <code class="docutils literal notranslate"><span class="pre">myFile.py</span></code>.
It ends with an anonymous chunk of documentation.</p>
</section>
<section id="inline-tags">
<h3><a class="toc-backref" href="#id30" role="doc-backlink">Inline Tags</a><a class="headerlink" href="#inline-tags" title="Link to this heading">¶</a></h3>
<p>There are several tags that are replaced by content in the woven output.</p>
<p><code class="docutils literal notranslate"><span class="pre">&#64;&#64;</span></code></p>
<blockquote>
<div><p>The <code class="docutils literal notranslate"><span class="pre">&#64;&#64;</span></code> command creates a single <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> in the output file.
This is replaced in tangled as well as woven output.</p>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">&#64;&lt;</span></code><em>name</em><code class="docutils literal notranslate"><span class="pre">&#64;&gt;</span></code></p>
<blockquote>
<div><p>The <em>name</em> references a named chunk.
When tangling, the referenced chunk replaces the reference tag.
When weaving, a reference marker is used.
For example, in RST, this can be replaced with RST <code class="docutils literal notranslate"><span class="pre">`reference`_</span></code> markup.
Note that the indentation prior to the <code class="docutils literal notranslate"><span class="pre">&#64;&lt;</span></code> tag is preserved for the tangled chunk that replaces the tag.</p>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">&#64;(</span></code><em>Python expression</em><code class="docutils literal notranslate"><span class="pre">&#64;)</span></code></p>
<blockquote>
<div><p>The <em>Python expression</em> is evaluated and the result is tangled or woven in place.
A few global variables and modules are available.
These are described in <a class="reference internal" href="#expression-context">Expression Context</a>.</p>
</div></blockquote>
</section>
<section id="content-tags">
<h3><a class="toc-backref" href="#id31" role="doc-backlink">Content Tags</a><a class="headerlink" href="#content-tags" title="Link to this heading">¶</a></h3>
<p>There are three index creation tags that are replaced by content in the woven output.</p>
<p><code class="docutils literal notranslate"><span class="pre">&#64;f</span></code></p>
<blockquote>
<div><p>The <code class="docutils literal notranslate"><span class="pre">&#64;f</span></code> command inserts a file cross reference.
This lists the name of each file created by an <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> command, and all of the various chunks that are concatenated to create this file.</p>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">&#64;m</span></code></p>
<blockquote>
<div><p>The <code class="docutils literal notranslate"><span class="pre">&#64;m</span></code> command inserts a named chunk (“macro”) cross reference.
This lists the name of each chunk created by a <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> command, and all of the various chunks that are concatenated to create the complete chunk.</p>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">&#64;u</span></code></p>
<blockquote>
<div><p>The <code class="docutils literal notranslate"><span class="pre">&#64;u</span></code> command inserts a user identifier cross reference.
This index lists the name of each chunk created by an <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> command or <code class="docutils literal notranslate"><span class="pre">&#64;|</span></code>,
and all of the various chunks that are concatenated to create the complete chunk.</p>
</div></blockquote>
</section>
<section id="additional-features">
<h3><a class="toc-backref" href="#id32" role="doc-backlink">Additional Features</a><a class="headerlink" href="#additional-features" title="Link to this heading">¶</a></h3>
<p><strong>Sequence Numbers</strong>. The named chunks (from both <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> commands) are assigned
unique sequence numbers to simplify cross references.</p>
<p><strong>Case Sensitive</strong>. Chunk names and file names are case sensitive.</p>
<p><strong>Abbreviations</strong>. Chunk names can be abbreviated.
A partial name can have a trailing ellipsis (<code class="docutils literal notranslate"><span class="pre">...</span></code>), this will be resolved to the full name.
The most typical use for this is shown in the following example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Some</span> <span class="n">RST</span><span class="o">-</span><span class="nb">format</span> <span class="n">documentation</span><span class="o">.</span>

<span class="nd">@o</span> <span class="n">myFile</span><span class="o">.</span><span class="n">py</span>
<span class="o">@</span><span class="p">{</span>
<span class="o">@&lt;</span><span class="n">imports</span> <span class="n">of</span> <span class="n">the</span> <span class="n">various</span> <span class="n">packages</span> <span class="n">used</span><span class="o">@&gt;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
<span class="o">@</span><span class="p">}</span>

<span class="n">Some</span> <span class="n">notes</span> <span class="n">on</span> <span class="n">the</span> <span class="n">packages</span> <span class="n">used</span><span class="o">.</span>

<span class="nd">@d</span> <span class="n">imports</span><span class="o">...</span>
<span class="o">@</span><span class="p">{</span>
<span class="kn">import</span> <span class="nn">math</span><span class="o">,</span><span class="nn">time</span>
<span class="o">@|</span> <span class="n">math</span> <span class="n">time</span>
<span class="o">@</span><span class="p">}</span>

<span class="n">Some</span> <span class="n">more</span> <span class="n">RST</span><span class="o">-</span><span class="nb">format</span> <span class="n">documentation</span><span class="o">.</span>
</pre></div>
</div>
<p>This example shows five chunks.</p>
<ol class="arabic simple">
<li><p>An anonymous chunk of documentation.</p></li>
<li><p>A named chunk that tangles the <code class="docutils literal notranslate"><span class="pre">myFile.py</span></code> output.
It has a reference to the <code class="docutils literal notranslate"><span class="pre">imports</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">various</span> <span class="pre">packages</span> <span class="pre">used</span></code> chunk.
Note that the full name of the chunk is essentially a line of  documentation,
traditionally done as a comment line in a non-literate programming environment.</p></li>
<li><p>An anonymous chunk of documentation.</p></li>
<li><p>A named chunk with an abbreviated name.
The <code class="docutils literal notranslate"><span class="pre">imports...</span></code> reference matches the defined name <code class="docutils literal notranslate"><span class="pre">imports</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">various</span> <span class="pre">packages</span> <span class="pre">used</span></code>.
Set off after the <code class="docutils literal notranslate"><span class="pre">&#64;|</span></code> separator is the list of user-specified identifiers defined in this chunk.</p></li>
<li><p>An anonymous chunk of documentation.</p></li>
</ol>
<p>Note that the first time a name appears (in a reference or definition), it <strong>must</strong> be the full name.
All subsequent uses can be elisions.
Also not that ambiguous elision is an annoying problem when you first start creating a document.</p>
<p><strong>Concatenation</strong>. Named chunks are concatenated from their various pieces.
This allows a named chunk to be broken into several pieces, simplifying the description.
This is most often used when producing  fairly complex output files.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">An</span> <span class="n">anonymous</span> <span class="n">chunk</span> <span class="k">with</span> <span class="n">some</span> <span class="n">RST</span> <span class="n">documentation</span><span class="o">.</span>

<span class="nd">@o</span> <span class="n">myFile</span><span class="o">.</span><span class="n">py</span>
<span class="o">@</span><span class="p">{</span>
<span class="kn">import</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">time</span>
<span class="o">@</span><span class="p">}</span>

<span class="n">Some</span> <span class="n">notes</span> <span class="n">on</span> <span class="n">the</span> <span class="n">packages</span> <span class="n">used</span><span class="o">.</span>

<span class="nd">@o</span> <span class="n">myFile</span><span class="o">.</span><span class="n">py</span>
<span class="o">@</span><span class="p">{</span>
<span class="nb">print</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
<span class="o">@</span><span class="p">}</span>

<span class="n">Some</span> <span class="n">more</span> <span class="n">HTML</span> <span class="n">documentation</span><span class="o">.</span>
</pre></div>
</div>
<p>This example shows five chunks.</p>
<ol class="arabic simple">
<li><p>An anonymous chunk of documentation.</p></li>
<li><p>A named chunk that tangles the <code class="docutils literal notranslate"><span class="pre">myFile.py</span></code> output.  It has
the first part of the file.  In the woven document
this is marked with <code class="docutils literal notranslate"><span class="pre">&quot;=&quot;</span></code>.</p></li>
<li><p>An anonymous chunk of documentation.</p></li>
<li><p>A named chunk that also tangles the <code class="docutils literal notranslate"><span class="pre">myFile.py</span></code> output. This
chunk’s content is appended to the first chunk.  In the woven document
this is marked with <code class="docutils literal notranslate"><span class="pre">&quot;+=&quot;</span></code>.</p></li>
<li><p>An anonymous chunk of documentation.</p></li>
</ol>
<p><strong>Newline Preservation</strong>. Newline characters are preserved on input.
Because of this the output may appear to have excessive newlines.
In all of the above examples, each named chunk was defined with the following.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">@</span><span class="p">{</span>
<span class="kn">import</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">time</span>
<span class="o">@</span><span class="p">}</span>
</pre></div>
</div>
<p>This puts a newline character before and after the import line.</p>
</section>
<section id="controlling-indentation">
<h3><a class="toc-backref" href="#id33" role="doc-backlink">Controlling Indentation</a><a class="headerlink" href="#controlling-indentation" title="Link to this heading">¶</a></h3>
<p>We have two choices in indentation:</p>
<ul class="simple">
<li><p>Context-Sensitive.</p></li>
<li><p>Consistent.</p></li>
</ul>
<p>If we have context-sensitive indentation, then the indentation of a chunk reference  is applied to the entire chunk when expanded in place of the reference.
This makes it simpler to prepare source for languages (like Python) where indentation is important.</p>
<p>There are cases, however, when this is not desirable.
There are some places in Python where we want to create long, triple-quoted strings with indentation that does not follow the prevailing indentations of the surrounding code.</p>
<p>Here’s how the context-sensitive indentation works.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@o</span> <span class="n">myFile</span><span class="o">.</span><span class="n">py</span>
<span class="o">@</span><span class="p">{</span>
<span class="k">def</span> <span class="nf">aFunction</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="o">@&lt;</span><span class="n">body</span> <span class="n">of</span> <span class="n">aFunction</span><span class="o">@&gt;</span>
<span class="o">@|</span> <span class="n">aFunction</span> <span class="o">@</span><span class="p">}</span>

<span class="nd">@d</span> <span class="n">body</span><span class="o">...</span>
<span class="o">@</span><span class="p">{</span>
<span class="sd">&quot;&quot;&quot;doc string&quot;&quot;&quot;</span>
<span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
<span class="o">@</span><span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">&#64;&lt;body</span> <span class="pre">of</span> <span class="pre">aFunction&#64;&gt;</span></code> command is indented.
The tangled output from this will look like the following.
All of the newline characters are preserved, and the reference to <em>body of the aFunction</em> is indented to match the prevailing indent where it was referenced.
In the following example,  explicit line markers of <code class="docutils literal notranslate"><span class="pre">~</span></code> are provided to make the blank lines  more obvious.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">~</span>
<span class="o">~</span><span class="k">def</span> <span class="nf">aFunction</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="o">~</span>
<span class="o">~</span>    <span class="s2">&quot;&quot;&quot;doc string&quot;&quot;&quot;</span>
<span class="o">~</span>    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
<span class="o">~</span>
</pre></div>
</div>
<p>[The <code class="docutils literal notranslate"><span class="pre">&#64;|</span></code> command shows that this chunk defines the identifier <code class="docutils literal notranslate"><span class="pre">aFunction</span></code>.]</p>
<p>This leads to the use of “options” for some commands.
This seems to go against the utter simplicity we’re cribbing from <strong>noweb</strong>.</p>
<p>The syntax to define a section the will not the indentation context applied looks like this:</p>
<pre class="literal-block">&#64;d -noindent some chunk name
&#64;{<em>First partial line</em>
<em>More that uses &quot;&quot;&quot;</em>
&#64;}</pre>
<p>We might reference such a section like this.</p>
<pre class="literal-block">&#64;d some bigger chunk...
&#64;{<em>code</em>
    &#64;&lt;some chunk name&#64;&gt;
&#64;}</pre>
<p>The <code class="docutils literal notranslate"><span class="pre">-noindent</span></code> section will be included by resetting the contextual indentation to zero.
The <em>First partial line</em> line will be output after the four spaces
provided by the <code class="docutils literal notranslate"><span class="pre">some</span> <span class="pre">bigger</span> <span class="pre">chunk</span></code> context.</p>
<p>After the first newline, the remaining lines will be at the left margin.</p>
</section>
<section id="tracking-source-line-numbers">
<h3><a class="toc-backref" href="#id34" role="doc-backlink">Tracking Source Line Numbers</a><a class="headerlink" href="#tracking-source-line-numbers" title="Link to this heading">¶</a></h3>
<p>Since the tangled output files are – well – tangled, it can be difficult to
trace back from a Python error stack to the original line in the <code class="docutils literal notranslate"><span class="pre">.w</span></code> file that
needs to be fixed.
To facilitate this, there is a two-step operation to get more detailed information
on how tangling worked.</p>
<ol class="arabic simple">
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">-n</span></code> command-line option to include line numbers in the tangled output.</p></li>
<li><p>Include comment indicators on the <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> commands to show what comment syntax is used.</p></li>
</ol>
<p>The expanded syntax for <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> looks like this.</p>
<pre class="literal-block">&#64;o -start /* -end */ page-layout.css
&#64;{
<em>Some CSS code</em>
&#64;}</pre>
<p>We’ve added two options: <code class="docutils literal notranslate"><span class="pre">-start</span> <span class="pre">/*</span></code> and <code class="docutils literal notranslate"><span class="pre">-end</span> <span class="pre">*/</span></code> to define comment start and end syntax.
This will lead to comments embedded in the tangled output to show source line numbers for every (every!) chunk.</p>
</section>
<section id="expression-context">
<h3><a class="toc-backref" href="#id35" role="doc-backlink">Expression Context</a><a class="headerlink" href="#expression-context" title="Link to this heading">¶</a></h3>
<p>Expressions are evaluated as they are encountered during input parsing.
They produce a <code class="docutils literal notranslate"><span class="pre">TextCommand</span></code> in the current <code class="docutils literal notranslate"><span class="pre">Chunk</span></code>.
This means a limited context is available for the Python expression.</p>
<p>The context has the following variables defined.</p>
<dl class="field-list simple">
<dt class="field-odd">os.path<span class="colon">:</span></dt>
<dd class="field-odd"><p>This is the standard <code class="docutils literal notranslate"><span class="pre">os.path</span></code> module.</p>
</dd>
<dt class="field-even">os.getcwd<span class="colon">:</span></dt>
<dd class="field-even"><p>The complete <code class="docutils literal notranslate"><span class="pre">os</span></code> module is not available. Just this function.</p>
</dd>
<dt class="field-odd">datetime<span class="colon">:</span></dt>
<dd class="field-odd"><p>This is the standard <code class="docutils literal notranslate"><span class="pre">datetime</span></code> module.</p>
</dd>
<dt class="field-even">time<span class="colon">:</span></dt>
<dd class="field-even"><p>The standard <code class="docutils literal notranslate"><span class="pre">time</span></code> module.</p>
</dd>
<dt class="field-odd">platform<span class="colon">:</span></dt>
<dd class="field-odd"><p>This is the standard <code class="docutils literal notranslate"><span class="pre">platform</span></code> module.</p>
</dd>
<dt class="field-even">__builtins__<span class="colon">:</span></dt>
<dd class="field-even"><p>Most of the built-ins are available, too. Not all.
<code class="docutils literal notranslate"><span class="pre">exec()</span></code>, <code class="docutils literal notranslate"><span class="pre">eval()</span></code>, <code class="docutils literal notranslate"><span class="pre">open()</span></code> and <code class="docutils literal notranslate"><span class="pre">__import__()</span></code> aren’t available.</p>
</dd>
<dt class="field-odd">theLocation<span class="colon">:</span></dt>
<dd class="field-odd"><p>A tuple with the file name, first line number and last line number
for the original expression’s location.</p>
</dd>
<dt class="field-even">theWebReader<span class="colon">:</span></dt>
<dd class="field-even"><p>The <code class="docutils literal notranslate"><span class="pre">WebReader</span></code> instance doing the parsing.</p>
</dd>
<dt class="field-odd">theFile<span class="colon">:</span></dt>
<dd class="field-odd"><p>The <code class="docutils literal notranslate"><span class="pre">.w</span></code> file being processed.</p>
</dd>
<dt class="field-even">thisApplication<span class="colon">:</span></dt>
<dd class="field-even"><p>The name of the running <strong>py-web-lp</strong> application. It may not be pyweb.py,
if some other script is being used.</p>
</dd>
<dt class="field-odd">__version__<span class="colon">:</span></dt>
<dd class="field-odd"><p>The version string in the <strong>py-web-lp</strong> application.</p>
</dd>
</dl>
</section>
</section>
<section id="architecture-and-design-overview">
<h2><a class="toc-backref" href="#id36" role="doc-backlink">Architecture and Design Overview</a><a class="headerlink" href="#architecture-and-design-overview" title="Link to this heading">¶</a></h2>
<p>This application breaks the overall problem of literate programming into the following sub-problems:</p>
<ol class="arabic simple">
<li><p>Representation of the WEB document as Chunks and Commands</p></li>
<li><p>Reading and parsing the input WEB document.</p></li>
<li><p>Weaving a document file.</p></li>
<li><p>Tangling the desired program source files.</p></li>
</ol>
<p>Here’s the overall Context Diagram for this application:</p>
<p class="plantuml">
<img src="_images/plantuml-4c8ed7c9fa80955420fb7e1d1a646a6dca37f7fd.png" alt="left to right direction
skinparam actorStyle awesome

actor &quot;Developer&quot; as Dev
rectangle PyWeb {
    usecase &quot;Tangle Source&quot; as UC_Tangle
    usecase &quot;Weave Document&quot; as UC_Weave
}
rectangle IDE {
    usecase &quot;Create WEB&quot; as UC_Create
    usecase &quot;Run Tests&quot; as UC_Test
    usecase &quot;Build Documentation&quot; as UC_Doc
    usecase &quot;Build Application&quot; as UC_App
}
database WEB
component App
folder Documentation

Dev --&gt; UC_Create
Dev --&gt; UC_Test
Dev --&gt; UC_Doc
Dev --&gt; UC_App

UC_Create --&gt; WEB
WEB --&gt; UC_Tangle
WEB --&gt; UC_Weave

UC_Tangle --&gt; App
UC_Weave --&gt; Documentation

UC_Test ..&gt; UC_Tangle
UC_Doc ..&gt; UC_Weave
UC_App ..&gt; UC_Tangle"/>
</p>
<p>The idea here is a central WEB document contains both the application source code and the documentation that describes the code.
The documentation can present information in an order that’s meaningful and helpful
to people.
The tangling operation orders information for the benefit of compilers and tools.</p>
<p>Since this is often part of an Integrated Development Environment (IDE), the container for all of these software components is the developer’s desktop.
(We don’t need a diagram for that.)</p>
<p>Here’s a summary of the application-level components.
These are the most visible libraries and command-line applications:</p>
<p class="plantuml">
<img src="_images/plantuml-9c211de7ab70c13e3003fe0a3f4287c4870ae68b.png" alt="component pyweb
package jinja
pyweb ..&gt; jinja

package templates
pyweb *-- templates
jinja ..&gt; templates

component weave
weave ..&gt; pyweb

component tangle
tangle ..&gt; pyweb"/>
</p>
<p>The <code class="docutils literal notranslate"><span class="pre">weave</span></code> and <code class="docutils literal notranslate"><span class="pre">tangle</span></code> are convenient scripts that import and customize the underlying <code class="docutils literal notranslate"><span class="pre">pyweb</span></code> application.
We’ve used the dotted “depends-on” arrow to depict this.
The <code class="docutils literal notranslate"><span class="pre">pyweb</span></code> application depends on Jinja2 to define the various templates for weaving the output documents.
The <code class="docutils literal notranslate"><span class="pre">pyweb</span></code> application contains the templates; this is shown with a solid line.</p>
<p>We can modify the templates to alter the look and feel.
The  supplied <code class="docutils literal notranslate"><span class="pre">weave.py</span></code> script shows how to do this.</p>
<p>In many cases, the final production will multiple steps,  as shown below:</p>
<p class="plantuml">
<img src="_images/plantuml-de8f7453a793112cdb80266d3c7b23a65cbbf218.png" alt="database WEB
component pyweb
artifact &quot;.rst File&quot; as RST
component sphinx
artifact &quot;.html File&quot; as HTML

WEB --&gt; pyweb
pyweb --&gt; RST
RST --&gt; sphinx
sphinx --&gt; HTML"/>
</p>
<p>We can use <strong>pyweb-lp</strong> to create an <code class="docutils literal notranslate"><span class="pre">.rst</span></code> file with the documentation.
This is then processed by Sphinx to inject a Sphinx theme and necessary CSS to make
responsive web document(s).</p>
<p>This is often automated with a <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>.</p>
<section id="overall-structure">
<h3><a class="toc-backref" href="#id37" role="doc-backlink">Overall Structure</a><a class="headerlink" href="#overall-structure" title="Link to this heading">¶</a></h3>
<p>Generally, the code breaks into three functional areas</p>
<ul class="simple">
<li><p>The core representation of a WEB.</p></li>
<li><p>A parser to read the source WEB.</p></li>
<li><p>The emitters to produce woven and tangled output. This includes both weavers and tanglers.</p></li>
</ul>
<p>We could depict it as follows:</p>
<p class="plantuml">
<img src="_images/plantuml-bfb4d2a68a2eaa4252def69a662d98e73fdece3e.png" alt="folder core {
    class Web
    class Chunk
    abstract class Command
    Web *-- &quot;1..*&quot; Chunk
    Chunk *-- &quot;1..*&quot; Command
}
folder parser {
    class WebReader
    WebReader --&gt; Web
}
folder emitters {
    abstract class Emitter
    class Tangler
    class Weaver
    Emitter &lt;|-- Tangler
    Emitter &lt;|-- Weaver
    Emitter --&gt; Web
}"/>
</p>
<p>We’ll look at the core model, first.</p>
</section>
<section id="core-web-representation">
<h3><a class="toc-backref" href="#id38" role="doc-backlink">Core WEB Representation</a><a class="headerlink" href="#core-web-representation" title="Link to this heading">¶</a></h3>
<p>The basic structure has three layers, as shown in the following diagram:</p>
<p class="plantuml">
<img src="_images/plantuml-af6c5e3c3b745092f6451b2df5c1ecb6ef57c635.png" alt="class Web &lt;&lt; dataclass &gt;&gt; {
    chunks: list[Chunk]
}
class Chunk {
    name: str
    commands: list[Command]
}
abstract class Command

Web *-- &quot;1..*&quot; Chunk
Chunk *-- &quot;1..*&quot; Command

class CodeChunk
Chunk &lt;|-- CodeChunk

class NamedChunk
Chunk &lt;|-- NamedChunk

class OutputChunk
Chunk &lt;|-- OutputChunk

class NamedCodeChunk
Chunk &lt;|-- NamedCodeChunk

class TextCommand
Command &lt;|-- TextCommand

class CodeCommand
Command &lt;|-- CodeCommand

class ReferenceCommand
Command &lt;|-- ReferenceCommand

class XRefCommand
Command &lt;|-- XRefCommand

class FileXRefCommand
XRefCommand &lt;|-- FileXRefCommand

class MacroXRefCommand
XRefCommand &lt;|-- MacroXRefCommand

class UseridXRefCommand
XRefCommand &lt;|-- UseridXRefCommand"/>
</p>
<p>The source document is transformed into a <code class="docutils literal notranslate"><span class="pre">Web</span></code>,  which is the overall container.
The source is decomposed into a sequence of <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> instances.
Each <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> is a sequence of <code class="docutils literal notranslate"><span class="pre">Commands</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">Chunk</span></code> objects and <code class="docutils literal notranslate"><span class="pre">Command</span></code> objects cannot be nested, leading to delightful simplification.</p>
<p>The overall <code class="docutils literal notranslate"><span class="pre">Web</span></code> includes both the original sequence of <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> objects as well as an index for the named <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> instances.</p>
<p>Note that a named chunk may be created through a number of <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> commands.
This means that each named <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> may be a sequence of definitions sharing a common name.
They are concatenated in order to permit decomposing a single concept into sequentially described pieces.</p>
<p>The various layers of <code class="docutils literal notranslate"><span class="pre">Web</span></code>, <code class="docutils literal notranslate"><span class="pre">Chunk</span></code>, and <code class="docutils literal notranslate"><span class="pre">Command</span></code> each have attributes designed to be usable by a Jinja template when weaving output.
When tangling, however, the only attribute that matters is the text contained in the <code class="docutils literal notranslate"><span class="pre">&#64;{</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;}</span></code> brackets.
This makes tangling somewhat simpler than weaving.</p>
<p>There is a small interaction between a <code class="docutils literal notranslate"><span class="pre">Tangler</span></code> and each <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> to work out the indentation. based in the context in which a <code class="docutils literal notranslate"><span class="pre">&#64;&lt;</span> <span class="pre">name</span> <span class="pre">&#64;&gt;</span></code> reference occurs.</p>
</section>
<section id="reading-and-parsing">
<h3><a class="toc-backref" href="#id39" role="doc-backlink">Reading and Parsing</a><a class="headerlink" href="#reading-and-parsing" title="Link to this heading">¶</a></h3>
<p class="plantuml">
<img src="_images/plantuml-9709a6999a63105f75b7067a5431c035dec921ba.png" alt="class Web
class WebReader {
    parse(source) : Web
}
WebReader ..&gt; Web
class Tokenizer
WebReader ..&gt; Tokenizer

class OptionParser

class OptionDef

OptionParser *-- OptionDef

WebReader ..&gt; OptionParser"/>
</p>
<p>A solution to the reading and parsing problem depends on a convenient  tool for breaking up the input stream and a representation for the chunks of input  and the sequence of commands.
Input decomposition is done with something we might call the <strong>Splitter</strong> design pattern.</p>
<p>The <strong>Splitter</strong> pattern is widely used in text processing, and has a long legacy
in a variety of languages and libraries.
A <strong>Splitter</strong> decomposes a string into a sequence of strings using some split pattern.
There are many variant implementations.
For example, one variant locates only a single occurence (usually the left-most); this is
commonly implemented as a Find or Search string function.
Another variant locates all occurrences of a specific string or character, and discards the matching string or character.</p>
<p>The variation on <strong>Splitter</strong> in this application creates each element in the resulting sequence as either
(1) an instance of the  split regular expression or
(2) the text between split patterns.</p>
<p>We define our splitting pattern with the regular
expression <code class="docutils literal notranslate"><span class="pre">'&#64;.|\n'</span></code>.  This will split on either of these patterns:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&#64;</span></code> followed by a single character,</p></li>
<li><p>or, a newline.</p></li>
</ul>
<p>For the most part, <code class="docutils literal notranslate"><span class="pre">\n</span></code> is only text, and as almost no special significance.
The exception is the <code class="docutils literal notranslate"><span class="pre">&#64;i</span></code> <em>filename</em> command, which ends at the end of the line, making the <code class="docutils literal notranslate"><span class="pre">\n</span></code> significant syntax in this case.</p>
<p>We could be more specific with the following as a split pattern: <code class="docutils literal notranslate"><span class="pre">'&#64;[doOifmu\|&lt;&gt;(){}\[\]]|\n'</span></code>.
This would silently ignore unknown commands,  merging them in with the surrounding text.
This would leave the <code class="docutils literal notranslate"><span class="pre">'&#64;&#64;'</span></code> sequences  completely alone, allowing us to replace <code class="docutils literal notranslate"><span class="pre">'&#64;&#64;'</span></code> with <code class="docutils literal notranslate"><span class="pre">'&#64;'</span></code> in every text chunk.
It’s not clear this additional level of detail is helpful.</p>
<p>Within the <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> commands, there is a name and options.
These follow the syntax rules for Tcl or the shell.
Optional fields are prefaced with <code class="docutils literal notranslate"><span class="pre">-</span></code>.
All options must come before all positional arguments.
The positional arguments provide the name being defined.
In effect, the name is <code class="docutils literal notranslate"><span class="pre">'</span> <span class="pre">'.join(args.split('</span> <span class="pre">')</span></code>;
this means multiple adjacent spaces in a name will be collapsed to a single space.</p>
</section>
<section id="emitters">
<h3><a class="toc-backref" href="#id40" role="doc-backlink">Emitters</a><a class="headerlink" href="#emitters" title="Link to this heading">¶</a></h3>
<p>There are two possible outputs from this application:</p>
<ul class="simple">
<li><p>A woven document.</p></li>
<li><p>One or more tangled source files.</p></li>
</ul>
<p>The overall structure of the classes is shown in the following diagram.</p>
<p class="plantuml">
<img src="_images/plantuml-a057f978b90f99a509529f42568e557951021d28.png" alt="class Web

abstract class Emitter {
    emit(web)
}

Emitter ..&gt; Web

class Weaver
Emitter &lt;|-- Weaver

class Tangler
Emitter &lt;|-- Tangler

class TanglerMake
Tangler &lt;|-- TanglerMake

abstract class ReferenceStyle
Weaver --&gt; ReferenceStyle

class Simple
ReferenceStyle &lt;|-- Simple

class Transitive
ReferenceStyle &lt;|-- Transitive

class Template
Weaver --&gt; Template

class &quot;Jinja Macro&quot; as macro
Template *-- macro"/>
</p>
<p>We’ll look at the weaving activity first, then the tangling activity.</p>
</section>
<section id="weaving">
<h3><a class="toc-backref" href="#id41" role="doc-backlink">Weaving</a><a class="headerlink" href="#weaving" title="Link to this heading">¶</a></h3>
<p>The weaving activity depends on having a target document markup language.
There are several approaches to this problem.</p>
<ul class="simple">
<li><p>We can use a markup language unique to <strong>py-web-lp</strong>.
This would hide the final target markup language. It would mean
that <strong>py-web-lp</strong> would be equivalent to a tool like <strong>Pandoc</strong>,
producing a variety of target markup languages from a single, common source.</p></li>
<li><p>We can use any of the existing markup languages (HTML, RST, Markdown, LaTeX, etc.)
expand snippets of markup into author-supplied markup to create the
target woven document.</p></li>
</ul>
<p>The problem with the first method is defining yet-another-markup-language.
This seems needlessly complex.</p>
<p>The problem with the second method is the source WEB file is a mixture of the following two things:</p>
<ul class="simple">
<li><p>The background document in some standard markup and</p></li>
<li><p>The code elements, which need to be wrapped in some markup.</p></li>
</ul>
<p>In languages like RST and Markdown, there’s a small textual wrapper around code samples.
In languages like HTML, the wrapper can be much more complex.
Also, certain code characters may need to be properly escaped if the code sample happens to contain markup that should <strong>not</strong> be processed, but treated as literal text.
In LaTeX, the wrapper can be quite complex.</p>
<p>The author should not be foreced to repeat the wrappers around each code examples.
This should be delegated to the literate programming tool.
Further, the author should not be narrowly constrained by the markup injected
by the weaving process; the weaver should be extensible to add features.</p>
<p>Currently, this leads to using the <strong>Facade</strong> design pattern.
The weaver is a <strong>Facade</strong> over the Jinja template engine.
The tool provides default templates in RST, HTML, and LaTeX.
These can be replaced; new templates can be added.
The templates used to wrap code sections can be tweaked relatively easily.</p>
<p>This is – in the long run – unsustainable.
It means some elements of the document are <strong>not</strong> in the <code class="docutils literal notranslate"><span class="pre">.w</span></code> WEB file.
See the <a class="reference internal" href="#todo"><span class="std std-ref">To Do</span></a> section for more on these new commands.</p>
</section>
<section id="tangling">
<h3><a class="toc-backref" href="#id42" role="doc-backlink">Tangling</a><a class="headerlink" href="#tangling" title="Link to this heading">¶</a></h3>
<p>The tangling activity produces output files.
In other Literate Programming tools, some care was taken to understand the source code context for tangling, and
provide a correct indentation.
This required a command-line parameter to turn off indentation for languages like Fortran, where identation is not used.</p>
<p>In <strong>py-web-lp</strong>, there are two options:</p>
<ul class="simple">
<li><p>The default behavior is that the indent of a <code class="docutils literal notranslate"><span class="pre">&#64;&lt;</span> <span class="pre">name</span> <span class="pre">&#64;&gt;</span></code> command is used to set the indent of the  material is expanded in place of this reference.
If all <code class="docutils literal notranslate"><span class="pre">&#64;&lt;</span></code> commands are presented at the left margin, no indentation will be done.
This is helpful simplification, particularly for users of Python, where indentation is significant.</p></li>
<li><p>A flag on a <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> chunk  can override the indentation rule to force the material to be placed at the left margin in spite of the <cite>&#64;&lt;`</cite> command being indented.</p></li>
</ul>
<p>Generally, tangling collects the <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> chunks and referenced <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> chunks into files.
The <code class="docutils literal notranslate"><span class="pre">&#64;&lt;</span></code> references are expanded.
Other than indentation control, no additional transformation is performed.</p>
</section>
<section id="application">
<h3><a class="toc-backref" href="#id43" role="doc-backlink">Application</a><a class="headerlink" href="#application" title="Link to this heading">¶</a></h3>
<p>The overall application has the following layers to it:</p>
<ul class="simple">
<li><p>An <code class="docutils literal notranslate"><span class="pre">Action</span></code> class hierarchy that includes the actions of Load, Tangle, and Weave.</p></li>
<li><p>An overall <code class="docutils literal notranslate"><span class="pre">Application</span></code> class that executes the actions.</p></li>
<li><p>A top-level main function parses the command line, creates and configures the actions, and executes the sequence
of actions.</p></li>
</ul>
<p>The idea is that the Weaver Action should be visible to tools like <a class="reference external" href="https://docs.pyinvoke.org/en/stable/index.html">PyInvoke</a>.
We want <code class="docutils literal notranslate"><span class="pre">Weave(&quot;someFile.w&quot;)</span></code> to be a sensible task.</p>
<p class="plantuml">
<img src="_images/plantuml-ad2b1999b26d857e32915ff7a3e02e112a1944a8.png" alt="abstract class Action

class ActionSequence
Action &lt;|-- ActionSequence
ActionSequence *-- &quot;2..m&quot; Action

class LoadAction
Action &lt;|-- LoadAction

class WeaveAction
Action &lt;|-- WeaveAction

class TangleAction
Action &lt;|-- TangleAction

class Application

Application *-- Action"/>
</p>
<p>This shows the essential structure of the top-level classes.</p>
</section>
</section>
<section id="implementation">
<h2><a class="toc-backref" href="#id44" role="doc-backlink">Implementation</a><a class="headerlink" href="#implementation" title="Link to this heading">¶</a></h2>
<p>The implementation is contained in a single Python module defining the all of the classes and functions, as well as an overall <code class="docutils literal notranslate"><span class="pre">main()</span></code> function.
The <code class="docutils literal notranslate"><span class="pre">main()</span></code> function uses these base classes to weave and tangle the output files.</p>
<p>The broad outline of the presentation is as follows:</p>
<ul>
<li><p><a class="reference internal" href="#base-classes">Base Classes</a> that define a model for the <code class="docutils literal notranslate"><span class="pre">.w</span></code> file.</p>
<ul class="simple">
<li><p><a class="reference internal" href="#web-class">Web Class</a> contains the overall Web of Chunks.
A Web is a sequence of <cite>Chunk</cite> objects.
It’s also a mapping from chunk name to definition.</p></li>
<li><p><a class="reference internal" href="#chunk-class-hierarchy">Chunk Class Hierarchy</a> are pieces of the source document, built into a Web.
A <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> is a collection of <code class="docutils literal notranslate"><span class="pre">Command</span></code> instances.
This can be either an anonymous chunk that will be sent directly to the output,
or a named chunks delimited by the structural <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> or <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> commands.</p></li>
<li><p><a class="reference internal" href="#command-class-hierarchy">Command Class Hierarchy</a> are the items within a <code class="docutils literal notranslate"><span class="pre">Chunk</span></code>.
The text and the inline <code class="docutils literal notranslate"><span class="pre">&#64;&lt;name&#64;&gt;</span></code> references are the principle command classes.
Additionally, there are some cross reference commands (<code class="docutils literal notranslate"><span class="pre">&#64;f</span></code>, <code class="docutils literal notranslate"><span class="pre">&#64;m</span></code>, and <code class="docutils literal notranslate"><span class="pre">&#64;u</span></code>) that generate content.</p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#output-serialization">Output Serialization</a>. The <code class="docutils literal notranslate"><span class="pre">Emitter</span></code> class hierarchy writes various kinds of files.
These decompose into two subclasses:</p>
<blockquote>
<div><ul class="simple">
<li><p>A <code class="docutils literal notranslate"><span class="pre">Tangler</span></code> creates source code.</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">Weaver</span></code> creates documentation.
The various Jinja-based templates are part of weaving.</p></li>
</ul>
</div></blockquote>
</li>
<li><p><a class="reference internal" href="#input-parsing">Input Parsing</a> covers deserialization from the source <code class="docutils literal notranslate"><span class="pre">.w</span></code> file
to the base model of <code class="docutils literal notranslate"><span class="pre">Web</span></code>, <code class="docutils literal notranslate"><span class="pre">Chunk</span></code>, and <code class="docutils literal notranslate"><span class="pre">Command</span></code>.</p>
<ul class="simple">
<li><p><a class="reference internal" href="#the-webreader-class">The WebReader class</a> which parses the Web structure.</p></li>
<li><p><a class="reference internal" href="#the-tokenizer-class">The Tokenizer class</a> which tokenizes the raw input.</p></li>
</ul>
</li>
<li><p>Other application components:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#error-class">Error Class</a> defines an application-specific exception.
This covers all of the various kinds of problems that might arise.</p></li>
<li><p><a class="reference internal" href="#action-class-hierarchy">Action class hierarchy</a> defines things this program does.</p></li>
<li><p><a class="reference internal" href="#the-application-class">The Application class</a>. This is an overall class definition that includes
command line parsing, picking an Action, configuring and executing the Action.
It could be a set of related functions, but we’ve bound them into a class.</p></li>
<li><p><a class="reference internal" href="#logging-setup">Logging setup</a>. This includes a simple context manager for logging.</p></li>
<li><p><a class="reference internal" href="#the-main-function">The Main Function</a>.</p></li>
<li><p><a class="reference internal" href="#pyweb-module-file">pyWeb Module File</a> defines the final module file that contains the application.</p></li>
</ul>
</li>
</ul>
<p>We’ll start with the base classes that define the data model for the source WEB of chunks.</p>
<section id="base-classes">
<h3><a class="toc-backref" href="#id45" role="doc-backlink">Base Classes</a><a class="headerlink" href="#base-classes" title="Link to this heading">¶</a></h3>
<p>Here are some of the base classes that define the structure and meaning of a <code class="docutils literal notranslate"><span class="pre">.w</span></code> source file.</p>
<p class="rubric" id="base-class-definitions-1">Base Class Definitions (1) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span>→ `Command class hierarchy -- used to describe individual commands in a chunk (10)`_

→ `Chunk class hierarchy -- used to describe individual chunks (8)`_

→ `Web class -- describes the overall &quot;web&quot; of chunks (3)`_
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Base Class Definitions (1)</em>.
Used by     → <a class="reference internal" href="#pyweb-py-80">pyweb.py (80)</a>.</p>
</div>
<p>The above order is reasonably helpful for Python and minimizes forward references.
The <code class="docutils literal notranslate"><span class="pre">Chunk</span></code>, <code class="docutils literal notranslate"><span class="pre">Command</span></code>, and <code class="docutils literal notranslate"><span class="pre">Web</span></code> instances do have a circular relationship, making a strict ordering a bit complex.</p>
<p>We’ll start at the central collection of information, the <code class="docutils literal notranslate"><span class="pre">Web</span></code> class of objects.</p>
<section id="web-class">
<h4><a class="toc-backref" href="#id46" role="doc-backlink">Web Class</a><a class="headerlink" href="#web-class" title="Link to this heading">¶</a></h4>
<p>The overall web of chunks is contained in a single instance of the <code class="docutils literal notranslate"><span class="pre">Web</span></code> class.
This is the principle parameter for the weaving and tangling actions.
Broadly, the functionality of a Web can be separated into the following areas:</p>
<ul class="simple">
<li><p>It is constructed by a <code class="docutils literal notranslate"><span class="pre">WebReader</span></code>.</p></li>
<li><p>It also supports “enrichment” of the web, once all the <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> instances are known.
This is a stateful update to the web.
Each <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> is updated with  references it makes as well as references to it.</p></li>
<li><p>It supports <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> cross-reference methods that traverse this enriched data.
This includes a kind of validity check to be sure that everything is used once
and once only.</p></li>
</ul>
<p>Fundamentally, a <code class="docutils literal notranslate"><span class="pre">Web</span></code> is a hybrid list+mapping. It as the following features:</p>
<ul class="simple">
<li><p>It’s a <code class="docutils literal notranslate"><span class="pre">Sequence</span></code> to retain all <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> instances in order.</p></li>
<li><p>It’s a mapping of name-to-Chunk that also offers a moderately sophisticated lookup, including exact match for a <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> name and an approximate match for an abbreviated name.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">Web</span></code> is built by the parser by loading the sequence of <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> instances.</p>
<p>Note that the WEB source language has a “mixed content model”.
This means the code chunks have specific tags with names.
The text, on the other hand, is interspersed among the code chunks.
The text belongs to implicit, unnamed text chunks.</p>
<p>A web instance has a number of attributes.</p>
<dl class="field-list simple">
<dt class="field-odd">chunks<span class="colon">:</span></dt>
<dd class="field-odd"><p>the sequence of <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> instances as seen in the input file.
To support anonymous chunks, and to assure that the original input document order
is preserved, we keep all chunks in a master sequential list.</p>
</dd>
<dt class="field-even">files<span class="colon">:</span></dt>
<dd class="field-even"><p>the <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> named <code class="docutils literal notranslate"><span class="pre">OutputChunk</span></code> chunks.
Each element of this  dictionary is a sequence of chunks that have the same name.
The first is the initial definition (marked with “=”), all others a second definitions
(marked with “+=”).</p>
</dd>
<dt class="field-odd">macros<span class="colon">:</span></dt>
<dd class="field-odd"><p>the <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> named <code class="docutils literal notranslate"><span class="pre">NamedChunk</span></code> chunks.  Each element of this
dictionary is a sequence of chunks that have the same name.  The first is the
initial definition (marked with “=”), all others a second definitions
(marked with “+=”).</p>
</dd>
<dt class="field-even">userids<span class="colon">:</span></dt>
<dd class="field-even"><p>the cross reference of chunks referenced by commands in other
chunks.</p>
</dd>
</dl>
<p>This relies on the way a <code class="docutils literal notranslate"><span class="pre">&#64;dataclass</span></code> does post-init processing.
One the raw sequence of <code class="docutils literal notranslate"><span class="pre">Chunks</span></code> has been presented, some additional processing is done to link each <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> to the web.
This permits the <code class="docutils literal notranslate"><span class="pre">full_name</span></code> property to expand abbreviated names to full names,
and, consequently, chunk references.</p>
<p class="rubric" id="imports-2">Imports (2) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterator</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">cache</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">SimpleNamespace</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">ClassVar</span>
<span class="kn">from</span> <span class="nn">weakref</span> <span class="kn">import</span> <span class="n">ref</span><span class="p">,</span> <span class="n">ReferenceType</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Imports (2)</em>.
Used by     → <a class="reference internal" href="#pyweb-py-80">pyweb.py (80)</a>.</p>
</div>
<p>The class defines one visible element of a <code class="docutils literal notranslate"><span class="pre">Web</span></code> instance, the <code class="docutils literal notranslate"><span class="pre">chunks</span></code> list of <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> instances.
From this list of <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> objects, the remaining internal objects are built.
These include the following:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">chunk_map</span></code> has the mapping of chunk names to list of chunks that provide the definition for the chunk.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">userid_map</span></code> has the mapping of user-defined names to the list of chunks that define the name.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">references</span></code> is the set of all referenced chunks.</p></li>
</ul>
<p>Additionally there are attributes to contain a logger, a reference to the WEB file path,
used to evaluate expressions, and a “strict-match” option that can report errors during
name resolution.
Disabling strict-match will allow documents to be tangled that are potentially incomplete.</p>
<p>Generally, a parser will create a list of <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> objects.
From this, the parser can create the final <code class="docutils literal notranslate"><span class="pre">Web</span></code>.</p>
<p class="rubric" id="web-class-describes-the-overall-web-of-chunks-3">Web class – describes the overall “web” of chunks (3) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Web</span><span class="p">:</span>
    <span class="n">chunks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;Chunk&quot;</span><span class="p">]</span>  <span class="c1">#: The source sequence of chunks.</span>

    <span class="c1"># The ``@d`` chunk names and locations where they&#39;re defined.</span>
    <span class="n">chunk_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;Chunk&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># The ``@|`` defined names and chunks with which they&#39;re associated.</span>
    <span class="n">userid_map</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;Chunk&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">logger</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Web&quot;</span><span class="p">))</span>

    <span class="n">web_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1">#: Source WEB file; set by ```WebParse``</span>

    <span class="n">strict_match</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1">#: Report ... names without a definition.</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Web class – describes the overall “web” of chunks (3)</em>.
Used by     → <a class="reference internal" href="#base-class-definitions-1">Base Class Definitions (1)</a>.</p>
</div>
<p>The  <code class="docutils literal notranslate"><span class="pre">__post_init__()</span></code> special method populates the detailed structure of the WEB document.
There are several passes through the WEB to digest the data:</p>
<ol class="arabic simple">
<li><p>Set all <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> and <code class="docutils literal notranslate"><span class="pre">Command</span></code> back references to the <code class="docutils literal notranslate"><span class="pre">Web</span></code> container.
This is required so a <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> with a <code class="docutils literal notranslate"><span class="pre">ReferenceCommand</span></code> instance can properly
refer to a chunk elsewhere in the <code class="docutils literal notranslate"><span class="pre">Web</span></code> container.
There are all weak references to faciliate garbgage collection.</p></li>
<li><p>Locate the unabbreviated names in chunks and references to chunks.
Names can found in two places:
the <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> command provides a name, and
a <code class="docutils literal notranslate"><span class="pre">&#64;&lt;name&#64;&gt;</span></code> command provides a reference to a name.
The unabbreviated names define the structure.
Unambiguous abbreviations can be used freely, since full names are located first.</p></li>
<li><p>Accumulate chunk lists, output lists, and name definition lists.
This pass does two things.
First any user-defined name after a <code class="docutils literal notranslate"><span class="pre">&#64;|</span></code> command is accumulated.
Second, any abbreviated name is resolved to the full name,
and the complete mapping from chunk name to a sequence of defining chunks is completed.</p></li>
<li><p>Set the <code class="docutils literal notranslate"><span class="pre">referencedBy</span></code> attribute of a <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> instance with all of the
commands that point to it.
The idea here is that a top-level <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> instance may have references to other <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> isntances.
This forms a kind of tree.
Any given low-level <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> object is named by a sequence of parent <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> objects.</p></li>
</ol>
<p>Once the initialization is complete, the <code class="docutils literal notranslate"><span class="pre">Web</span></code> instance can be woven or tangled.</p>
<p class="rubric" id="web-class-describes-the-overall-web-of-chunks-4">Web class – describes the overall “web” of chunks (4) +=</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Populate weak references throughout the web to make full_name properties work.</span>
<span class="sd">        Then. Locate all macro definitions and userid references.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Pass 1 -- set all Chunk and Command back references.</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">web</span> <span class="o">=</span> <span class="n">ref</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">commands</span><span class="p">:</span>
                <span class="n">cmd</span><span class="o">.</span><span class="n">web</span> <span class="o">=</span> <span class="n">ref</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Named Chunks = Union of macro_iter and file_iter</span>
        <span class="n">named_chunks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span><span class="p">))</span>

        <span class="c1"># Pass 2 -- locate the unabbreviated names in chunks and references to chunks.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunk_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">seq</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">named_chunks</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">c</span><span class="o">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
                <span class="c1"># Use ``@d name`` chunks (reject ``@o`` and text)</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;...&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;__post_init__ 2a </span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="si">=!r}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chunk_map</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">commands</span><span class="p">:</span>
                <span class="c1"># Find ``@&lt; name @&gt;`` in ``@d name`` chunks or ``@o`` chunks</span>
                <span class="k">if</span> <span class="n">cmd</span><span class="o">.</span><span class="n">has_name</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">cast</span><span class="p">(</span><span class="n">ReferenceCommand</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;...&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;__post_init__ 2b </span><span class="si">{</span><span class="n">cast</span><span class="p">(</span><span class="n">ReferenceCommand</span><span class="p">,</span><span class="w"> </span><span class="n">cmd</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">=!r}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">chunk_map</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">ReferenceCommand</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">[])</span>

        <span class="c1"># Pass 3 -- accumulate chunk lists, output lists, and name definition lists.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">userid_map</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">named_chunks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">def_names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">userid_map</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
                <span class="c1"># Named ``@d name`` chunks</span>
                <span class="k">if</span> <span class="n">full_name</span> <span class="o">:=</span> <span class="n">c</span><span class="o">.</span><span class="n">full_name</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk_map</span><span class="p">[</span><span class="n">full_name</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chunk_map</span><span class="p">[</span><span class="n">full_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;__post_init__ 3 </span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="si">=!r}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">full_name</span><span class="si">=!r}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Output ``@o`` and anonymous chunks.</span>
                <span class="c1"># Assume all @o chunks are unique. If they&#39;re not, they overwrite each other.</span>
                <span class="c1"># Also, there&#39;s not ``full_name`` for these chunks.</span>
                <span class="n">c</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># TODO: Accumulate all chunks that contribute to a named file...</span>

        <span class="c1"># Pass 4 -- set referencedBy a command in a chunk.</span>
        <span class="c1"># ONLY set this in references embedded in named chunk or output chunk.</span>
        <span class="c1"># In a generic Chunk (which is text) there&#39;s no anchor to refer to.</span>
        <span class="c1"># NOTE: Assume single references *only*</span>
        <span class="c1"># We should raise an exception when updating a non-None referencedBy value.</span>
        <span class="c1"># Or incrementing ref_chunk.references &gt; 1.</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">named_chunks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">commands</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cmd</span><span class="o">.</span><span class="n">has_name</span><span class="p">:</span>
                    <span class="n">ref_to_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_chunk</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">ReferenceCommand</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">ref_chunk</span> <span class="ow">in</span> <span class="n">ref_to_list</span><span class="p">:</span>
                        <span class="n">ref_chunk</span><span class="o">.</span><span class="n">referencedBy</span> <span class="o">=</span> <span class="n">c</span>
                        <span class="n">ref_chunk</span><span class="o">.</span><span class="n">references</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Web class – describes the overall “web” of chunks (4)</em>.
Used by     → <a class="reference internal" href="#base-class-definitions-1">Base Class Definitions (1)</a>.</p>
</div>
<p>The representation of a <code class="docutils literal notranslate"><span class="pre">Web</span></code> instance is a sequence of <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> instances.
This can be long and difficult to read.
It is, however, complete, and can be  used to build instances of <code class="docutils literal notranslate"><span class="pre">Web</span></code> objects from a variety of sources.</p>
<p class="rubric" id="web-class-describes-the-overall-web-of-chunks-5">Web class – describes the overall “web” of chunks (5) +=</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">NL</span> <span class="o">=</span> <span class="s2">&quot;,</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">NL</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">chunks</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;)&quot;</span>
        <span class="p">)</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Web class – describes the overall “web” of chunks (5)</em>.
Used by     → <a class="reference internal" href="#base-class-definitions-1">Base Class Definitions (1)</a>.</p>
</div>
<p>Name and Chunk resolution are similar.
Name resolution provides only the expanded name.
Chunk resolution provides the list of chunks that define a name.
Chunk resolution expands on the basic features of Name resolution.</p>
<p>The complex <code class="docutils literal notranslate"><span class="pre">target.endswith('...')</span></code> processing only happens once during <code class="docutils literal notranslate"><span class="pre">__post_init__()</span></code> processing.
After the initalization is complete, all <code class="docutils literal notranslate"><span class="pre">ReferenceCommand</span></code> objects will have a <code class="docutils literal notranslate"><span class="pre">full_name</span></code> attribute that avoids the complication of resolving a name with a <code class="docutils literal notranslate"><span class="pre">...</span></code> ellipsis.</p>
<p class="rubric" id="web-class-describes-the-overall-web-of-chunks-6">Web class – describes the overall “web” of chunks (6) +=</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">resolve_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Map short names to full names, if possible.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_map</span><span class="p">:</span>
            <span class="c1"># self.logger.debug(f&quot;resolve_name {target=} in self.chunk_map&quot;)</span>
            <span class="k">return</span> <span class="n">target</span>
        <span class="k">elif</span> <span class="n">target</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;...&#39;</span><span class="p">):</span>
            <span class="c1"># The ... is equivalent to regular expression .*</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="n">c_name</span>
                <span class="k">for</span> <span class="n">c_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_map</span>
                <span class="k">if</span> <span class="n">c_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">target</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="c1"># self.logger.debug(f&quot;resolve_name {target=} {matches=} in self.chunk_map&quot;)</span>
            <span class="k">match</span> <span class="n">matches</span><span class="p">:</span>
                <span class="k">case</span> <span class="p">[]:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">strict_match</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No full name for </span><span class="si">{</span><span class="n">target</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;resolve_name </span><span class="si">{</span><span class="n">target</span><span class="si">=}</span><span class="s2"> unknown&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">chunk_map</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">return</span> <span class="n">target</span>
                <span class="k">case</span> <span class="p">[</span><span class="n">head</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="n">head</span>
                <span class="k">case</span> <span class="p">[</span><span class="n">head</span><span class="p">,</span> <span class="o">*</span><span class="n">tail</span><span class="p">]:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Ambiguous abbreviation </span><span class="si">{</span><span class="n">target</span><span class="si">!r}</span><span class="s2">, matches </span><span class="si">{</span><span class="p">[</span><span class="n">head</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tail</span><span class="si">!r}</span><span class="s2">&quot;</span>
                    <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unexpected </span><span class="si">{</span><span class="n">matches</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;resolve_name </span><span class="si">{</span><span class="n">target</span><span class="si">=}</span><span class="s2"> unknown&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chunk_map</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">return</span> <span class="n">target</span>

    <span class="k">def</span> <span class="nf">resolve_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;Chunk&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Map name (short or full) to the defining sequence of chunks.&quot;&quot;&quot;</span>
        <span class="n">full_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_name</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="n">chunk_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_map</span><span class="p">[</span><span class="n">full_name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;resolve_chunk </span><span class="si">{</span><span class="n">target</span><span class="si">=!r}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">full_name</span><span class="si">=!r}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">chunk_list</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">chunk_list</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Web class – describes the overall “web” of chunks (6)</em>.
Used by     → <a class="reference internal" href="#base-class-definitions-1">Base Class Definitions (1)</a>.</p>
</div>
<p>The point of the <code class="docutils literal notranslate"><span class="pre">Web</span></code> object is to be able to manage a variety of  structures.
These iterator methods and properties provide the list of <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> chunks, <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> chunks, and the usernames after <code class="docutils literal notranslate"><span class="pre">&#64;|</span></code> in a chunk.</p>
<p>Additionally, we can confirm the overall structure by asserting that each <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> name has one reference.
A name with no references indicates an omission, a name with multiple references suggests a spelling or ellipsis problem.</p>
<p class="rubric" id="web-class-describes-the-overall-web-of-chunks-7">Web class – describes the overall “web” of chunks (7) +=</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">file_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">OutputChunk</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">OutputChunk</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">type_is</span><span class="p">(</span><span class="s2">&quot;OutputChunk&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">macro_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">NamedChunk</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">NamedChunk</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">type_is</span><span class="p">(</span><span class="s2">&quot;NamedChunk&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">userid_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">SimpleNamespace</span><span class="p">]:</span>
        <span class="k">yield from</span> <span class="p">(</span><span class="n">SimpleNamespace</span><span class="p">(</span><span class="n">def_name</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_iter</span><span class="p">()</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">def_names</span><span class="p">)</span>
        <span class="k">yield from</span> <span class="p">(</span><span class="n">SimpleNamespace</span><span class="p">(</span><span class="n">def_name</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro_iter</span><span class="p">()</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">def_names</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">files</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;OutputChunk&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_iter</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">macros</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">SimpleNamespace</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The chunk_map has the list of Chunks that comprise a macro definition.</span>
<span class="sd">        We separate those to make it slightly easier to format the first definition.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">first_list</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk_map</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_map</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk_map</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_map</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">macro_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">SimpleNamespace</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">first_def</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">full_name</span><span class="o">=</span><span class="n">first_def</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="n">seq</span><span class="o">=</span><span class="n">first_def</span><span class="o">.</span><span class="n">seq</span><span class="p">,</span> <span class="n">def_list</span><span class="o">=</span><span class="n">def_list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">first_def</span><span class="p">,</span> <span class="n">def_list</span> <span class="ow">in</span> <span class="n">first_list</span>
        <span class="p">)</span>
        <span class="c1"># self.logger.debug(f&quot;macros: {defs}&quot;)</span>
        <span class="k">return</span> <span class="n">macro_list</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">userids</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">SimpleNamespace</span><span class="p">]:</span>
        <span class="n">userid_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">SimpleNamespace</span><span class="p">(</span><span class="n">userid</span><span class="o">=</span><span class="n">userid</span><span class="p">,</span> <span class="n">ref_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">userid_map</span><span class="p">[</span><span class="n">userid</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">userid</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">userid_map</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># self.logger.debug(f&quot;userids: {userid_list}&quot;)</span>
        <span class="k">return</span> <span class="n">userid_list</span>

    <span class="k">def</span> <span class="nf">no_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Chunk</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">path</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">references</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">multi_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Chunk</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">path</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">references</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span><span class="p">))</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Web class – describes the overall “web” of chunks (7)</em>.
Used by     → <a class="reference internal" href="#base-class-definitions-1">Base Class Definitions (1)</a>.</p>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">Web</span></code> instance is built by a <code class="docutils literal notranslate"><span class="pre">WebReader</span></code>.
It’s used by an <code class="docutils literal notranslate"><span class="pre">Emitter</span></code>, including a <code class="docutils literal notranslate"><span class="pre">Weaver</span></code> as well as a <code class="docutils literal notranslate"><span class="pre">Tangler</span></code>.
A <code class="docutils literal notranslate"><span class="pre">Web</span></code> is composed of individual <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> instances.</p>
</section>
<section id="chunk-class-hierarchy">
<h4><a class="toc-backref" href="#id47" role="doc-backlink">Chunk Class Hierarchy</a><a class="headerlink" href="#chunk-class-hierarchy" title="Link to this heading">¶</a></h4>
<p>A <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> is a piece of the input file.
It is a collection of <code class="docutils literal notranslate"><span class="pre">Command</span></code> instances.
A <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> can be woven or tangled to create output.</p>
<p class="plantuml">
<img src="_images/plantuml-299c614608ce6dd7cfca24950c88c2a8ee869da7.png" alt="class Chunk {
    options: list[str]
    name: str
    seq: int
    commands: list[Command]
    def_names: list[str]
    initial: bool
}

class OutputChunk
Chunk &lt;|-- OutputChunk

class NamedChunk
Chunk &lt;|-- NamedChunk"/>
</p>
<p>These subclasss reflect three kinds of content in the WEB source document:</p>
<ul class="simple">
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">Chunk</span></code> is the anonymous text context.</dt><dd><p>Text in the body generally becomes a <code class="docutils literal notranslate"><span class="pre">TextCommand</span></code>.
Also, the various XREF commands (<code class="docutils literal notranslate"><span class="pre">&#64;m</span></code>, <code class="docutils literal notranslate"><span class="pre">&#64;f</span></code>, <code class="docutils literal notranslate"><span class="pre">&#64;u</span></code>) can <em>only</em> appear here.
In principle, a <code class="docutils literal notranslate"><span class="pre">&#64;&lt;</span> <span class="pre">reference</span> <span class="pre">&#64;&gt;</span></code> can appear in text.
It must name a <code class="docutils literal notranslate"><span class="pre">&#64;d</span> <span class="pre">name</span> <span class="pre">&#64;[...&#64;]</span></code> NamedDocumentChunk, which is expanded in place, not linked.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">OutputChunk</span></code> is the <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> context.</dt><dd><p>Text in the body becomes a <code class="docutils literal notranslate"><span class="pre">CodeCommand</span></code>.
Any <code class="docutils literal notranslate"><span class="pre">&#64;&lt;</span> <span class="pre">reference</span> <span class="pre">&#64;&gt;</span></code> will be expanded when tangling, but become a link when weaving.
This defines an output file.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">NamedChunk</span></code> is the <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> context.</dt><dd><p>Text in the body becomes a <code class="docutils literal notranslate"><span class="pre">CodeCommand</span></code>.
Any <code class="docutils literal notranslate"><span class="pre">&#64;&lt;</span> <span class="pre">reference</span> <span class="pre">&#64;&gt;</span></code> will be expanded when tangling, but become a link when weaving.</p>
</dd>
</dl>
</li>
</ul>
<p>Most of the attributes are pushed up to the base class.
This makes type checking the complex WEB tree simpler.</p>
<p>The attributes are visible to the Jinja templates.
In particular the sequence number, <code class="docutils literal notranslate"><span class="pre">seq</span></code>,  and the initial definition indicator, <code class="docutils literal notranslate"><span class="pre">initial</span></code>, are often used to customize presentation of the woven content.</p>
<p>A <code class="docutils literal notranslate"><span class="pre">type_is()</span></code> method is used to discern the various subtypes.
This slightly simplifies the work done by a template.
It’s not easy to rely on proper inheritance because the templates are implemented in a separate language with their own processing rules.</p>
<p class="rubric" id="chunk-class-hierarchy-used-to-describe-individual-chunks-8">Chunk class hierarchy – used to describe individual chunks (8) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Chunk</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for OutputChunk, NamedChunk, NamedDocumentChunk.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#: Parsed options for @d and @o chunks; used by __post_init__() to set other attributes.</span>
    <span class="n">options</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

    <span class="c1">#: Short name of the chunk.</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: Unique sequence number of chunk in the WEB.</span>
    <span class="n">seq</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: Sequence of commands inside this chunk.</span>
    <span class="n">commands</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;Command&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

    <span class="c1">#: Names defined after ``@|`` in this chunk.</span>
    <span class="n">def_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

    <span class="c1">#: Is this the first use of a given Chunk name?</span>
    <span class="n">initial</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1">#: If injecting location details when tangling, this is the comment prefix.</span>
    <span class="n">comment_start</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: If injecting location details, this is the comment suffix.</span>
    <span class="n">comment_end</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: When weaving, set weave=False to skip this.</span>
    <span class="n">weave</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1">#: When weaving, this is a style to use.</span>
    <span class="n">style</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: Count of references to this Chunk.</span>
    <span class="n">references</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1">#: The immediate reference to this chunk.</span>
    <span class="n">referencedBy</span><span class="p">:</span> <span class="s2">&quot;Chunk | None&quot;</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1">#: Weak reference to the ``Web`` containing this ``Chunk``.</span>
    <span class="n">web</span><span class="p">:</span> <span class="n">ReferenceType</span><span class="p">[</span><span class="s2">&quot;Web&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1">#: Logger for any chunk-specific messages.</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;Chunk&quot;</span><span class="p">))</span>

    <span class="c1">#: Indentation Rule; None means indent; number is the amount to indent.</span>
    <span class="n">indent</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse options.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;attempt to create </span><span class="si">%s</span><span class="s2"> with options </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">full_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">web</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;no web assigned to chunk </span><span class="si">{self!s}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">Web</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="p">())</span><span class="o">.</span><span class="n">resolve_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">location</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">location</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">transitive_referencedBy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;Chunk&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">referencedBy</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">referencedBy</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">referencedBy</span><span class="o">.</span><span class="n">transitive_referencedBy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Chunk&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commands</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">typeid</span><span class="o">.</span><span class="n">TextCommand</span><span class="p">:</span>
            <span class="n">cast</span><span class="p">(</span><span class="n">HasText</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">text</span> <span class="o">+=</span> <span class="n">text</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Empty list OR previous command was not ``TextCommand``</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TextCommand</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">location</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">type_is</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instead of type name matching, we could check for these features:</span>
<span class="sd">        - has_code() (i.e., NamedChunk and OutputChunk)</span>
<span class="sd">        - has_text() (i.e., Chunk and NamedDocumentChunk)</span>
<span class="sd">        Since this is for template rendering, where proper Liskov</span>
<span class="sd">        Substitution is irrelevant, we match class names.</span>

<span class="sd">        This can&#39;t **easily** use the ``typeid`` metaclass because it&#39;s a dataclass.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="n">name</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Chunk class hierarchy – used to describe individual chunks (8)</em>.
Used by     → <a class="reference internal" href="#base-class-definitions-1">Base Class Definitions (1)</a>.</p>
</div>
<p>The subclasses do little more than partition the Chunks in a way that permits customization in the template rendering process.</p>
<p>An <code class="docutils literal notranslate"><span class="pre">OutputChunk</span></code> is distinguished from <code class="docutils literal notranslate"><span class="pre">NamedChunk</span></code> by having a <code class="docutils literal notranslate"><span class="pre">path</span></code> property and not having a <code class="docutils literal notranslate"><span class="pre">full_name</span></code> property.</p>
<p class="rubric" id="chunk-class-hierarchy-used-to-describe-individual-chunks-9">Chunk class hierarchy – used to describe individual chunks (9) +=</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">OutputChunk</span><span class="p">(</span><span class="n">Chunk</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An output file from an ``@o`` Chunk&quot;&quot;&quot;</span>
    <span class="n">option_parser</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse options.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_parser</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">option_parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">add_help</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exit_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">option_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-start&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">option_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-end&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">option_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-noweave&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;weave&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_false&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># All remaining arguments form the chunk name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">option_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;argument&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
        <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">argument</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comment_start</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">start</span> <span class="k">if</span> <span class="s1">&#39;-start&#39;</span> <span class="ow">in</span> <span class="n">options</span> <span class="k">else</span> <span class="s2">&quot;# &quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comment_end</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">end</span> <span class="k">if</span> <span class="s1">&#39;-end&#39;</span> <span class="ow">in</span> <span class="n">options</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weave</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">weave</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">full_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">add_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Chunk</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commands</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">typeid</span><span class="o">.</span><span class="n">CodeCommand</span><span class="p">:</span>
            <span class="n">cast</span><span class="p">(</span><span class="n">HasText</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">text</span> <span class="o">+=</span> <span class="n">text</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Empty list OR previous command was not ``CodeCommand``</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CodeCommand</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">location</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>

<span class="k">class</span> <span class="nc">NamedChunk</span><span class="p">(</span><span class="n">Chunk</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A defined name with code from a ``@d`` Chunk</span>

<span class="sd">    ..  note:: syntex for ``-indent``/``-noindent``.</span>

<span class="sd">        - ``-indent`` provides None, normal indent</span>

<span class="sd">        - ``-noindent`` is effectively ``-indent 0``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">option_parser</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_parser</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">option_parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">add_help</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exit_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">option_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-style&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;style&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">option_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-indent&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;indent&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_const&#39;</span><span class="p">,</span>
             <span class="n">const</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">option_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-noindent&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;indent&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_const&#39;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">option_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;argument&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
        <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">argument</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;noindent&#39;</span> <span class="ow">in</span> <span class="n">options</span> <span class="ow">and</span> <span class="n">options</span><span class="o">.</span><span class="n">noindent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="s1">&#39;indent&#39;</span> <span class="ow">in</span> <span class="n">options</span> <span class="ow">and</span> <span class="n">options</span><span class="o">.</span><span class="n">indent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">indent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">style</span>

    <span class="k">def</span> <span class="nf">add_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Chunk</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commands</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">typeid</span><span class="o">.</span><span class="n">CodeCommand</span><span class="p">:</span>
            <span class="n">cast</span><span class="p">(</span><span class="n">HasText</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">text</span> <span class="o">+=</span> <span class="n">text</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Empty list OR previous command was not ``CodeCommand``</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CodeCommand</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">location</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>

<span class="k">class</span> <span class="nc">NamedDocumentChunk</span><span class="p">(</span><span class="n">Chunk</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A defined name with text.</span>

<span class="sd">    ..  todo:: Refactor parse_options to base class</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">option_parser</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_parser</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">option_parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">add_help</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exit_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">option_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-style&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="c1"># All remaining arguments form the chunk name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">option_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;argument&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
        <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">argument</span><span class="p">)</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Chunk class hierarchy – used to describe individual chunks (9)</em>.
Used by     → <a class="reference internal" href="#base-class-definitions-1">Base Class Definitions (1)</a>.</p>
</div>
</section>
<section id="command-class-hierarchy">
<h4><a class="toc-backref" href="#id48" role="doc-backlink">Command Class Hierarchy</a><a class="headerlink" href="#command-class-hierarchy" title="Link to this heading">¶</a></h4>
<p>A <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> is a sequence of <code class="docutils literal notranslate"><span class="pre">Command</span></code> instances.
For the generic <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> base class, the commands are – mostly – the <code class="docutils literal notranslate"><span class="pre">TextCommand</span></code> subclass of <code class="docutils literal notranslate"><span class="pre">Command</span></code>; these are blocks of text.
A <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> may also include some <code class="docutils literal notranslate"><span class="pre">XRefCommand</span></code> instances which expand to cross-reference material for an index.</p>
<p>For the <code class="docutils literal notranslate"><span class="pre">CodeChunk</span></code> and <code class="docutils literal notranslate"><span class="pre">NamedChunk</span></code> subclasses, the commands are <code class="docutils literal notranslate"><span class="pre">CodeCommand</span></code> instances intermixed with <code class="docutils literal notranslate"><span class="pre">ReferenceCommand</span></code> instances.
A <code class="docutils literal notranslate"><span class="pre">CodeCommand</span></code> has a wrapper applied to it when weaving.
Additionally, it will be tangled into the output.
A <code class="docutils literal notranslate"><span class="pre">ReferenceCommand</span></code> becomes a link when weaving, and expands to its full body when being tangled.</p>
<p class="plantuml">
<img src="_images/plantuml-fae6df9bf8cb355e39c19c6987c8cc7be8d16732.png" alt="class Chunk {
    name: str
    commands: list[Command]
}
abstract class Command {
    {static} has_name: bool
    {static} has_text: bool
    {static} typeid: TypeId
    text: str
    tangle(Tangler, Target)
}

Chunk *-- &quot;1..*&quot; Command

abstract HasText
Command &lt;|-- HasText

class TextCommand
HasText &lt;|-- TextCommand

class CodeCommand
HasText &lt;|-- CodeCommand

class ReferenceCommand
Command &lt;|-- ReferenceCommand

abstract XRefCommand
Command &lt;|-- XRefCommand

class FileXRefCommand
XRefCommand &lt;|-- FileXRefCommand

class MacroXRefCommand
XRefCommand &lt;|-- MacroXRefCommand

class UseridXRefCommand
XRefCommand &lt;|-- UseridXRefCommand

class TypeId {
    __getattr__(str) : bool
}

Command -- TypeId"/>
</p>
<p>Each of these variants has the possibility of distinct processing when weaving the final document.
The type information must be  visibile to the Jinja template processing.
This is done through an instance of the <code class="docutils literal notranslate"><span class="pre">TypeId</span></code> class attached to each of these classes.</p>
<p>The input stream is broken into individual commands, based on the various <code class="docutils literal notranslate"><span class="pre">&#64;</span></code><em>x</em> strings in the file.
There are several subclasses of <code class="docutils literal notranslate"><span class="pre">Command</span></code>, each used to describe a different command or block of text in the input.</p>
<p>All instances of the <code class="docutils literal notranslate"><span class="pre">Command</span></code> class are created by the <code class="docutils literal notranslate"><span class="pre">WebReader</span></code> instance.
In this case, a <code class="docutils literal notranslate"><span class="pre">WebReader</span></code> can be thought of as a factory for <code class="docutils literal notranslate"><span class="pre">Command</span></code> instances.
Each <code class="docutils literal notranslate"><span class="pre">Command</span></code> instance is appended to the sequence of commands that
belong to a <code class="docutils literal notranslate"><span class="pre">Chunk</span></code>.</p>
<p>This model permits two kinds of serialization:</p>
<ul class="simple">
<li><p>Weaving a document from the WEB source file. This uses the various attributes
of the various subclasses.</p></li>
<li><p>Tangling target documents with code. This relies on a <code class="docutils literal notranslate"><span class="pre">tangle()</span></code> method
in each subclass.</p></li>
</ul>
<p>We’ll address the run-time type identification first,
the the definitions of the various <code class="docutils literal notranslate"><span class="pre">Command</span></code> subclasses.</p>
<p class="rubric" id="command-class-hierarchy-used-to-describe-individual-commands-in-a-chunk-10">Command class hierarchy – used to describe individual commands in a chunk (10) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span>→ `The TypeId Class -- to help the template engine (12)`_

→ `The Command Abstract Base Class (13)`_

→ `The HasText Type Hint -- used instead of another abstract class (14)`_

→ `The TextCommand Class (15)`_
→ `The CodeCommand Class (16)`_
→ `The ReferenceCommand Class (17)`_
→ `The XrefCommand Subclasses -- files, macros, and user names (18)`_
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Command class hierarchy – used to describe individual commands in a chunk (10)</em>.
Used by     → <a class="reference internal" href="#base-class-definitions-1">Base Class Definitions (1)</a>.</p>
</div>
<section id="the-typeid-class">
<h5><a class="toc-backref" href="#id49" role="doc-backlink">The TypeId Class</a><a class="headerlink" href="#the-typeid-class" title="Link to this heading">¶</a></h5>
<p>The <code class="docutils literal notranslate"><span class="pre">TypeId</span></code> class provides run-time type identification to the Jinja templates.
The idea is <code class="docutils literal notranslate"><span class="pre">object.typeid.AClass</span></code> is  equivalent to <code class="docutils literal notranslate"><span class="pre">isinstance(object,</span> <span class="pre">pyweb.AClass)</span></code>.
It has simpler syntax and works better with Jinja templates.
It helps sort out the various nodes of the AST built from the source WEB document.</p>
<p>There are three parts to the <code class="docutils literal notranslate"><span class="pre">TypeId</span></code> implementation:</p>
<ul class="simple">
<li><p>A <code class="docutils literal notranslate"><span class="pre">TypeId</span></code> class definition to handle the attribute access.
A reference to <code class="docutils literal notranslate"><span class="pre">object.typeid.Name</span></code> evaluates <code class="docutils literal notranslate"><span class="pre">__getattr__(object,</span> <span class="pre">'Name')</span></code>.</p></li>
<li><p>A metaclass definition, <code class="docutils literal notranslate"><span class="pre">TypeIdMeta</span></code>, to inject the new <code class="docutils literal notranslate"><span class="pre">typeid</span></code> attribute into each class.</p></li>
<li><p>The normal class initialization process, which evaluates <code class="docutils literal notranslate"><span class="pre">__set_name__()</span></code>
for each attribute of a class that defines the method.
This provides the containing class to the <code class="docutils literal notranslate"><span class="pre">TypeId</span></code> instance.</p></li>
</ul>
<p>The idea of run-time type identification is – in a way – a failure to properly
define the classes to follow the Liskov Substitution design principle.
This becomes awkwardly complex in the Jinja templates, because the templates exist
outside the class hierarchy.
We rely on the <code class="docutils literal notranslate"><span class="pre">typeid</span></code> to map classes to macros appropriate to the class.</p>
<p class="rubric" id="imports-11">Imports (11) +=</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">Generic</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Imports (11)</em>.
Used by     → <a class="reference internal" href="#pyweb-py-80">pyweb.py (80)</a>.</p>
</div>
<p class="rubric" id="the-typeid-class-to-help-the-template-engine-12">The TypeId Class – to help the template engine (12) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TypeId</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This makes a given class name into an attribute with a</span>
<span class="sd">    True value. Any other attribute reference will return False.</span>

<span class="sd">    &gt;&gt;&gt; class A:</span>
<span class="sd">    ...     typeid = TypeId()</span>
<span class="sd">    &gt;&gt;&gt; a = A()</span>
<span class="sd">    &gt;&gt;&gt; a.typeid.A</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; a.typeid.B</span>
<span class="sd">    False</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__set_name__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">owner</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;TypeId&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Invoked automatically during object construction.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_class</span> <span class="o">=</span> <span class="n">owner</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_class</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="n">item</span>

<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Mapping</span>

<span class="k">class</span> <span class="nc">TypeIdMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Inject the ``typeid`` attribute into a class definition.&quot;&quot;&quot;</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="fm">__prepare__</span><span class="p">(</span><span class="n">metacls</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">bases</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">type</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="o">**</span><span class="n">kwds</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>  <span class="c1"># type: ignore[override]</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;typeid&quot;</span><span class="p">:</span> <span class="n">TypeId</span><span class="p">()}</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>The TypeId Class – to help the template engine (12)</em>.
Used by     → <a class="reference internal" href="#command-class-hierarchy-used-to-describe-individual-commands-in-a-chunk-10">Command class hierarchy – used to describe individual commands in a chunk (10)</a>.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">TypeIdMeta</span></code> metaclass sets the <code class="docutils literal notranslate"><span class="pre">typeid</span></code> attribute of each class defined by this metaclass.
The ordinary class preparation automatically invokes the <code class="docutils literal notranslate"><span class="pre">__set_name__()</span></code> special method to provide details to the attribute.</p>
<p>Once set, any reference to <code class="docutils literal notranslate"><span class="pre">c.typeid.name</span></code> will be evaluated as <code class="docutils literal notranslate"><span class="pre">__getattr__(c,</span> <span class="pre">'name')</span></code>.
This permits the typeid to compare the name provided by <code class="docutils literal notranslate"><span class="pre">__set_name__()</span></code> with the name
being inquired about.</p>
</section>
<section id="the-command-class">
<h5><a class="toc-backref" href="#id50" role="doc-backlink">The Command Class</a><a class="headerlink" href="#the-command-class" title="Link to this heading">¶</a></h5>
<p>The <code class="docutils literal notranslate"><span class="pre">Command</span></code> class is abstract, and describes most of the features of the various subclasses.</p>
<p class="rubric" id="the-command-abstract-base-class-13">The Command Abstract Base Class (13) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Command</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">TypeIdMeta</span><span class="p">):</span>
    <span class="n">typeid</span><span class="p">:</span> <span class="n">TypeId</span>
    <span class="n">has_name</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">has_text</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">location</span>  <span class="c1">#: The (filename, line number)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="p">:</span> <span class="n">ReferenceType</span><span class="p">[</span><span class="s2">&quot;Web&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1">#: The body of this command</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(location=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="si">!r}</span><span class="s2">)&quot;</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">tangle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aTangler</span><span class="p">:</span> <span class="s2">&quot;Tangler&quot;</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="o">...</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>The Command Abstract Base Class (13)</em>.
Used by     → <a class="reference internal" href="#command-class-hierarchy-used-to-describe-individual-commands-in-a-chunk-10">Command class hierarchy – used to describe individual commands in a chunk (10)</a>.</p>
</div>
</section>
<section id="the-hastext-classes">
<h5><a class="toc-backref" href="#id51" role="doc-backlink">The HasText Classes</a><a class="headerlink" href="#the-hastext-classes" title="Link to this heading">¶</a></h5>
<p>An Annotation summarizes some of the subclass relationships.</p>
<p class="rubric" id="the-hastext-type-hint-used-instead-of-another-abstract-class-14">The HasText Type Hint – used instead of another abstract class (14) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span> <span class="n">HasText</span> <span class="o">=</span> <span class="s2">&quot;CodeCommand | TextCommand&quot;</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>The HasText Type Hint – used instead of another abstract class (14)</em>.
Used by     → <a class="reference internal" href="#command-class-hierarchy-used-to-describe-individual-commands-in-a-chunk-10">Command class hierarchy – used to describe individual commands in a chunk (10)</a>.</p>
</div>
<p>We don’t formalize this as proper subclass definitions.
We probably should, but it doesn’t seem to add any clarity.</p>
</section>
<section id="the-textcommand-class">
<h5><a class="toc-backref" href="#id52" role="doc-backlink">The TextCommand Class</a><a class="headerlink" href="#the-textcommand-class" title="Link to this heading">¶</a></h5>
<p>The <code class="docutils literal notranslate"><span class="pre">TextCommand</span></code> class describes all of the text <strong>outside</strong> the <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> chunks.
These are <strong>not</strong> tangled, and any attempt to do this raises an exception .</p>
<p class="rubric" id="the-textcommand-class-15">The TextCommand Class (15) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TextCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Text outside any other command.&quot;&quot;&quot;</span>
    <span class="n">has_text</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>  <span class="c1">#: The text</span>

    <span class="k">def</span> <span class="nf">tangle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aTangler</span><span class="p">:</span> <span class="s2">&quot;Tangler&quot;</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;attempt to tangle a text block </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">shorten</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="si">!r}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(text=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="si">!r}</span><span class="s2">, location=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="si">!r}</span><span class="s2">)&quot;</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>The TextCommand Class (15)</em>.
Used by     → <a class="reference internal" href="#command-class-hierarchy-used-to-describe-individual-commands-in-a-chunk-10">Command class hierarchy – used to describe individual commands in a chunk (10)</a>.</p>
</div>
</section>
<section id="the-codecommand-class">
<h5><a class="toc-backref" href="#id53" role="doc-backlink">The CodeCommand Class</a><a class="headerlink" href="#the-codecommand-class" title="Link to this heading">¶</a></h5>
<p>The <code class="docutils literal notranslate"><span class="pre">CodeCommand</span></code> class describes the text <strong>inside</strong> the <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code>  chunks.
These are tangled without change.</p>
<p class="rubric" id="the-codecommand-class-16">The CodeCommand Class (16) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CodeCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Code inside a ``@o``, or ``@d`` command.&quot;&quot;&quot;</span>
    <span class="n">has_text</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>  <span class="c1">#: The text</span>

    <span class="k">def</span> <span class="nf">tangle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aTangler</span><span class="p">:</span> <span class="s2">&quot;Tangler&quot;</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tangle </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="si">=!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">aTangler</span><span class="o">.</span><span class="n">codeBlock</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(text=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="si">!r}</span><span class="s2">, location=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="si">!r}</span><span class="s2">)&quot;</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>The CodeCommand Class (16)</em>.
Used by     → <a class="reference internal" href="#command-class-hierarchy-used-to-describe-individual-commands-in-a-chunk-10">Command class hierarchy – used to describe individual commands in a chunk (10)</a>.</p>
</div>
</section>
<section id="the-referencecommand-class">
<h5><a class="toc-backref" href="#id54" role="doc-backlink">The ReferenceCommand Class</a><a class="headerlink" href="#the-referencecommand-class" title="Link to this heading">¶</a></h5>
<p>The <code class="docutils literal notranslate"><span class="pre">ReferenceCommand</span></code> class describes a <code class="docutils literal notranslate"><span class="pre">&#64;&lt;</span> <span class="pre">name</span> <span class="pre">&#64;&gt;</span></code> construct inside a chunk.
When tangled, these lead to inserting the referenced chunk’s content.
Because this a reference to another chunk, the properties provide the values for the other chunk.</p>
<p class="rubric" id="the-referencecommand-class-17">The ReferenceCommand Class (17) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ReferenceCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reference to a ``NamedChunk`` in code, a ``@&lt; name @&gt;`` construct.</span>
<span class="sd">    In a CodeChunk or OutputChunk, it tangles to the definition from a ``NamedChunk``.</span>
<span class="sd">    In text, it can weave to the text of a ``NamedDocumentChunk``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">has_name</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>  <span class="c1">#: The name that is referenced.</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">full_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">Web</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="p">())</span><span class="o">.</span><span class="n">resolve_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">seq</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">Web</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="p">())</span><span class="o">.</span><span class="n">resolve_chunk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">seq</span>

    <span class="k">def</span> <span class="nf">tangle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aTangler</span><span class="p">:</span> <span class="s2">&quot;Tangler&quot;</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Expand this reference.</span>
<span class="sd">        The starting position is the indentation for all **subsequent** lines.</span>
<span class="sd">        Provide the indent before ``@&lt;``, in ``tangler.fragment`` back to the tangler.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tangle reference to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">=}</span><span class="s2">, context: </span><span class="si">{</span><span class="n">aTangler</span><span class="o">.</span><span class="n">fragment</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">chunk_list</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Web</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="p">())</span><span class="o">.</span><span class="n">resolve_chunk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Attempt to tangle an undefined Chunk, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="n">aTangler</span><span class="o">.</span><span class="n">reference_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">aTangler</span><span class="o">.</span><span class="n">addIndent</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aTangler</span><span class="o">.</span><span class="n">fragment</span><span class="p">))</span>
        <span class="n">aTangler</span><span class="o">.</span><span class="n">fragment</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunk_list</span><span class="p">:</span>
            <span class="c1"># TODO: if chunk.indent is not None: do a setIndent before tangling.</span>
            <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">chunk</span><span class="o">.</span><span class="n">commands</span><span class="p">:</span>
                <span class="n">command</span><span class="o">.</span><span class="n">tangle</span><span class="p">(</span><span class="n">aTangler</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="n">aTangler</span><span class="o">.</span><span class="n">clrIndent</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(name=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2">, location=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="si">!r}</span><span class="s2">)&quot;</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>The ReferenceCommand Class (17)</em>.
Used by     → <a class="reference internal" href="#command-class-hierarchy-used-to-describe-individual-commands-in-a-chunk-10">Command class hierarchy – used to describe individual commands in a chunk (10)</a>.</p>
</div>
</section>
<section id="the-xrefcommand-classes">
<h5><a class="toc-backref" href="#id55" role="doc-backlink">The XrefCommand Classes</a><a class="headerlink" href="#the-xrefcommand-classes" title="Link to this heading">¶</a></h5>
<p>The <code class="docutils literal notranslate"><span class="pre">XRefCommand</span></code> classes describes a <code class="docutils literal notranslate"><span class="pre">&#64;f</span></code>, <code class="docutils literal notranslate"><span class="pre">&#64;m</span></code>, and <code class="docutils literal notranslate"><span class="pre">&#64;u</span></code> constructs inside a chunk.
These are <strong>not</strong> Tangled; they’re only woven.</p>
<p>Each offers a unique property that can be used by the template rending to  get data about the WEB content.</p>
<p class="rubric" id="the-xrefcommand-subclasses-files-macros-and-user-names-18">The XrefCommand Subclasses – files, macros, and user names (18) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FileXrefCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The ``@f`` command.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">files</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;OutputChunk&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">Web</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="p">())</span><span class="o">.</span><span class="n">files</span>

    <span class="k">def</span> <span class="nf">tangle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aTangler</span><span class="p">:</span> <span class="s2">&quot;Tangler&quot;</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s1">&#39;Illegal tangling of a cross reference command.&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MacroXrefCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The ``@m`` command.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">macros</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">SimpleNamespace</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">Web</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="p">())</span><span class="o">.</span><span class="n">macros</span>

    <span class="k">def</span> <span class="nf">tangle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aTangler</span><span class="p">:</span> <span class="s2">&quot;Tangler&quot;</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s1">&#39;Illegal tangling of a cross reference command.&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">UserIdXrefCommand</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The ``@u`` command.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">userids</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">SimpleNamespace</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">Web</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">web</span><span class="p">())</span><span class="o">.</span><span class="n">userids</span>

    <span class="k">def</span> <span class="nf">tangle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aTangler</span><span class="p">:</span> <span class="s2">&quot;Tangler&quot;</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s1">&#39;Illegal tangling of a cross reference command.&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>The XrefCommand Subclasses – files, macros, and user names (18)</em>.
Used by     → <a class="reference internal" href="#command-class-hierarchy-used-to-describe-individual-commands-in-a-chunk-10">Command class hierarchy – used to describe individual commands in a chunk (10)</a>.</p>
</div>
</section>
</section>
</section>
<section id="output-serialization">
<h3><a class="toc-backref" href="#id56" role="doc-backlink">Output Serialization</a><a class="headerlink" href="#output-serialization" title="Link to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">Emitter</span></code> class hierarchy writes the output from the source <code class="docutils literal notranslate"><span class="pre">Web</span></code> instance.
An <code class="docutils literal notranslate"><span class="pre">Emitter</span></code> instance is responsible for control of an output file format.
This includes the necessary file naming, opening, writing and closing operations.</p>
<p class="plantuml">
<img src="_images/plantuml-5c4f75552d0f17db0e1a31509dcbf1aba1fcdae0.png" alt="abstract class Emitter {
    output: Path
    emit(Web)
}

class Web
Emitter ..&gt; Web

class Weaver
Emitter &lt;|-- Weaver

class Tangler
Emitter &lt;|-- Tangler
class TanglerMake
Tangler &lt;|-- TanglerMake

package jinja {
    class Environment
}

Weaver --&gt; Environment

object template

Weaver *-- template
Environment --&gt; template"/>
</p>
<p>Here’s how the definitions are provided in the application.
The two reference class definitions are used by by the <code class="docutils literal notranslate"><span class="pre">Emitter</span></code> class, and needs to be defined first.
We’ll look at them later, since they’re a tiny strategy change in how cross-references
are displayed.</p>
<p class="rubric" id="base-class-definitions-19">Base Class Definitions (19) +=</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span>→ `Emitter base class (21)`_

→ `Weaver Subclass -- Uses Jinja templates to weave documentation (22)`_

→ `Tangler Subclass -- emits the output files (29)`_

→ `TanglerMake Subclass -- extends Tangler to avoid touching files that didn&#39;t change (33)`_
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Base Class Definitions (19)</em>.
Used by     → <a class="reference internal" href="#pyweb-py-80">pyweb.py (80)</a>.</p>
</div>
<p class="rubric" id="imports-20">Imports (20) +=</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">ChainMap</span>
<span class="kn">from</span> <span class="nn">textwrap</span> <span class="kn">import</span> <span class="n">dedent</span><span class="p">,</span> <span class="n">shorten</span>
<span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">Environment</span><span class="p">,</span> <span class="n">DictLoader</span><span class="p">,</span> <span class="n">select_autoescape</span>
<span class="kn">import</span> <span class="nn">jinja2.nodes</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Imports (20)</em>.
Used by     → <a class="reference internal" href="#pyweb-py-80">pyweb.py (80)</a>.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Emitter</span></code> class is an abstraction, used to check the consistency
of the subclasses.</p>
<p class="rubric" id="emitter-base-class-21">Emitter base class (21) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Emitter</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_indent</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;indent.&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">web</span><span class="p">:</span> <span class="n">Web</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Emitter base class (21)</em>.
Used by     → <a class="reference internal" href="#base-class-definitions-19">Base Class Definitions (19)</a>.</p>
</div>
<section id="the-weaver-subclass">
<h4><a class="toc-backref" href="#id57" role="doc-backlink">The Weaver Subclass</a><a class="headerlink" href="#the-weaver-subclass" title="Link to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">Weaver</span></code> is a <strong>Facade</strong> that wraps Jinja template processing.
The job is to build the necessary environment, locate the templates,
and then evaluate the template’s <code class="docutils literal notranslate"><span class="pre">generate()</span></code> method to fill the values
into the template to create the woven document.</p>
<p>A single <code class="docutils literal notranslate"><span class="pre">base_weaver_template</span></code> template contains the essential structure of the woven document.
It’s a series of chunks.
Code chunks get a wrapper and quoting rules, text chunks are emitted unchanged.
Each chunk contains a sequence of commands.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">base_weaver_template</span></code> relies on a number of macros that customize the output by injecting repetitive boiler-plate markup constructs around code blocks and references between code blocks.</p>
<p>Each markup language requires unique macros.
A default set of macros will yield a readable document.
The macros can be customized via the configuration file and via <code class="docutils literal notranslate"><span class="pre">&#64;t</span></code> commands in the WEB file.
This permits some customization of the markup.</p>
<p>As an example, consider RST-formatted output. There are two variants on the way containers and classes work:</p>
<ul class="simple">
<li><p>When used with Sphinx, the “small” caption at the end of a code block uses <code class="docutils literal notranslate"><span class="pre">..</span>&#160; <span class="pre">rst-class::</span> <span class="pre">small</span></code>.</p></li>
<li><p>When used without Sphinx, i.e., native docutils, the the “small” caption at the end of a code block can use <code class="docutils literal notranslate"><span class="pre">..</span>&#160; <span class="pre">class::</span> <span class="pre">small</span></code>.</p></li>
</ul>
<p>This distinction is a minor change to the template being used.
The question is how to make that distinction in the weaver? There are several choices:</p>
<ul class="simple">
<li><p>Use subclasses of <code class="xref py py-class docutils literal notranslate"><span class="pre">Weaver</span></code> for this.</p></li>
<li><p>Note that templates are found by string name in the <code class="docutils literal notranslate"><span class="pre">template_name_map</span></code> within the <code class="xref py py-class docutils literal notranslate"><span class="pre">Weaver</span></code> class.
The <code class="docutils literal notranslate"><span class="pre">--weaver</span></code> command-line option provides a string (e.g., <code class="docutils literal notranslate"><span class="pre">rst</span></code> or <code class="docutils literal notranslate"><span class="pre">html</span></code>) used to build a key into the template map.
We can extend this string with options and features.</p></li>
</ul>
<p>Using the <code class="docutils literal notranslate"><span class="pre">--weaver</span></code> command-line option allows us to provide an expanded set of names for RST processing.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">-w</span> <span class="pre">rst</span></code> is the baseline, Sphinx option.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-w</span> <span class="pre">rst-sphinx</span></code> is an alias for <code class="docutils literal notranslate"><span class="pre">rst</span></code>. The dictionary key points to the same templates as <code class="docutils literal notranslate"><span class="pre">rst</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-w</span> <span class="pre">rst-nosphinx</span></code> is the “pure-docutils” version, using <code class="docutils literal notranslate"><span class="pre">..</span> <span class="pre">class::</span></code> instead of <code class="docutils literal notranslate"><span class="pre">..</span> <span class="pre">rst-class::</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-w</span> <span class="pre">rst-docutils</span></code> is an alias for the <code class="docutils literal notranslate"><span class="pre">rst-nosphinx</span></code> option.</p></li>
</ul>
<aside class="sidebar">
<p>While this works out nicely, it turns out that the <code class="docutils literal notranslate"><span class="pre">..</span>&#160; <span class="pre">container::</span> <span class="pre">small</span></code> is, perhaps, a better markup that <code class="docutils literal notranslate"><span class="pre">..</span>&#160; <span class="pre">class::</span> <span class="pre">small</span></code>.
This work in both docutils <strong>and</strong> Sphinx.</p>
</aside>
<p>To match user expectations <code class="docutils literal notranslate"><span class="pre">template_name_map</span></code> must have a number of markup-related names.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">markup</span></code>. A 1-tuple with the default list.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">markup-option</span></code>. A 2-tuple with the default list and an override list that extends or customizes the defaults.</p></li>
</ul>
<p>As noted above, there will be aliases in the markup-option category to provide alternative names for feature sets.</p>
<p class="rubric" id="weaver-subclass-uses-jinja-templates-to-weave-documentation-22">Weaver Subclass – Uses Jinja templates to weave documentation (22) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span># Template Definitions

→ `Quote Rules Base Class (24)`_

→ `Debug Macros -- these display debugging information (25)`_

→ `RST Macros -- the default weave output (26)`_

→ `HTML Macros -- emit HTML weave output (27)`_

→ `LaTeX Macros -- emit LaTeX weave output (28)`_

→ `Common base template -- this is used for ALL weaving (23)`_

class Weaver(Emitter):

    def __init__(self, output: Path = Path.cwd()) -&gt; None:
        super().__init__(output)
        #: map markup name to macros in priority order: override, base
        self.template_name_map = {
            &quot;debug&quot;: (debug_macros,),
            &quot;rst&quot;: (rst_macros,),
            &quot;html&quot;: (html_macros,),
            &quot;tex&quot;: (tex_macros,),
            &quot;latex&quot;: (tex_macros,),

            &quot;rst-sphinx&quot;: (rst_macros,),
            &quot;rst-nosphinx&quot;: (rst_docutils_macros, rst_macros,),
            &quot;rst-docutils&quot;: (rst_docutils_macros, rst_macros,),

            &quot;tex-verbatim&quot;: (tex_macros,),
            &quot;tex-minted&quot;: (tex_minted_macros, tex_macros),
            &quot;latex-verbatim&quot;: (tex_macros,),
            &quot;latex-minted&quot;: (tex_minted_macros, tex_macros),
        }

        #: map markup name to quote rules.
        self.quote_rules = {
        &quot;debug&quot;: debug_quote_rules,
        &quot;rst&quot;: rst_quote_rules,
        &quot;rst-sphinx&quot;: rst_quote_rules,
        &quot;rst-nosphinx&quot;: rst_quote_rules,
        &quot;rst-docutils&quot;: rst_quote_rules,
        &quot;html&quot;: html_quote_rules,
        &quot;tex&quot;: latex_quote_rules,
        &quot;tex-verbatim&quot;: latex_quote_rules,
        &quot;tex-minted&quot;: latex_minted_quote_rules,
        &quot;latex&quot;: latex_quote_rules,
        &quot;latex-verbatim&quot;: latex_quote_rules,
        &quot;latex-minted&quot;: latex_minted_quote_rules,
        }

        #: macros found in the config file.
        self.config_macros = []

        #: final mapping from macro name to definition.
        self.template_map = {}

        #: Working JINJA environment.
        self.env = Environment(
            autoescape=select_autoescape()
        )

        #: Summary
        self.linesWritten = 0

    def set_markup(self, markup: str = &quot;rst&quot;) -&gt; &quot;Weaver&quot;:
        self.markup = markup
        return self

    def emit(self, web: Web) -&gt; None:
        &quot;&quot;&quot;Open output files. Then generate woven text.&quot;&quot;&quot;
        self.target_path = (self.output / web.web_path.name).with_suffix(f&quot;.{self.markup}&quot;)
        self.logger.info(&quot;Weaving %s using %s markup&quot;, self.target_path, self.markup)
        with self.target_path.open(&#39;w&#39;) as target_file:
            for text in self.generate_text(web):
                self.linesWritten += text.count(&quot;\n&quot;)
                target_file.write(text)

    def macro_name_iter(self, source: list[str]) -&gt; Iterator[tuple[str, str]]:
        for m in source:
            ast = self.env.parse(m)
            for child in ast.iter_child_nodes():
                match child:
                    case jinja2.nodes.Macro() as macro:
                        yield macro.name, m
                    case _:
                        raise RuntimeError(f&quot;improper macro text {type(child)!s}: {child!r}&quot;)

    def configure_macros(self, web: Web) -&gt; None:
        if self.template_map: return
        self.env.filters |= {
            &quot;quote_rules&quot;: self.quote_rules[self.markup]
        }
        ordered_definitions = (
            # list(web_template_iter())
            [self.config_macros] +
            list(self.template_name_map[self.markup])
        )
        ordered_macro_name_maps = [
            dict(self.macro_name_iter(priority))
            for priority in ordered_definitions
        ]
        all_macros = ChainMap(*ordered_macro_name_maps)
        macro_template = &quot;\n\n&quot;.join(
            all_macros[k] for k in all_macros.keys()
        )
        self.template_map = {
            &#39;base_weaver_template&#39;: base_weaver_template,
            &#39;macros&#39;: macro_template
        }
        self.env.loader=DictLoader(self.template_map)

    def generate_text(self, web: Web) -&gt; Iterator[str]:
        self.configure_macros(web)
        macros = self.env.get_template(f&quot;macros&quot;)
        base_weaver_template = self.env.get_template(&quot;base_weaver_template&quot;)
        return base_weaver_template.generate(web=web, macros=macros)
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Weaver Subclass – Uses Jinja templates to weave documentation (22)</em>.
Used by     → <a class="reference internal" href="#base-class-definitions-19">Base Class Definitions (19)</a>.</p>
</div>
<p>Within the Jinja framework, the macro definitions amount to <strong>Strategy</strong> plug-ins to the weaver.
Each set of macro definitions is unique for a particular flavor of markup.
The strategies include the quoting function used to escape markup characters.</p>
<p>A generic “base_weaver_template” template relies on macros.
The macro definitions come from four sources:</p>
<ol class="arabic simple">
<li><p>Application defaults, defined here.</p></li>
<li><p>Application overrides to the defaults, also defined here.</p></li>
<li><p>Configured overrides from <code class="docutils literal notranslate"><span class="pre">pyweb.toml</span></code>.</p></li>
<li><p>Document overrides from the <code class="docutils literal notranslate"><span class="pre">.w</span></code> file in <code class="docutils literal notranslate"><span class="pre">&#64;t</span> <span class="pre">name</span> <span class="pre">&#64;{...&#64;}</span></code> commands.</p></li>
</ol>
<p>The document overrides are the highest priority.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Weaver</span></code> class must populate the environment very late in the process.
This must be done <strong>after</strong> the configuration files are read and <strong>after</strong> the web has been parsed to locate template definitions.
We can then pick the templates to put into a <code class="docutils literal notranslate"><span class="pre">DictLoader</span></code> to support the standard weaving structure.</p>
<p>Additionally, quoting rules apply to some template languages.
The idea is that a few characters must be escaped for proper presentation in the code sample sections.</p>
<section id="common-base-template">
<h5><a class="toc-backref" href="#id58" role="doc-backlink">Common Base Template</a><a class="headerlink" href="#common-base-template" title="Link to this heading">¶</a></h5>
<p>The common base template expands each chunk and each command in order.
This involves some special case processing for <code class="docutils literal notranslate"><span class="pre">OutputChunk</span></code> and <code class="docutils literal notranslate"><span class="pre">NamedChunk</span></code>
which have a “wrapper” woven around the chunk’s sequence of commands so that it’s typeset in a distinctive style.</p>
<p>The base template relies on a number of individual macros:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">text(command)</span></code>.
Emits a block of text – this should do <em>nothing</em> with the text.
The author’s original markup passes through untouched.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">begin_code(chunk)</span></code>.
Starts a block of code, either <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> or <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">code(command)</span></code>.
Emits a block fo code.
This may require escapes for special characters that would break the markup being used.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ref(command)</span></code>.
Emits a reference to a named block of code.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">end_code(chunk)</span></code>.
Ends a block of code.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">file_xref(command)</span></code>.
Emit the full <code class="docutils literal notranslate"><span class="pre">&#64;f</span></code> output, usually some kind of definition list.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">macro_xref(command)</span></code>.
Emit the full <code class="docutils literal notranslate"><span class="pre">&#64;m</span></code> output, usually some kind of definition list.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">userid_xref(command)</span></code>.
Emit the full <code class="docutils literal notranslate"><span class="pre">&#64;u</span></code> output, usually some kind of definition list.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">ref()</span></code> macro can also be used in the XREF output macros. It can also be used in the <code class="docutils literal notranslate"><span class="pre">end_code()</span></code> macro.
After a block of code, some tools (like Interscript) will show where the block was referenced.
The point of using the <code class="docutils literal notranslate"><span class="pre">ref()</span></code> macro in multiple places is to make all of them look identical.</p>
<p>There are a some optional formatting considerations.
These include cross-references as well as the variety of <code class="docutils literal notranslate"><span class="pre">begin_code()</span></code> options.</p>
<p>There are four styles for the “referencedBy” information in a <code class="docutils literal notranslate"><span class="pre">Chunk</span></code>.</p>
<ul class="simple">
<li><p>Nothing.</p></li>
<li><p>The immediate <code class="docutils literal notranslate"><span class="pre">&#64;&lt;name&#64;&gt;</span></code> Chunk.</p></li>
<li><p>The entire transitive sequence of parents for the <code class="docutils literal notranslate"><span class="pre">&#64;&lt;name&#64;&gt;</span></code> Chunk. There
are two forms for this:</p>
<ul>
<li><p>Top-down path. <code class="docutils literal notranslate"><span class="pre">→</span> <span class="pre">Named</span> <span class="pre">(1)</span> <span class="pre">/</span> <span class="pre">→</span> <span class="pre">Sub-Named</span> <span class="pre">(2)</span> <span class="pre">/</span> <span class="pre">→</span> <span class="pre">Sub-Sub-Named</span> <span class="pre">(3)</span></code>.</p></li>
<li><p>Bottom-up path.  <code class="docutils literal notranslate"><span class="pre">→</span> <span class="pre">Sub-Sub-Named</span> <span class="pre">(3)</span> <span class="pre">∈</span> <span class="pre">→</span> <span class="pre">Sub-Named</span> <span class="pre">(2)</span> <span class="pre">∈</span> <span class="pre">→</span> <span class="pre">Named</span> <span class="pre">(1)</span></code>.</p></li>
</ul>
</li>
</ul>
<p>These require four distinct versions of the <code class="docutils literal notranslate"><span class="pre">end_code()</span></code> macro.
This macro uses the <code class="docutils literal notranslate"><span class="pre">transitive_referencedBy</span></code> property of a <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> producing a sequence of <code class="docutils literal notranslate"><span class="pre">ref()</span></code> values.</p>
<p>(Note the <code class="docutils literal notranslate"><span class="pre">&amp;rarr;</span></code> characters is a preface characters for a link.)</p>
<p>The <code class="docutils literal notranslate"><span class="pre">begin_code()</span></code> and <code class="docutils literal notranslate"><span class="pre">end_code()</span></code> macros will bracket a code block.
In LaTeX, there are a number of ways to bracket a literal block, including <code class="docutils literal notranslate"><span class="pre">Verbatim</span></code>, <code class="docutils literal notranslate"><span class="pre">lstlisting</span></code>, <code class="docutils literal notranslate"><span class="pre">minted</span></code>, or a custom-defined <code class="docutils literal notranslate"><span class="pre">TColorBox</span></code>.
The <code class="docutils literal notranslate"><span class="pre">begin_code()</span></code> and <code class="docutils literal notranslate"><span class="pre">end_code()</span></code> macros must match, of course.
There may be distinct parameters, also, to provide additional parameters to the chunk.</p>
<p class="rubric" id="common-base-template-this-is-used-for-all-weaving-23">Common base template – this is used for ALL weaving (23) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">base_weaver_template</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">    {</span><span class="si">%- f</span><span class="s2">rom macros import text, begin_code, code, ref, end_code, file_xref, macro_xref, userid_xref -%}</span>
<span class="s2">    {</span><span class="si">% f</span><span class="s2">or chunk in web.chunks -%}</span>
<span class="s2">        {</span><span class="si">%- i</span><span class="s2">f chunk.type_is(&#39;OutputChunk&#39;) or chunk.type_is(&#39;NamedChunk&#39;) -%}</span>
<span class="s2">            {</span><span class="si">% i</span><span class="s2">f chunk.weave -%}</span>
<span class="s2">                {{begin_code(chunk)}}</span>
<span class="s2">                {</span><span class="si">%- f</span><span class="s2">or command in chunk.commands -%}</span>
<span class="s2">                    {</span><span class="si">%- i</span><span class="s2">f command.typeid.CodeCommand -%}{{code(command)}}</span>
<span class="s2">                    {</span><span class="si">%- e</span><span class="s2">lif command.typeid.ReferenceCommand -%}{{ref(command)}}</span>
<span class="s2">                    {</span><span class="si">%- e</span><span class="s2">ndif -%}</span>
<span class="s2">                {</span><span class="si">%- e</span><span class="s2">ndfor -%}</span>
<span class="s2">                {{end_code(chunk)}}</span>
<span class="s2">            {</span><span class="si">%- e</span><span class="s2">ndif -%}</span>
<span class="s2">        {</span><span class="si">%- e</span><span class="s2">lif chunk.type_is(&#39;Chunk&#39;) -%}</span>
<span class="s2">            {</span><span class="si">%- f</span><span class="s2">or command in chunk.commands -%}</span>
<span class="s2">                {</span><span class="si">%- i</span><span class="s2">f command.typeid.TextCommand %}{{text(command)}}</span>
<span class="s2">                {</span><span class="si">%- e</span><span class="s2">lif command.typeid.ReferenceCommand %}{{ref(command)}}</span>
<span class="s2">                {</span><span class="si">%- e</span><span class="s2">lif command.typeid.FileXrefCommand %}{{file_xref(command)}}</span>
<span class="s2">                {</span><span class="si">%- e</span><span class="s2">lif command.typeid.MacroXrefCommand %}{{macro_xref(command)}}</span>
<span class="s2">                {</span><span class="si">%- e</span><span class="s2">lif command.typeid.UserIdXrefCommand %}{{userid_xref(command)}}</span>
<span class="s2">                {</span><span class="si">%- e</span><span class="s2">ndif -%}</span>
<span class="s2">            {</span><span class="si">%- e</span><span class="s2">ndfor -%}</span>
<span class="s2">        {</span><span class="si">%- e</span><span class="s2">ndif -%}</span>
<span class="s2">    {</span><span class="si">%- e</span><span class="s2">ndfor %}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Common base template – this is used for ALL weaving (23)</em>.
Used by     → <a class="reference internal" href="#weaver-subclass-uses-jinja-templates-to-weave-documentation-22">Weaver Subclass – Uses Jinja templates to weave documentation (22)</a>.</p>
</div>
<p>The QuoteRule class lets us define a quote rule as a callable object.
The result of <code class="docutils literal notranslate"><span class="pre">qr</span> <span class="pre">=</span> <span class="pre">QuoteRules((&quot;this&quot;,</span> <span class="pre">&quot;that&quot;))</span></code> is a callable object, <code class="docutils literal notranslate"><span class="pre">qr()</span></code> that performs the replacement.</p>
<p class="rubric" id="quote-rules-base-class-24">Quote Rules Base Class (24) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">QuoteRules</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">mapping</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">mapping</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">clean</span> <span class="o">=</span> <span class="n">text</span>
        <span class="k">for</span> <span class="n">from_</span><span class="p">,</span> <span class="n">to_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">:</span>
            <span class="n">clean</span> <span class="o">=</span> <span class="n">clean</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">from_</span><span class="p">,</span> <span class="n">to_</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">clean</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Quote Rules Base Class (24)</em>.
Used by     → <a class="reference internal" href="#weaver-subclass-uses-jinja-templates-to-weave-documentation-22">Weaver Subclass – Uses Jinja templates to weave documentation (22)</a>.</p>
</div>
</section>
<section id="debug-macros">
<h5><a class="toc-backref" href="#id59" role="doc-backlink">Debug Macros</a><a class="headerlink" href="#debug-macros" title="Link to this heading">¶</a></h5>
<p>The debug macros don’t use a quote rule with individual replacements. In this case, the quote rule is the built-in <code class="docutils literal notranslate"><span class="pre">repr()</span></code> function.</p>
<p class="rubric" id="debug-macros-these-display-debugging-information-25">Debug Macros – these display debugging information (25) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">debug_quote_rules</span> <span class="o">=</span> <span class="nb">repr</span>

<span class="n">debug_macros</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">        {%- macro text(command) -%}</span>
<span class="s2">        text: {{command}}</span>
<span class="s2">        {</span><span class="si">%- e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">        {%- macro begin_code(chunk) %}</span>
<span class="s2">        begin_code: {{chunk}}</span>
<span class="s2">        {</span><span class="si">%- e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">        {%- macro code(command) %}</span>
<span class="s2">        code: {{command}}</span>
<span class="s2">        {</span><span class="si">%- e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">        {%- macro ref(id) %}</span>
<span class="s2">        ref: {{id}}</span>
<span class="s2">        {</span><span class="si">%- e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">        {%- macro end_code(chunk) %}</span>
<span class="s2">        end_code: {{chunk}}</span>
<span class="s2">        {</span><span class="si">% e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">        {%- macro file_xref(command) -%}</span>
<span class="s2">        file_xref {{command.files}}</span>
<span class="s2">        {</span><span class="si">%- e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">        {%- macro macro_xref(command) -%}</span>
<span class="s2">        macro_xref {{command.macros}}</span>
<span class="s2">        {</span><span class="si">%- e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">        {%- macro userid_xref(command) -%}</span>
<span class="s2">        userid_xref {{command.userids}}</span>
<span class="s2">        {</span><span class="si">%- e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="p">]</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Debug Macros – these display debugging information (25)</em>.
Used by     → <a class="reference internal" href="#weaver-subclass-uses-jinja-templates-to-weave-documentation-22">Weaver Subclass – Uses Jinja templates to weave documentation (22)</a>.</p>
</div>
</section>
<section id="rst-macros">
<h5><a class="toc-backref" href="#id60" role="doc-backlink">RST Macros</a><a class="headerlink" href="#rst-macros" title="Link to this heading">¶</a></h5>
<p>The RST Macros produce ReStructuredText for the various web commands.
Note that code lines must be indented when using this markup.</p>
<p>There is a base set of template macros.
The <code class="docutils literal notranslate"><span class="pre">rst_weaver_template</span></code> variable defines the default macros.
The <code class="docutils literal notranslate"><span class="pre">rst-sphinx</span></code> key makes these defaults active.</p>
<p>These can be overridden by macros defined in
the <code class="docutils literal notranslate"><span class="pre">rst_nosphinx_template</span></code> variable.
This defines  updates to the base templates focused on <strong>docutils</strong>.
The <code class="docutils literal notranslate"><span class="pre">rst-nosphinx</span></code> and <code class="docutils literal notranslate"><span class="pre">rst-docutils</span></code> keys provides updates to the base temples focused on docutils.</p>
<p class="rubric" id="rst-macros-the-default-weave-output-26">RST Macros – the default weave output (26) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rst_quote_rules</span> <span class="o">=</span> <span class="nb">str</span>

 <span class="c1"># Old rules, used with ``..  parsed-literal::``</span>
 <span class="c1">#rst_quote_rules = QuoteRules(</span>
 <span class="c1">#       (&#39;\\&#39;, r&#39;\\&#39;), # Must be first.</span>
 <span class="c1">#       (&#39;`&#39;, r&#39;\`&#39;),</span>
 <span class="c1">#       (&#39;_&#39;, r&#39;\_&#39;),</span>
 <span class="c1">#       (&#39;*&#39;, r&#39;\*&#39;),</span>
 <span class="c1">#       (&#39;|&#39;, r&#39;\|&#39;),</span>
 <span class="c1">#   )</span>

<span class="n">rst_macros</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        {%- macro text(command) -%}</span>
<span class="s2">        {{command.text}}</span>
<span class="s2">        {</span><span class="si">%- e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">        {%- macro begin_code(chunk) %}</span>
<span class="s2">        ..  _`{{chunk.full_name or chunk.name}} ({{chunk.seq}})`:</span>
<span class="s2">        ..  rubric:: {{chunk.full_name or chunk.name}} ({{chunk.seq}}) {</span><span class="si">% i</span><span class="s2">f chunk.initial %}={</span><span class="si">% e</span><span class="s2">lse %}+={</span><span class="si">% e</span><span class="s2">ndif %}</span>
<span class="s2">        ..  code-block::</span>
<span class="s2">            :class: code</span>

<span class="s2">        {</span><span class="si">% e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">        {# For RST, each line must be indented. #}</span>
<span class="s2">        {%- macro code(command) %}{</span><span class="si">% f</span><span class="s2">or line in command.text.splitlines() %}    {{line | quote_rules}}</span>
<span class="s2">        {</span><span class="si">% e</span><span class="s2">ndfor -%}{</span><span class="si">% e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">        {%- macro ref(id) %}    </span><span class="se">\N{RIGHTWARDS ARROW}</span><span class="s2"> `{{id.full_name or id.name}} ({{id.seq}})`_{</span><span class="si">% e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
   <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">        {%- macro end_code(chunk) %}</span>
<span class="s2">        ..</span>

<span class="s2">        ..  container:: small</span>

<span class="s2">            </span><span class="se">\N{END OF PROOF}</span><span class="s2"> *{{chunk.full_name or chunk.name}} ({{chunk.seq}})*.</span>
<span class="s2">            {</span><span class="si">% i</span><span class="s2">f chunk.referencedBy %}Used by {{ref(chunk.referencedBy)}}.{</span><span class="si">% e</span><span class="s2">ndif %}</span>

<span class="s2">        {</span><span class="si">% e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">        {%- macro file_xref(command) -%}</span>
<span class="s2">        {</span><span class="si">% f</span><span class="s2">or file in command.files -%}</span>
<span class="s2">        :{{file.name}}:</span>
<span class="s2">            </span><span class="se">\N{RIGHTWARDS ARROW}</span><span class="s2"> `{{file.name}} ({{file.seq}})`_</span>
<span class="s2">        {</span><span class="si">%- e</span><span class="s2">ndfor %}</span>
<span class="s2">        {</span><span class="si">%- e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">        {%- macro macro_xref(command) -%}</span>
<span class="s2">        {</span><span class="si">% f</span><span class="s2">or macro in command.macros -%}</span>
<span class="s2">        :{{macro.full_name}}:</span>
<span class="s2">            {</span><span class="si">% f</span><span class="s2">or d in macro.def_list -%}</span><span class="se">\N{RIGHTWARDS ARROW}</span><span class="s2"> `{{d.full_name or d.name}} ({{d.seq}})`_{</span><span class="si">% i</span><span class="s2">f loop.last %}{</span><span class="si">% e</span><span class="s2">lse %}, {</span><span class="si">% e</span><span class="s2">ndif %}{</span><span class="si">%- e</span><span class="s2">ndfor %}</span>

<span class="s2">        {</span><span class="si">% e</span><span class="s2">ndfor %}</span>
<span class="s2">        {</span><span class="si">%- e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">        {%- macro userid_xref(command) -%}</span>
<span class="s2">        {</span><span class="si">% f</span><span class="s2">or userid in command.userids -%}</span>
<span class="s2">        :{{userid.userid}}:</span>
<span class="s2">            {</span><span class="si">% f</span><span class="s2">or r in userid.ref_list -%}</span><span class="se">\N{RIGHTWARDS ARROW}</span><span class="s2"> `{{r.full_name or r.name}} ({{r.seq}})`_{</span><span class="si">% i</span><span class="s2">f loop.last %}{</span><span class="si">% e</span><span class="s2">lse %}, {</span><span class="si">% e</span><span class="s2">ndif %}{</span><span class="si">%- e</span><span class="s2">ndfor %}</span>

<span class="s2">        {</span><span class="si">% e</span><span class="s2">ndfor %}</span>
<span class="s2">        {</span><span class="si">%- e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="p">]</span>

<span class="n">rst_docutils_macros</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">        {%- macro end_code(chunk) %}</span>
<span class="s2">        ..</span>

<span class="s2">        ..  class:: small</span>

<span class="s2">            </span><span class="se">\N{END OF PROOF}</span><span class="s2"> *{{chunk.full_name or chunk.name}} ({{chunk.seq}})*</span>

<span class="s2">        {</span><span class="si">% e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="p">]</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>RST Macros – the default weave output (26)</em>.
Used by     → <a class="reference internal" href="#weaver-subclass-uses-jinja-templates-to-weave-documentation-22">Weaver Subclass – Uses Jinja templates to weave documentation (22)</a>.</p>
</div>
</section>
<section id="html-macros">
<h5><a class="toc-backref" href="#id61" role="doc-backlink">HTML Macros</a><a class="headerlink" href="#html-macros" title="Link to this heading">¶</a></h5>
<p>The HTML macros use a relatively simple markup, avoiding any CSS names.
A slightly more flexible approach might be to name specific CSS styles, and provide generic definitions for those styles.
This would make it easier to tailor HTML output via CSS changes, avoiding any HTML modifications.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">ref()</span></code> macro injects <code class="docutils literal notranslate"><span class="pre">&amp;rarr;</span></code> characters into the chunk references as an attempt to make it clear they are links.</p>
<p class="rubric" id="html-macros-emit-html-weave-output-27">HTML Macros – emit HTML weave output (27) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">html_quote_rules</span> <span class="o">=</span> <span class="n">QuoteRules</span><span class="p">(</span>
        <span class="p">(</span><span class="s2">&quot;&amp;&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;amp;&quot;</span><span class="p">),</span>  <span class="c1"># Must be first</span>
        <span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;lt;&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;gt;&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s2">&quot;&amp;quot;&quot;</span><span class="p">),</span>  <span class="c1"># Only applies inside tags...</span>
    <span class="p">)</span>

<span class="n">html_macros</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">    {%- macro text(command) -%}</span>
<span class="s2">    {{command.text}}</span>
<span class="s2">    {</span><span class="si">%- e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">    {%- macro begin_code(chunk) %}</span>
<span class="s2">    &lt;a name=&quot;pyweb_{{chunk.seq}}&quot;&gt;&lt;/a&gt;</span>
<span class="s2">    &lt;!--line number {{chunk.location}}--&gt;</span>
<span class="s2">    &lt;p&gt;&lt;em&gt;{{chunk.full_name or chunk.name}} ({{chunk.seq}})&lt;/em&gt; {</span><span class="si">% i</span><span class="s2">f chunk.initial %}={</span><span class="si">% e</span><span class="s2">lse %}+={</span><span class="si">% e</span><span class="s2">ndif %}&lt;/p&gt;</span>
<span class="s2">    &lt;pre&gt;&lt;code&gt;</span>
<span class="s2">    {</span><span class="si">%- e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">    {%- macro code(command) -%}{{command.text | quote_rules}}{</span><span class="si">%- e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">    {%- macro ref(id) %}&amp;rarr;&lt;a href=&quot;#pyweb_{{id.seq}}&quot;&gt;&lt;em&gt;{{id.full_name or id.name}} ({{id.seq}})&lt;/em&gt;&lt;/a&gt;{</span><span class="si">% e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">    {%- macro end_code(chunk) %}</span>
<span class="s2">    &lt;/code&gt;&lt;/pre&gt;</span>
<span class="s2">    &lt;p&gt;&amp;#8718; &lt;em&gt;{{chunk.full_name or chunk.name}} ({{chunk.seq}})&lt;/em&gt;.</span>
<span class="s2">    {</span><span class="si">% i</span><span class="s2">f chunk.referencedBy %}Used by {{ref(chunk.referencedBy)}}.{</span><span class="si">% e</span><span class="s2">ndif %}</span>
<span class="s2">    &lt;/p&gt;</span>
<span class="s2">    {</span><span class="si">% e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">    {%- macro file_xref(command) %}</span>
<span class="s2">    &lt;dl&gt;</span>
<span class="s2">    {</span><span class="si">% f</span><span class="s2">or file in command.files -%}</span>
<span class="s2">      &lt;dt&gt;{{file.name}}&lt;/dt&gt;&lt;dd&gt;{{ref(file)}}&lt;/dd&gt;</span>
<span class="s2">    {</span><span class="si">%- e</span><span class="s2">ndfor %}</span>
<span class="s2">    &lt;/dl&gt;</span>
<span class="s2">    {</span><span class="si">% e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">    {%- macro macro_xref(command) %}</span>
<span class="s2">    &lt;dl&gt;</span>
<span class="s2">    {</span><span class="si">% f</span><span class="s2">or macro in command.macros -%}</span>
<span class="s2">      &lt;dt&gt;{{macro.full_name}}&lt;dt&gt;</span>
<span class="s2">      &lt;dd&gt;{</span><span class="si">% f</span><span class="s2">or d in macro.def_list -%}{{ref(d)}}{</span><span class="si">% i</span><span class="s2">f loop.last %}{</span><span class="si">% e</span><span class="s2">lse %}, {</span><span class="si">% e</span><span class="s2">ndif %}{</span><span class="si">%- e</span><span class="s2">ndfor %}&lt;/dd&gt;</span>
<span class="s2">    {</span><span class="si">% e</span><span class="s2">ndfor %}</span>
<span class="s2">    &lt;/dl&gt;</span>
<span class="s2">    {</span><span class="si">% e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">    {%- macro userid_xref(command) %}</span>
<span class="s2">    &lt;dl&gt;</span>
<span class="s2">    {</span><span class="si">% f</span><span class="s2">or userid in command.userids -%}</span>
<span class="s2">      &lt;dt&gt;{{userid.userid}}&lt;/dt&gt;</span>
<span class="s2">      &lt;dd&gt;{</span><span class="si">% f</span><span class="s2">or r in userid.ref_list -%}{{ref(r)}}{</span><span class="si">% i</span><span class="s2">f loop.last %}{</span><span class="si">% e</span><span class="s2">lse %}, {</span><span class="si">% e</span><span class="s2">ndif %}{</span><span class="si">%- e</span><span class="s2">ndfor %}&lt;/dd&gt;</span>
<span class="s2">    {</span><span class="si">% e</span><span class="s2">ndfor %}</span>
<span class="s2">    &lt;/dl&gt;</span>
<span class="s2">    {</span><span class="si">% e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="p">]</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>HTML Macros – emit HTML weave output (27)</em>.
Used by     → <a class="reference internal" href="#weaver-subclass-uses-jinja-templates-to-weave-documentation-22">Weaver Subclass – Uses Jinja templates to weave documentation (22)</a>.</p>
</div>
</section>
<section id="latex-macros">
<h5><a class="toc-backref" href="#id62" role="doc-backlink">LaTeX Macros</a><a class="headerlink" href="#latex-macros" title="Link to this heading">¶</a></h5>
<p>The LaTeX macros defined here use a markup focused on using the <code class="docutils literal notranslate"><span class="pre">Verbatim</span></code> environment.
Common alternatives include <code class="docutils literal notranslate"><span class="pre">lstlistings</span></code> and <code class="docutils literal notranslate"><span class="pre">minted</span></code>.
A particular popular form uses Text Color Block (TCB) to create distinctive code formatting.</p>
<p class="rubric" id="latex-macros-emit-latex-weave-output-28">LaTeX Macros – emit LaTeX weave output (28) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">latex_quote_rules</span> <span class="o">=</span> <span class="n">QuoteRules</span><span class="p">(</span>
        <span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">end</span><span class="si">{Verbatim}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">end</span><span class="se">\\</span><span class="s2">,</span><span class="si">{Verbatim}</span><span class="s2">&quot;</span><span class="p">),</span>  <span class="c1"># Allow \end{Verbatim} in a Verbatim context</span>
        <span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">{&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">,{&quot;</span><span class="p">),</span> <span class="c1"># Prevent unexpected commands in Verbatim</span>
        <span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">$&quot;</span><span class="p">),</span> <span class="c1"># Prevent unexpected math in Verbatim</span>
    <span class="p">)</span>

<span class="n">latex_minted_quote_rules</span> <span class="o">=</span> <span class="n">QuoteRules</span><span class="p">(</span>
        <span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">end</span><span class="si">{minted}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">end</span><span class="se">\\</span><span class="s2">,</span><span class="si">{minted}</span><span class="s2">&quot;</span><span class="p">),</span>  <span class="c1"># Allow \end{minted} in a minted context</span>
    <span class="p">)</span>

<span class="n">tex_macros</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">    {%- macro text(command) -%}</span>
<span class="s2">    {{command.text}}</span>
<span class="s2">    {</span><span class="si">%- e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">    {%- macro begin_code(chunk) %}</span>
<span class="s2">    </span><span class="se">\\</span><span class="s2">label{pyweb-{{chunk.seq}}}</span>
<span class="s2">    </span><span class="se">\\</span><span class="s2">begin</span><span class="si">{flushleft}</span>
<span class="s2">    </span><span class="se">\\</span><span class="s2">textit{Code example {{chunk.full_name or chunk.name}} ({{chunk.seq}})}</span>
<span class="s2">    </span><span class="se">\\</span><span class="s2">begin</span><span class="si">{Verbatim}</span><span class="s2">[commandchars=</span><span class="se">\\\\\\</span><span class="s2">{</span><span class="se">\\</span><span class="s2">},codes={</span><span class="se">\\</span><span class="s2">catcode`$$=3</span><span class="se">\\</span><span class="s2">catcode`^=7},frame=single]</span>
<span class="s2">    {</span><span class="si">%- e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">    {%- macro code(command) -%}{{command.text | quote_rules}}{</span><span class="si">%- e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">    {%- macro ref(id) %}$$</span><span class="se">\\</span><span class="s2">rightarrow$$ Code Example {{id.full_name or id.name}} ({{id.seq}}){</span><span class="si">% e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">    {%- macro end_code(chunk) %}</span>
<span class="s2">    </span><span class="se">\\</span><span class="s2">end</span><span class="si">{Verbatim}</span>
<span class="s2">    </span><span class="se">\\</span><span class="s2">end</span><span class="si">{flushleft}</span>
<span class="s2">    {</span><span class="si">% e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">    {%- macro file_xref(command) %}</span>
<span class="s2">    </span><span class="se">\\</span><span class="s2">begin</span><span class="si">{itemize}</span>
<span class="s2">    {</span><span class="si">% f</span><span class="s2">or file in command.files -%}</span>
<span class="s2">      </span><span class="se">\\</span><span class="s2">item {{file.name}}: {{ref(file)}}</span>
<span class="s2">    {</span><span class="si">%- e</span><span class="s2">ndfor %}</span>
<span class="s2">    </span><span class="se">\\</span><span class="s2">end</span><span class="si">{itemize}</span>
<span class="s2">    {</span><span class="si">% e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">    {%- macro macro_xref(command) %}</span>
<span class="s2">    </span><span class="se">\\</span><span class="s2">begin</span><span class="si">{itemize}</span>
<span class="s2">    {</span><span class="si">% f</span><span class="s2">or macro in command.macros -%}</span>
<span class="s2">      </span><span class="se">\\</span><span class="s2">item {{macro.full_name}} </span><span class="se">\\\\</span>
<span class="s2">            {</span><span class="si">% f</span><span class="s2">or d in macro.def_list -%}{{ref(d)}}{</span><span class="si">% i</span><span class="s2">f loop.last %}{</span><span class="si">% e</span><span class="s2">lse %}, {</span><span class="si">% e</span><span class="s2">ndif %}{</span><span class="si">%- e</span><span class="s2">ndfor %}</span>
<span class="s2">    {</span><span class="si">% e</span><span class="s2">ndfor %}</span>
<span class="s2">    </span><span class="se">\\</span><span class="s2">end</span><span class="si">{itemize}</span>
<span class="s2">    {</span><span class="si">% e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">    {%- macro userid_xref(command) %}</span>
<span class="s2">    </span><span class="se">\\</span><span class="s2">begin</span><span class="si">{itemize}</span>
<span class="s2">    {</span><span class="si">% f</span><span class="s2">or userid in command.userids -%}</span>
<span class="s2">      </span><span class="se">\\</span><span class="s2">item {{userid.userid}} </span><span class="se">\\\\</span>
<span class="s2">            {</span><span class="si">% f</span><span class="s2">or r in userid.ref_list -%}{{ref(r)}}{</span><span class="si">% i</span><span class="s2">f loop.last %}{</span><span class="si">% e</span><span class="s2">lse %}, {</span><span class="si">% e</span><span class="s2">ndif %}{</span><span class="si">%- e</span><span class="s2">ndfor %}</span>
<span class="s2">    {</span><span class="si">% e</span><span class="s2">ndfor %}</span>
<span class="s2">    </span><span class="se">\\</span><span class="s2">end</span><span class="si">{itemize}</span>
<span class="s2">    {</span><span class="si">% e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="p">]</span>

<span class="n">tex_minted_macros</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">    {%- macro begin_code(chunk) %}</span>
<span class="s2">    </span><span class="se">\\</span><span class="s2">label{pyweb-{{chunk.seq}}}</span>
<span class="s2">    </span><span class="se">\\</span><span class="s2">textit{Code example {{chunk.full_name or chunk.name}} ({{chunk.seq}})}</span>
<span class="s2">    </span><span class="se">\\</span><span class="s2">begin</span><span class="si">{minted}</span><span class="s2">{{&#39;{&#39;}}{{chunk.style}}{{&#39;}&#39;}}</span>
<span class="s2">    {</span><span class="si">%- e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">    {%- macro end_code(chunk) %}</span>
<span class="s2">    </span><span class="se">\\</span><span class="s2">end</span><span class="si">{minted}</span>
<span class="s2">    {</span><span class="si">% e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
    <span class="p">]</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>LaTeX Macros – emit LaTeX weave output (28)</em>.
Used by     → <a class="reference internal" href="#weaver-subclass-uses-jinja-templates-to-weave-documentation-22">Weaver Subclass – Uses Jinja templates to weave documentation (22)</a>.</p>
</div>
</section>
</section>
<section id="the-tangler-subclasses">
<h4><a class="toc-backref" href="#id63" role="doc-backlink">The Tangler Subclasses</a><a class="headerlink" href="#the-tangler-subclasses" title="Link to this heading">¶</a></h4>
<p>Tangling is a variation on emitting that includes all the code in the order defined by the <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> file commands.
This is not necessarily the order they’re presented in the document.</p>
<p>The whole point of Weaving and Tangling is to write a document in an order that’s sensible for people to understand.
The tangled output is for compilers and run-time environments.</p>
<p>Each file is individually tangled, unrelated to the order of the source
WEB document.
The <code class="docutils literal notranslate"><span class="pre">emit()</span></code> process, therefore, iterates through all of the files defined in the WEB.</p>
<p>There’s a complex interplay between <code class="docutils literal notranslate"><span class="pre">Tangler</span></code> and <code class="docutils literal notranslate"><span class="pre">CodeCommand</span></code>
to maintain the indentations.</p>
<p class="plantuml">
<img src="_images/plantuml-bbfb0883085a6dd7ae0b50ad41ca1da1f40771c0.png" alt="participant Tangler

participant ReferenceCommand

participant Command

Tangler --&gt; ReferenceCommand : tangle()
ReferenceCommand --&gt; Tangler : get len(fragment)
ReferenceCommand --&gt; Tangler : addIndent(i)
group [for all] commands in the referenced chunk
    ReferenceCommand --&gt; Command : tangle()
end
ReferenceCommand --&gt; Tangler : clrIndent()"/>
</p>
<p>This approach can preserves the indentation in front of a <code class="docutils literal notranslate"><span class="pre">&#64;&lt;</span> <span class="pre">reference</span> <span class="pre">&#64;&gt;</span></code> command.</p>
<p class="rubric" id="tangler-subclass-emits-the-output-files-29">Tangler Subclass – emits the output files (29) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span>class Tangler(Emitter):
    code_indent = 0  #: Initial indent

    def __init__(self, output: Path = Path.cwd()) -&gt; None:
        super().__init__(output)
        self.include_line_numbers = False
        self.context: list[int] = []  #: Indentations
        self.fragment = &quot;&quot;  # Nothing written yet.
        # Create context and initial lastIndent values
        self.resetIndent(self.code_indent)
        # Summaries
        self.reference_names: set[str] = set()
        self.linesWritten = 0
        self.totalFiles = 0
        self.totalLines = 0
        self.logger.debug(&quot;output base: %r, line numbers %s&quot;, self.output, self.include_line_numbers)

    def emit(self, web: Web) -&gt; None:
        for file_chunk in web.files:
            self.logger.info(&quot;Tangling %s&quot;, file_chunk.name)
            self.emit_file(web, file_chunk)

    def emit_file(self, web: Web, file_chunk: Chunk) -&gt; None:
        target_path = self.output / (file_chunk.name or &quot;Untitled.out&quot;)
        self.logger.debug(&quot;Writing %s&quot;, target_path)
        self.logger.debug(&quot;Chunk %r&quot;, file_chunk)
        with target_path.open(&quot;w&quot;) as target:
            # An initial command to provide indentations.
            for command in file_chunk.commands:
                command.tangle(self, target)


→ `Emitter write a block of code with proper indents (30)`_


→ `Emitter indent control: set, clear and reset (31)`_
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Tangler Subclass – emits the output files (29)</em>.
Used by     → <a class="reference internal" href="#base-class-definitions-19">Base Class Definitions (19)</a>.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">codeBlock()</span></code> method is used by each block of code tangled into
a document. There are two sources of indentation:</p>
<ul class="simple">
<li><p>A <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> can provide an indent setting as an option. This is provided by the <code class="docutils literal notranslate"><span class="pre">indent</span></code> attribute
of the tangle context. If specified, this is the indentation.</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">&#64;&lt;</span> <span class="pre">name</span> <span class="pre">&#64;&gt;</span></code> <code class="docutils literal notranslate"><span class="pre">ReferenceCommand</span></code> may be indented. This will be in a <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> as the following three commands:</p>
<ol class="arabic simple">
<li><p>A <code class="docutils literal notranslate"><span class="pre">CodeCommand</span></code> with only spaces and no trailing <code class="docutils literal notranslate"><span class="pre">\n</span></code>.
The indent is buffered – not written – and the <code class="docutils literal notranslate"><span class="pre">fragment</span></code> attribute is set.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">ReferenceCommand</span></code>. This interpolates text from a <code class="docutils literal notranslate"><span class="pre">NamedChunk</span></code> using the prevailing indent.
The <code class="docutils literal notranslate"><span class="pre">tangle()</span></code> method uses <code class="docutils literal notranslate"><span class="pre">addIndent()</span></code> and <code class="docutils literal notranslate"><span class="pre">clrIndent()</span></code> to mark this. The processing depends
on this tangler’s <code class="docutils literal notranslate"><span class="pre">fragment</span></code> attribute to provide the pending indentation; the <code class="docutils literal notranslate"><span class="pre">addIndent()</span></code>
must consume the fragment to prevent confusion with subsequent indentations.</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">CodeCommand</span></code> with a trailing <code class="docutils literal notranslate"><span class="pre">\n</span></code>. (Often it’s only the newline.)  If the <code class="docutils literal notranslate"><span class="pre">fragment</span></code> attribute
is set, there’s a pending indentation that hasn’t yet been written.
This can happen with there’s a <code class="docutils literal notranslate"><span class="pre">&#64;&#64;</span></code> command at the left end of a line; often a Python decorator.
The fragment is written and the <code class="docutils literal notranslate"><span class="pre">fragment</span></code> attribute cleared.  No <code class="docutils literal notranslate"><span class="pre">addIdent()</span></code> will have
been done to consume the fragment.</p></li>
</ol>
</li>
</ul>
<p>While the WEB language permits multiple <code class="docutils literal notranslate"><span class="pre">&#64;&lt;name&#64;&gt;</span> <span class="pre">&#64;&lt;name&#64;&gt;</span></code> on a single line,
this is odd and potentially confusing. It isn’t clear how the second reference
should be indented.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">ReferenceCommand</span></code> <code class="docutils literal notranslate"><span class="pre">tangle()</span></code> implementation handles much of this.
The following two rules apply:</p>
<ul class="simple">
<li><p>A line of text that does not end with a newline,
sets a new prevailing indent for the following command(s).</p></li>
<li><p>A line of text ending with a newline resets the prevailing indent.</p></li>
</ul>
<p>This a stack of indentations, maintained by the <code class="docutils literal notranslate"><span class="pre">Tangler</span></code>.</p>
<p class="rubric" id="emitter-write-a-block-of-code-with-proper-indents-30">Emitter write a block of code with proper indents (30) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">codeBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Indented write of text in a ``CodeCommand``.</span>
<span class="sd">    Counts lines and saves position to indent to when expanding ``@&lt;...@&gt;`` references.</span>

<span class="sd">    The ``fragment`` is the prevailing indent used in reference expansion.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;codeBlock(</span><span class="si">%r</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="n">indent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Degenerate case of empty CodeText command. Should not occur.</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="c1"># Possible start of indentation prior to a ``@&lt;name@&gt;``</span>
            <span class="n">target</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">indent</span><span class="o">*</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">wrote</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fragment</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">wrote</span>
            <span class="c1"># May be used by a ``ReferenceCommand``, if needed.</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="n">target</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">indent</span><span class="o">*</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">target</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">linesWritten</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Non-exhaustive if statement.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Emitter write a block of code with proper indents (30)</em>.
Used by     → <a class="reference internal" href="#tangler-subclass-emits-the-output-files-29">Tangler Subclass – emits the output files (29)</a>.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">addIndent()</span></code> increments the indent.
Used by <code class="docutils literal notranslate"><span class="pre">&#64;&lt;name&#64;&gt;</span></code> to set a prevailing indent.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">setIndent()</span></code> pushes a fixed indent instead adding an increment.
Used by a <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> with an <code class="docutils literal notranslate"><span class="pre">-indent</span></code> option.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">clrIndent()</span></code> method discards the most recent indent from the context stack.
This is used when finished
tangling a source chunk.  This restores the indent to the prevailing indent.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">resetIndent()</span></code> method removes all indent context information and resets the indent
to a default.</p>
<p class="rubric" id="emitter-indent-control-set-clear-and-reset-31">Emitter indent control: set, clear and reset (31) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">addIndent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">increment</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lastIndent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">increment</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lastIndent</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log_indent</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;addIndent </span><span class="si">%d</span><span class="s2">: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">increment</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fragment</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

<span class="k">def</span> <span class="nf">setIndent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lastIndent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log_indent</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;setIndent </span><span class="si">%d</span><span class="s2">: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fragment</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

<span class="k">def</span> <span class="nf">clrIndent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lastIndent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log_indent</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;clrIndent </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fragment</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

<span class="k">def</span> <span class="nf">resetIndent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Resets the indentation context.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lastIndent</span> <span class="o">=</span> <span class="n">indent</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lastIndent</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log_indent</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;resetIndent </span><span class="si">%d</span><span class="s2">: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Emitter indent control: set, clear and reset (31)</em>.
Used by     → <a class="reference internal" href="#tangler-subclass-emits-the-output-files-29">Tangler Subclass – emits the output files (29)</a>.</p>
</div>
<p>An extension to the <code class="docutils literal notranslate"><span class="pre">Tangler</span></code> class that only updates a file if the content has changed.
This tangles to a temporary file.
If the content is identical, the temporary file is quietly disposed of.
Otherwise, the temporary file is linked to the original name.</p>
<p>Files are compared with the <code class="docutils literal notranslate"><span class="pre">filecmp</span></code> module.</p>
<p class="rubric" id="imports-32">Imports (32) +=</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">filecmp</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Imports (32)</em>.
Used by     → <a class="reference internal" href="#pyweb-py-80">pyweb.py (80)</a>.</p>
</div>
<p class="rubric" id="tanglermake-subclass-extends-tangler-to-avoid-touching-files-that-didn-t-change-33">TanglerMake Subclass – extends Tangler to avoid touching files that didn’t change (33) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TanglerMake</span><span class="p">(</span><span class="n">Tangler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">emit_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">web</span><span class="p">:</span> <span class="n">Web</span><span class="p">,</span> <span class="n">file_chunk</span><span class="p">:</span> <span class="n">Chunk</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">target_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">/</span> <span class="p">(</span><span class="n">file_chunk</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s2">&quot;Untitled.out&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Writing </span><span class="si">%s</span><span class="s2"> via a temp file&quot;</span><span class="p">,</span> <span class="n">target_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Chunk </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file_chunk</span><span class="p">)</span>

        <span class="n">fd</span><span class="p">,</span> <span class="n">tempname</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">target</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">file_chunk</span><span class="o">.</span><span class="n">commands</span><span class="p">:</span>
                <span class="n">command</span><span class="o">.</span><span class="n">tangle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">same</span> <span class="o">=</span> <span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">tempname</span><span class="p">,</span> <span class="n">target_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">same</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Doesn&#39;t exist. (Could check for errno.ENOENT)</span>

        <span class="k">if</span> <span class="n">same</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Unchanged &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">target_path</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tempname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Windows requires the original file name be removed first.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">target_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c1"># Doesn&#39;t exist. (Could check for errno.ENOENT)</span>
            <span class="n">target_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">target_path</span><span class="o">.</span><span class="n">hardlink_to</span><span class="p">(</span><span class="n">tempname</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tempname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Wrote </span><span class="si">%d</span><span class="s2"> lines to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">linesWritten</span><span class="p">,</span> <span class="n">target_path</span><span class="p">)</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>TanglerMake Subclass – extends Tangler to avoid touching files that didn’t change (33)</em>.
Used by     → <a class="reference internal" href="#base-class-definitions-19">Base Class Definitions (19)</a>.</p>
</div>
</section>
</section>
<section id="input-parsing">
<h3><a class="toc-backref" href="#id64" role="doc-backlink">Input Parsing</a><a class="headerlink" href="#input-parsing" title="Link to this heading">¶</a></h3>
<p>There are three tiers to the input parsing:</p>
<ul class="simple">
<li><p>A base tokenizer.</p></li>
<li><p>Additionally, a separate parser is used for options in <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> commands.</p></li>
<li><p>The overall <code class="docutils literal notranslate"><span class="pre">WebReader</span></code> class.</p></li>
</ul>
<p class="plantuml">
<img src="_images/plantuml-5e56d809cce3e55d45373ec11d41a2b777f82db2.png" alt="class WebReader {
    load(path) : Web
    parse_source()
}

class Tokenizer &lt;&lt;Iterator&gt;&gt; {
    __next__(self) : str
}

WebReader --&gt; Tokenizer
WebReader --&gt; WebReader : &quot;parent&quot;
WebReader --&gt; argparse.ArgumentParser"/>
</p>
<p>We’ll start with the <code class="docutils literal notranslate"><span class="pre">WebReader</span></code> class definition</p>
<p class="rubric" id="base-class-definitions-34">Base Class Definitions (34) +=</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span>→ `Tokenizer class - breaks input into tokens (52)`_

→ `WebReader class - parses the input file, building the Web structure (35)`_
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Base Class Definitions (34)</em>.
Used by     → <a class="reference internal" href="#pyweb-py-80">pyweb.py (80)</a>.</p>
</div>
<section id="the-webreader-class">
<h4><a class="toc-backref" href="#id65" role="doc-backlink">The WebReader Class</a><a class="headerlink" href="#the-webreader-class" title="Link to this heading">¶</a></h4>
<p>There are two forms of the constructor for a <code class="docutils literal notranslate"><span class="pre">WebReader</span></code>.
The  initial <code class="docutils literal notranslate"><span class="pre">WebReader</span></code> instance is created with code like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">WebReader</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">commandCharacter</span>
</pre></div>
</div>
<p>This will define the command character; usually provided as a command-line parameter to the application.</p>
<p>When processing an include file (with the <code class="docutils literal notranslate"><span class="pre">&#64;i</span></code> command), a child <code class="docutils literal notranslate"><span class="pre">WebReader</span></code>
instance is created with code like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="o">=</span> <span class="n">WebReader</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">parentWebReader</span><span class="p">)</span>
</pre></div>
</div>
<p>This will inherit the configuration from the parent <code class="docutils literal notranslate"><span class="pre">WebReader</span></code>.
This will also include a  reference from child to parent so that embedded Python expressions
can view the entire input context.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">WebReader</span></code> class parses the input file into command blocks.
These are assembled into <code class="docutils literal notranslate"><span class="pre">Chunks</span></code>, and the <code class="docutils literal notranslate"><span class="pre">Chunks</span></code> are assembled into the document
<code class="docutils literal notranslate"><span class="pre">Web</span></code>.  Once this input pass is complete, the resulting <code class="docutils literal notranslate"><span class="pre">Web</span></code> can be tangled or
woven.</p>
<p>The commands have three general types:</p>
<ul class="simple">
<li><p>“Structural” commands define the structure of the <code class="docutils literal notranslate"><span class="pre">Chunks</span></code>.  The  structural commands
are <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code>, as well as the <code class="docutils literal notranslate"><span class="pre">&#64;{</span></code>, <code class="docutils literal notranslate"><span class="pre">&#64;}</span></code>, <code class="docutils literal notranslate"><span class="pre">&#64;[</span></code>, <code class="docutils literal notranslate"><span class="pre">&#64;]</span></code> brackets,
and the <code class="docutils literal notranslate"><span class="pre">&#64;i</span></code> command to include another file.</p></li>
<li><p>“Inline” commands are inline within a <code class="docutils literal notranslate"><span class="pre">Chunk</span></code>: they define internal <code class="docutils literal notranslate"><span class="pre">Commands</span></code>.
Blocks of text are minor commands, as well as the <code class="docutils literal notranslate"><span class="pre">&#64;&lt;</span></code><em>name</em><code class="docutils literal notranslate"><span class="pre">&#64;&gt;</span></code> references.
The <code class="docutils literal notranslate"><span class="pre">&#64;&#64;</span></code> escape is also
handled here so that all further processing is independent of any parsing.</p></li>
<li><p>“Content” commands generate woven content. These include
the various cross-reference commands (<code class="docutils literal notranslate"><span class="pre">&#64;f</span></code>, <code class="docutils literal notranslate"><span class="pre">&#64;m</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;u</span></code>).</p></li>
</ul>
<p>There are two class-level <code class="docutils literal notranslate"><span class="pre">argparse.ArgumentParser</span></code> instances used by this class.</p>
<dl class="field-list simple">
<dt class="field-odd">output_option_parser<span class="colon">:</span></dt>
<dd class="field-odd"><p>An <code class="docutils literal notranslate"><span class="pre">argparse.ArgumentParser</span></code> used to parse the <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> command’s options.</p>
</dd>
<dt class="field-even">definition_option_parser<span class="colon">:</span></dt>
<dd class="field-even"><p>An <code class="docutils literal notranslate"><span class="pre">argparse.ArgumentParser</span></code> used to parse the <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> command’s options.</p>
</dd>
</dl>
<p>The class has the following attributes:</p>
<dl class="field-list simple">
<dt class="field-odd">parent<span class="colon">:</span></dt>
<dd class="field-odd"><p>is the outer <code class="docutils literal notranslate"><span class="pre">WebReader</span></code> when processing a <code class="docutils literal notranslate"><span class="pre">&#64;i</span></code> command.</p>
</dd>
<dt class="field-even">command<span class="colon">:</span></dt>
<dd class="field-even"><p>is the command character; a WebReader will use the parent command
character if the parent is not <code class="docutils literal notranslate"><span class="pre">None</span></code>. Default is <code class="docutils literal notranslate"><span class="pre">&#64;</span></code>.</p>
</dd>
<dt class="field-odd">permitList<span class="colon">:</span></dt>
<dd class="field-odd"><p>is the list of commands that are permitted to fail.  This is generally
an empty list or <code class="docutils literal notranslate"><span class="pre">('&#64;i',)</span></code>.</p>
</dd>
<dt class="field-even">_source<span class="colon">:</span></dt>
<dd class="field-even"><p>The open file-like object being used by <code class="docutils literal notranslate"><span class="pre">load()</span></code>.</p>
</dd>
<dt class="field-odd">filePath<span class="colon">:</span></dt>
<dd class="field-odd"><p>The path being processed; this provides a visible file name.</p>
</dd>
<dt class="field-even">tokenizer<span class="colon">:</span></dt>
<dd class="field-even"><p>An instance of <code class="docutils literal notranslate"><span class="pre">Tokenizer</span></code> used to parse the input. This is built
when <code class="docutils literal notranslate"><span class="pre">load()</span></code> is called.</p>
</dd>
<dt class="field-odd">totalLines<span class="colon">:</span></dt>
<dd class="field-odd"><p></p></dd>
<dt class="field-even">totalFiles<span class="colon">:</span></dt>
<dd class="field-even"><p></p></dd>
<dt class="field-odd">errors<span class="colon">:</span></dt>
<dd class="field-odd"><p>Summary counts.</p>
</dd>
</dl>
<p class="rubric" id="webreader-class-parses-the-input-file-building-the-web-structure-35">WebReader class - parses the input file, building the Web structure (35) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span>class WebReader:
    &quot;&quot;&quot;Parse an input file, creating Chunks and Commands.&quot;&quot;&quot;

    # Configuration
    #: The command prefix, default ``@``.
    command: str
    #: Permitted errors, usually @i commands
    permitList: list[str]
    #: Working directory to resolve @i commands
    base_path: Path
    #: The tokenizer used to find commands
    tokenizer: Tokenizer

    # State of the reader
    #: Parent context for @i commands
    parent: &quot;WebReader | None&quot;
    #: Input Path
    filePath: Path
    #: Input file-like object, default is self.filePath.open()
    _source: TextIO
    #: The sequence of Chunk instances being built
    content: list[Chunk]

    def __init__(self, parent: &quot;WebReader | None&quot; = None) -&gt; None:
        self.logger = logging.getLogger(self.__class__.__qualname__)

        # Configuration comes from the parent or defaults if there is no parent.
        self.parent = parent
        if self.parent:
            self.command = self.parent.command
            self.permitList = self.parent.permitList
        else: # Defaults until overridden
            self.command = &#39;@&#39;
            self.permitList = []

        # Summary
        self.totalLines = 0
        self.totalFiles = 0
        self.errors = 0


→ `WebReader command literals (50)`_

    def __str__(self) -&gt; str:
        return self.__class__.__name__


→ `WebReader location in the input stream (47)`_


→ `WebReader load the web (49)`_


→ `WebReader handle a command string (36)`_
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>WebReader class - parses the input file, building the Web structure (35)</em>.
Used by     → <a class="reference internal" href="#base-class-definitions-34">Base Class Definitions (34)</a>.</p>
</div>
<p>The reader maintains a context into which constructs are added.
The <code class="docutils literal notranslate"><span class="pre">Web</span></code> contains <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> instances in <code class="docutils literal notranslate"><span class="pre">self.web.chunks</span></code>.
The current chunk is <code class="docutils literal notranslate"><span class="pre">self.web.chunks[-1]</span></code>.
Each <code class="docutils literal notranslate"><span class="pre">Chunk</span></code>, similarly, has a command context in <code class="docutils literal notranslate"><span class="pre">chunk.commands[-1]</span></code>.</p>
<p>This works because the language is “flat”: there are no nested <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> or <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code>
chunks.</p>
<p>Command recognition is done via a <strong>Chain of Command</strong>-like design.
There are two conditions: the command string is recognized or it is not recognized.
If the command is recognized, <code class="docutils literal notranslate"><span class="pre">handleCommand()</span></code> will do one of the following:</p>
<ul class="simple">
<li><p>For “structural” commands, it will attach the current <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> (<em>self.aChunk</em>) to the
current <code class="docutils literal notranslate"><span class="pre">Web</span></code> (<em>self.aWeb</em>), and start a new <code class="docutils literal notranslate"><span class="pre">Chunk</span></code>. This becomes the context
for processing commands. By default an anonymous <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> used to accumulate text
is available for all of the content outside named chunks.</p></li>
<li><p>For “inline” and “content” commands, create a <code class="docutils literal notranslate"><span class="pre">Command</span></code>, attach it to the current
<code class="docutils literal notranslate"><span class="pre">Chunk</span></code> (<em>self.aChunk</em>).</p></li>
</ul>
<p>If the command is not recognized, <code class="docutils literal notranslate"><span class="pre">handleCommand()</span></code> returns false, and this is a syntax error.</p>
<p>A subclass can override <code class="docutils literal notranslate"><span class="pre">handleCommand()</span></code> to</p>
<ol class="arabic simple">
<li><p>Evaluate the base class <code class="docutils literal notranslate"><span class="pre">handleCommand()</span></code> method;</p></li>
<li><p>If the command is unknown to the base,
then the current class can process it;</p></li>
<li><p>If the command is unknown to both classes,
then return <code class="docutils literal notranslate"><span class="pre">False</span></code>.  Either a subclass will handle it, or the default activity taken
by <code class="docutils literal notranslate"><span class="pre">load()</span></code> is to treat the command as a syntax error.</p></li>
</ol>
<p>The <code class="docutils literal notranslate"><span class="pre">handleCommand()</span></code> implementation is a massive <code class="docutils literal notranslate"><span class="pre">match</span></code> statement.
It might be a good idea to decompose this into a number of separate methods.
This would make the <code class="docutils literal notranslate"><span class="pre">match</span></code> statement shorter and easier to understand.</p>
<p class="rubric" id="webreader-handle-a-command-string-36">WebReader handle a command string (36) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span>def handleCommand(self, token: str) -&gt; bool:
    self.logger.debug(&quot;Reading %r&quot;, token)
    new_chunk: Chunk | None = None
    match token[:2]:
        case self.cmdo:

→ `start an OutputChunk, adding it to the web (37)`_
        case self.cmdd:

→ `start a NamedChunk or NamedDocumentChunk, adding it to the web (38)`_
        case self.cmdi:

→ `include another file (39)`_
        case self.cmdrcurl | self.cmdrbrak:

→ `finish a chunk, start a new Chunk adding it to the web (40)`_
        case self.cmdpipe:

→ `assign user identifiers to the current chunk (41)`_
        case self.cmdf:
            self.content[-1].commands.append(FileXrefCommand(self.location()))
        case self.cmdm:
            self.content[-1].commands.append(MacroXrefCommand(self.location()))
        case self.cmdu:
            self.content[-1].commands.append(UserIdXrefCommand(self.location()))
        case self.cmdlangl:

→ `add a reference command to the current chunk (42)`_
        case self.cmdlexpr:

→ `add an expression command to the current chunk (44)`_
        case self.cmdcmd:

→ `double at-sign replacement, append this character to previous TextCommand (45)`_
        case self.cmdlcurl | self.cmdlbrak:
            # These should have been consumed as part of @o and @d parsing
            self.logger.error(&quot;Extra %r (possibly missing chunk name) near %r&quot;, token, self.location())
            self.errors += 1
        case _:
            return False  # did not recogize the command
    return True  # did recognize the command
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>WebReader handle a command string (36)</em>.
Used by     → <a class="reference internal" href="#webreader-class-parses-the-input-file-building-the-web-structure-35">WebReader class - parses the input file, building the Web structure (35)</a>.</p>
</div>
<p>An output chunk has the form <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> <em>name</em> <code class="docutils literal notranslate"><span class="pre">&#64;{</span></code> <em>content</em> <code class="docutils literal notranslate"><span class="pre">&#64;}</span></code>.
We use the first two tokens to name the <code class="docutils literal notranslate"><span class="pre">OutputChunk</span></code>.  We expect
the <code class="docutils literal notranslate"><span class="pre">&#64;{</span></code> separator.  We then attach all subsequent commands
to this chunk while waiting for the final <code class="docutils literal notranslate"><span class="pre">&#64;}</span></code> token to end the chunk.</p>
<p>We’ll use an <code class="docutils literal notranslate"><span class="pre">ArgumentParser</span></code> to locate the optional parameters.  This will then let
us build an appropriate instance of <code class="docutils literal notranslate"><span class="pre">OutputChunk</span></code>.</p>
<p>With some small additional changes, we could use <code class="docutils literal notranslate"><span class="pre">OutputChunk(**options)</span></code>.</p>
<p class="rubric" id="start-an-outputchunk-adding-it-to-the-web-37">start an OutputChunk, adding it to the web (37) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">arg_str</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">expect</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">cmdlcurl</span><span class="p">})</span>
<span class="n">new_chunk</span> <span class="o">=</span> <span class="n">OutputChunk</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">arg_str</span><span class="p">))</span>
<span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_chunk</span><span class="p">)</span>
<span class="c1"># capture an OutputChunk up to @}</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>start an OutputChunk, adding it to the web (37)</em>.
Used by     → <a class="reference internal" href="#webreader-handle-a-command-string-36">WebReader handle a command string (36)</a>.</p>
</div>
<p>A named chunk has the form <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> <em>name</em> <code class="docutils literal notranslate"><span class="pre">&#64;{</span></code> <em>content</em> <code class="docutils literal notranslate"><span class="pre">&#64;}</span></code> for
code and <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> <em>name</em> <code class="docutils literal notranslate"><span class="pre">&#64;[</span></code> <em>content</em> <code class="docutils literal notranslate"><span class="pre">&#64;]</span></code> for document source.
We use the first two tokens to name the <code class="docutils literal notranslate"><span class="pre">NamedChunk</span></code> or <code class="docutils literal notranslate"><span class="pre">NamedDocumentChunk</span></code>.
We expect either the <code class="docutils literal notranslate"><span class="pre">&#64;{</span></code> or <code class="docutils literal notranslate"><span class="pre">&#64;[</span></code> separator, and use the actual
token found to choose which subclass of <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> to create.
We then attach all subsequent commands
to this chunk while waiting for the final <code class="docutils literal notranslate"><span class="pre">&#64;}</span></code> or <code class="docutils literal notranslate"><span class="pre">&#64;]</span></code> token to
end the chunk.</p>
<p>We’ll use an <code class="docutils literal notranslate"><span class="pre">ArgumentParser</span></code> to locate the optional parameter of <code class="docutils literal notranslate"><span class="pre">-noindent</span></code>.</p>
<p>Then we can use the <code class="docutils literal notranslate"><span class="pre">options</span></code> value to create an appropriate subclass of <code class="docutils literal notranslate"><span class="pre">NamedChunk</span></code>.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">`&quot;-indent&quot;</span></code> is in options, this is the default.
If both are in the options, we should provide a warning.</p>
<p class="rubric" id="start-a-namedchunk-or-nameddocumentchunk-adding-it-to-the-web-38">start a NamedChunk or NamedDocumentChunk, adding it to the web (38) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">arg_str</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">)</span>
<span class="n">brack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expect</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">cmdlcurl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmdlbrak</span><span class="p">})</span>

<span class="c1"># REFACTOR parse_options into various CHUNK types.</span>
<span class="c1"># REFACTOR remove NamedChunk_Noindent as a distinct subclass.</span>
<span class="k">if</span> <span class="n">brack</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmdlbrak</span><span class="p">:</span>
    <span class="c1"># options = NamedDocumentChunk.parse_options(shlex.split(arg_str))</span>
    <span class="c1"># name = &#39; &#39;.join(options.argument)</span>
    <span class="n">new_chunk</span> <span class="o">=</span> <span class="n">NamedDocumentChunk</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">arg_str</span><span class="p">))</span>
<span class="k">elif</span> <span class="n">brack</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmdlcurl</span><span class="p">:</span>
    <span class="c1"># options = NamedChunk.parse_options(shlex.split(arg_str))</span>
    <span class="c1"># indent: None | int = None</span>
    <span class="c1"># name = &#39; &#39;.join(options.argument)</span>
    <span class="c1"># if &#39;noindent&#39; in options and options.noindent:</span>
    <span class="c1">#     indent = 0</span>
    <span class="c1"># elif &#39;indent&#39; in options and options.indent:</span>
    <span class="c1">#     indent = int(options.indent)</span>
    <span class="n">new_chunk</span> <span class="o">=</span> <span class="n">NamedChunk</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">arg_str</span><span class="p">))</span>
<span class="k">elif</span> <span class="n">brack</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">new_chunk</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">pass</span>  <span class="c1"># Error already noted by ``expect()``</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Design Error&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">new_chunk</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_chunk</span><span class="p">)</span>
<span class="c1"># capture a NamedChunk up to @} or @]</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>start a NamedChunk or NamedDocumentChunk, adding it to the web (38)</em>.
Used by     → <a class="reference internal" href="#webreader-handle-a-command-string-36">WebReader handle a command string (36)</a>.</p>
</div>
<p>An import command has the unusual form of <code class="docutils literal notranslate"><span class="pre">&#64;i</span></code> <em>name</em>, with no trailing
separator.  When we encounter the <code class="docutils literal notranslate"><span class="pre">&#64;i</span></code> token, the next token will start with the
file name, but may continue with an anonymous chunk.  To avoid confusion,
we require that all <code class="docutils literal notranslate"><span class="pre">&#64;i</span></code> commands occur at the end of a line,
The break on the <code class="docutils literal notranslate"><span class="pre">'\n'</span></code> which ends the file name.
This permits file names with embedded spaces. It also permits arguments and options,
if really necessary.</p>
<p>Once we have split the file name away from the rest of the following anonymous chunk,
we push the following token (a <code class="docutils literal notranslate"><span class="pre">\n</span></code>) back into the token stream, so that it will be the
first token examined at the top of the <code class="docutils literal notranslate"><span class="pre">load()</span></code> loop.</p>
<p>We create a child <code class="docutils literal notranslate"><span class="pre">WebReader</span></code> instance to process the included file.  The entire file
is loaded into the current <code class="docutils literal notranslate"><span class="pre">Web</span></code> instance.  A new, empty <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> is created at the end
of the file so that processing can resume with an anonymous <code class="docutils literal notranslate"><span class="pre">Chunk</span></code>.</p>
<p>The reader has a <code class="docutils literal notranslate"><span class="pre">permitList</span></code> attribute.
This lists any commands where failure is permitted.  Currently, only the <code class="docutils literal notranslate"><span class="pre">&#64;i</span></code> command
can be set to permit failure; this allows a <code class="docutils literal notranslate"><span class="pre">.w</span></code> to include
a file that does not yet exist.</p>
<p>The primary use case for this permitted error feature is when weaving test output.
A first use of the <strong>py-web-lp</strong> can be used to tangle the program source files,
ignoring a missing test output file, named in an <code class="docutils literal notranslate"><span class="pre">&#64;i</span></code> command.
The application can then be run to create the missing test output file.
After this, a second use of the <strong>py-web-lp</strong>
can weave the test output file into a final, complete document.</p>
<p class="rubric" id="include-another-file-39">include another file (39) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">incPath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">include</span> <span class="o">=</span> <span class="n">WebReader</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">incPath</span><span class="o">.</span><span class="n">is_absolute</span><span class="p">():</span>
        <span class="n">incPath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span> <span class="o">/</span> <span class="n">incPath</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Including &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">incPath</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">include</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">incPath</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">totalLines</span> <span class="o">+=</span> <span class="n">include</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">lineNumber</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">totalFiles</span> <span class="o">+=</span> <span class="n">include</span><span class="o">.</span><span class="n">totalFiles</span>
    <span class="k">if</span> <span class="n">include</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">+=</span> <span class="n">include</span><span class="o">.</span><span class="n">errors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Errors in included file &#39;</span><span class="si">%s</span><span class="s2">&#39;, output is incomplete.&quot;</span><span class="p">,</span> <span class="n">incPath</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="p">))</span>
<span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Problems with included file &#39;</span><span class="si">%s</span><span class="s2">&#39;, output is incomplete.&quot;</span><span class="p">,</span> <span class="n">incPath</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Problems finding included file &#39;</span><span class="si">%s</span><span class="s2">&#39;, output is incomplete.&quot;</span><span class="p">,</span> <span class="n">incPath</span><span class="p">)</span>
    <span class="c1"># Discretionary -- sometimes we want to continue</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmdi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">permitList</span><span class="p">:</span> <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">raise</span>  <span class="c1"># Seems heavy-handed, but, the file wasn&#39;t found!</span>
<span class="c1"># Start a new context for text or commands *after* the ``@i``.</span>
<span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Chunk</span><span class="p">())</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>include another file (39)</em>.
Used by     → <a class="reference internal" href="#webreader-handle-a-command-string-36">WebReader handle a command string (36)</a>.</p>
</div>
<p>When a <code class="docutils literal notranslate"><span class="pre">&#64;}</span></code> or <code class="docutils literal notranslate"><span class="pre">&#64;]</span></code> are found, this finishes a named chunk.
The next text is therefore part of an anonymous chunk.</p>
<p>Note that no check is made to assure that the previous <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> was indeed a named
chunk or output chunk started with <code class="docutils literal notranslate"><span class="pre">&#64;{</span></code> or <code class="docutils literal notranslate"><span class="pre">&#64;[</span></code>.
To do this, an attribute would be needed for each <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> subclass that indicated if a trailing bracket was necessary.
For the base <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> class, this would be false, but for all other subclasses of
<code class="docutils literal notranslate"><span class="pre">Chunk</span></code>, this would be true.</p>
<p class="rubric" id="finish-a-chunk-start-a-new-chunk-adding-it-to-the-web-40">finish a chunk, start a new Chunk adding it to the web (40) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Start a new context for text or commands *after* this command.</span>
<span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Chunk</span><span class="p">())</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>finish a chunk, start a new Chunk adding it to the web (40)</em>.
Used by     → <a class="reference internal" href="#webreader-handle-a-command-string-36">WebReader handle a command string (36)</a>.</p>
</div>
<p>User identifiers occur after a <code class="docutils literal notranslate"><span class="pre">&#64;|</span></code> command inside a <code class="docutils literal notranslate"><span class="pre">NamedChunk</span></code>.</p>
<p>Note that no check is made to assure that the previous <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> was indeed a named
chunk or output chunk started with <code class="docutils literal notranslate"><span class="pre">&#64;{</span></code>.
To do this, an attribute would be needed for each <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> subclass that indicated if user identifiers are permitted.
For the base <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> class, this would be false, but for the <code class="docutils literal notranslate"><span class="pre">NamedChunk</span></code> class and
<code class="docutils literal notranslate"><span class="pre">OutputChunk</span></code> class, this would be true.</p>
<p>User identifiers are name references at the end of a NamedChunk
These are accumulated and expanded by <code class="docutils literal notranslate"><span class="pre">&#64;u</span></code> reference</p>
<p class="rubric" id="assign-user-identifiers-to-the-current-chunk-41">assign user identifiers to the current chunk (41) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">names</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">def_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
    <span class="c1"># Out of place @| user identifier command</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unexpected references near </span><span class="si">%r</span><span class="s2">: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">(),</span> <span class="n">token</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>assign user identifiers to the current chunk (41)</em>.
Used by     → <a class="reference internal" href="#webreader-handle-a-command-string-36">WebReader handle a command string (36)</a>.</p>
</div>
<p>A reference command has the form <code class="docutils literal notranslate"><span class="pre">&#64;&lt;</span></code><em>name</em><code class="docutils literal notranslate"><span class="pre">&#64;&gt;</span></code>.  We accept three
tokens from the input, the middle token is the referenced name.</p>
<p class="rubric" id="add-a-reference-command-to-the-current-chunk-42">add a reference command to the current chunk (42) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># get the name, introduce into the named Chunk dictionary</span>
<span class="n">name</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="n">closing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expect</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">cmdrangl</span><span class="p">})</span>
<span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ReferenceCommand</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">()))</span>
<span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Reading </span><span class="si">%r</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">closing</span><span class="p">)</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>add a reference command to the current chunk (42)</em>.
Used by     → <a class="reference internal" href="#webreader-handle-a-command-string-36">WebReader handle a command string (36)</a>.</p>
</div>
<p>An expression command has the form <code class="docutils literal notranslate"><span class="pre">&#64;(</span></code><em>Python Expression</em><code class="docutils literal notranslate"><span class="pre">&#64;)</span></code>.
We accept three tokens from the input, the middle token is the expression.</p>
<p>There are two alternative semantics for an embedded expression.</p>
<ul class="simple">
<li><p><strong>Deferred Execution</strong>.  This requires definition of a new subclass of <code class="docutils literal notranslate"><span class="pre">Command</span></code>,
<code class="docutils literal notranslate"><span class="pre">ExpressionCommand</span></code>, and appends it into the current <code class="docutils literal notranslate"><span class="pre">Chunk</span></code>.  At weave and
tangle time, this expression is evaluated.  The insert might look something like this:
<code class="docutils literal notranslate"><span class="pre">aChunk.append(ExpressionCommand(expression,</span> <span class="pre">self.location()))</span></code>.</p></li>
<li><p><strong>Immediate Execution</strong>.  This simply creates a context and evaluates
the Python expression.  The output from the expression becomes a <code class="docutils literal notranslate"><span class="pre">TextCommand</span></code>, and
is append to the current <code class="docutils literal notranslate"><span class="pre">Chunk</span></code>.</p></li>
</ul>
<p>We use the <strong>Immediate Execution</strong> semantics – the expression is immediately appended
to the current chunk’s text.</p>
<p>We provide a few elements of the <code class="docutils literal notranslate"><span class="pre">os</span></code> module.  We provide <code class="docutils literal notranslate"><span class="pre">os.path</span></code> library.
The <code class="docutils literal notranslate"><span class="pre">os.getcwd()</span></code> could be changed to <code class="docutils literal notranslate"><span class="pre">os.path.realpath('.')</span></code>, but that seems too long-winded.</p>
<p class="rubric" id="imports-43">Imports (43) +=</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">builtins</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">platform</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Imports (43)</em>.
Used by     → <a class="reference internal" href="#pyweb-py-80">pyweb.py (80)</a>.</p>
</div>
<p class="rubric" id="add-an-expression-command-to-the-current-chunk-44">add an expression command to the current chunk (44) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># get the Python expression, create the expression result</span>
<span class="n">expression</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">expect</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">cmdrexpr</span><span class="p">})</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># Build Context</span>
    <span class="c1"># **TODO:** Parts of this are static and can be built as part of ``__init__()``.</span>
    <span class="n">dangerous</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;breakpoint&#39;</span><span class="p">,</span> <span class="s1">&#39;compile&#39;</span><span class="p">,</span> <span class="s1">&#39;eval&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">,</span> <span class="s1">&#39;execfile&#39;</span><span class="p">,</span> <span class="s1">&#39;globals&#39;</span><span class="p">,</span> <span class="s1">&#39;help&#39;</span><span class="p">,</span> <span class="s1">&#39;input&#39;</span><span class="p">,</span>
        <span class="s1">&#39;memoryview&#39;</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;print&#39;</span><span class="p">,</span> <span class="s1">&#39;super&#39;</span><span class="p">,</span> <span class="s1">&#39;__import__&#39;</span>
    <span class="p">}</span>
    <span class="n">safe</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">SimpleNamespace</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span>
        <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">obj</span> <span class="ow">in</span> <span class="n">builtins</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dangerous</span>
    <span class="p">))</span>
    <span class="nb">globals</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">__builtins__</span><span class="o">=</span><span class="n">safe</span><span class="p">,</span>
        <span class="n">os</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">SimpleNamespace</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">getcwd</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
        <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span>
        <span class="n">datetime</span><span class="o">=</span><span class="n">datetime</span><span class="p">,</span>
        <span class="n">platform</span><span class="o">=</span><span class="n">platform</span><span class="p">,</span>
        <span class="n">theWebReader</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">theFile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filePath</span><span class="p">,</span>
        <span class="n">thisApplication</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">__version__</span><span class="o">=</span><span class="n">__version__</span><span class="p">,</span>  <span class="c1"># Legacy compatibility. Deprecated.</span>
        <span class="n">version</span><span class="o">=</span><span class="n">__version__</span><span class="p">,</span>
        <span class="n">theLocation</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">()),</span>  <span class="c1"># The only thing that&#39;s dynamic</span>
        <span class="p">)</span>
    <span class="c1"># Evaluate</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="nb">globals</span><span class="p">))</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failure to process </span><span class="si">%r</span><span class="s1">: exception is </span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">result</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;@(</span><span class="si">{</span><span class="n">expression</span><span class="si">!r}</span><span class="s2">: Error </span><span class="si">{</span><span class="n">exc</span><span class="si">!r}</span><span class="s2">@)&quot;</span>
<span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">())</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>add an expression command to the current chunk (44)</em>.
Used by     → <a class="reference internal" href="#webreader-handle-a-command-string-36">WebReader handle a command string (36)</a>.</p>
</div>
<p>A double command sequence (<code class="docutils literal notranslate"><span class="pre">'&#64;&#64;'</span></code>, when the command is an <code class="docutils literal notranslate"><span class="pre">'&#64;'</span></code>) has the usual meaning of <code class="docutils literal notranslate"><span class="pre">'&#64;'</span></code> in the input stream.
We do this by appending text to the last command in the current <code class="docutils literal notranslate"><span class="pre">Chunk</span></code>.
This will append the  character on the end of the most recent <code class="docutils literal notranslate"><span class="pre">TextCommand</span></code> or <code class="docutils literal notranslate"><span class="pre">CodeCommand`</span></code>.
If this fails, it will create a new, empty <code class="docutils literal notranslate"><span class="pre">TextCommand</span></code> or <code class="docutils literal notranslate"><span class="pre">CodeCommand</span></code>.</p>
<p class="rubric" id="double-at-sign-replacement-append-this-character-to-previous-textcommand-45">double at-sign replacement, append this character to previous TextCommand (45) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;double-command: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">())</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>double at-sign replacement, append this character to previous TextCommand (45)</em>.
Used by     → <a class="reference internal" href="#webreader-handle-a-command-string-36">WebReader handle a command string (36)</a>.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">expect()</span></code> method examines the next token to see if it is the expected item.
Any <code class="docutils literal notranslate"><span class="pre">'\n'</span></code> characters are absorbed.
If this is not found, a standard type of error message is raised.
This is used by <code class="docutils literal notranslate"><span class="pre">handleCommand()</span></code>.</p>
<p class="rubric" id="webreader-handle-a-command-string-46">WebReader handle a command string (46) +=</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">expect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compare next token with expectation, quietly skipping whitespace (i.e., ``\n``).&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;At </span><span class="si">%r</span><span class="s2">: end of input, </span><span class="si">%r</span><span class="s2"> not found&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">(),</span> <span class="n">tokens</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">t</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;At </span><span class="si">%r</span><span class="s2">: expected </span><span class="si">%r</span><span class="s2">, found </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">(),</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>WebReader handle a command string (46)</em>.
Used by     → <a class="reference internal" href="#webreader-class-parses-the-input-file-building-the-web-structure-35">WebReader class - parses the input file, building the Web structure (35)</a>.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">location()</span></code> provides the file name and line number.
This allows error messages as well as tangled or woven output
to correctly reference the original input files.</p>
<p class="rubric" id="webreader-location-in-the-input-stream-47">WebReader location in the input stream (47) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">location</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filePath</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">lineNumber</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>WebReader location in the input stream (47)</em>.
Used by     → <a class="reference internal" href="#webreader-class-parses-the-input-file-building-the-web-structure-35">WebReader class - parses the input file, building the Web structure (35)</a>.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">load()</span></code> method reads the entire input file as a sequence of tokens, split up by the <code class="docutils literal notranslate"><span class="pre">Tokenizer</span></code>.
Each token that appears to be a command is passed to the <code class="docutils literal notranslate"><span class="pre">handleCommand()</span></code> method.
If the <code class="docutils literal notranslate"><span class="pre">handleCommand()</span></code> method returns a True result, the command was recognized and placed in the <code class="docutils literal notranslate"><span class="pre">Web</span></code>.
If <code class="docutils literal notranslate"><span class="pre">handleCommand()</span></code> returns a False result, the command was unknown, and we write a warning but treat it as text.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">load()</span></code> method is used recursively to handle the <code class="docutils literal notranslate"><span class="pre">&#64;i</span></code> command.
The issue is that it’s always loading a single top-level web.</p>
<p class="rubric" id="imports-48">Imports (48) +=</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TextIO</span><span class="p">,</span> <span class="n">cast</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Imports (48)</em>.
Used by     → <a class="reference internal" href="#pyweb-py-80">pyweb.py (80)</a>.</p>
</div>
<p class="rubric" id="webreader-load-the-web-49">WebReader load the web (49) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="n">TextIO</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Chunk</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a flat list of chunks to be made into a Web.</span>
<span class="sd">    Also used to expand ``@i`` included files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">filePath</span> <span class="o">=</span> <span class="n">filepath</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filePath</span><span class="o">.</span><span class="n">parent</span>

    <span class="k">if</span> <span class="n">source</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_source</span> <span class="o">=</span> <span class="n">source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_source</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">filePath</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_source</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span>

<span class="k">def</span> <span class="nf">parse_source</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Builds a sequence of Chunks.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">Tokenizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">totalFiles</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Initial anonymous chunk.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="p">[</span><span class="n">Chunk</span><span class="p">()]</span>

    <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">token</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">handleCommand</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unknown @-command in input: </span><span class="si">%r</span><span class="s1"> near </span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">())</span>

        <span class="k">elif</span> <span class="n">token</span><span class="p">:</span>
            <span class="c1"># Accumulate a non-empty block of text in the current chunk.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">())</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Whitespace</span>
            <span class="k">pass</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;parse_source: [&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>WebReader load the web (49)</em>.
Used by     → <a class="reference internal" href="#webreader-class-parses-the-input-file-building-the-web-structure-35">WebReader class - parses the input file, building the Web structure (35)</a>.</p>
</div>
<p>The command character can be changed to permit
some flexibility when working with languages that make extensive use of the <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> symbol.
The initialization of the <code class="docutils literal notranslate"><span class="pre">WebReader</span></code> is based on the selected command character.</p>
<p class="rubric" id="webreader-command-literals-50">WebReader command literals (50) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Structural (&quot;major&quot;) commands</span>
<span class="bp">self</span><span class="o">.</span><span class="n">cmdo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">+</span><span class="s1">&#39;o&#39;</span>
<span class="bp">self</span><span class="o">.</span><span class="n">cmdd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">+</span><span class="s1">&#39;d&#39;</span>
<span class="bp">self</span><span class="o">.</span><span class="n">cmdlcurl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">+</span><span class="s1">&#39;{&#39;</span>
<span class="bp">self</span><span class="o">.</span><span class="n">cmdrcurl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">+</span><span class="s1">&#39;}&#39;</span>
<span class="bp">self</span><span class="o">.</span><span class="n">cmdlbrak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">+</span><span class="s1">&#39;[&#39;</span>
<span class="bp">self</span><span class="o">.</span><span class="n">cmdrbrak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">+</span><span class="s1">&#39;]&#39;</span>
<span class="bp">self</span><span class="o">.</span><span class="n">cmdi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">+</span><span class="s1">&#39;i&#39;</span>

<span class="c1"># Inline (&quot;minor&quot;) commands</span>
<span class="bp">self</span><span class="o">.</span><span class="n">cmdlangl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">+</span><span class="s1">&#39;&lt;&#39;</span>
<span class="bp">self</span><span class="o">.</span><span class="n">cmdrangl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">+</span><span class="s1">&#39;&gt;&#39;</span>
<span class="bp">self</span><span class="o">.</span><span class="n">cmdpipe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">+</span><span class="s1">&#39;|&#39;</span>
<span class="bp">self</span><span class="o">.</span><span class="n">cmdlexpr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">+</span><span class="s1">&#39;(&#39;</span>
<span class="bp">self</span><span class="o">.</span><span class="n">cmdrexpr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">+</span><span class="s1">&#39;)&#39;</span>
<span class="bp">self</span><span class="o">.</span><span class="n">cmdcmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span>

<span class="c1"># Content &quot;minor&quot; commands</span>
<span class="bp">self</span><span class="o">.</span><span class="n">cmdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">+</span><span class="s1">&#39;f&#39;</span>
<span class="bp">self</span><span class="o">.</span><span class="n">cmdm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">+</span><span class="s1">&#39;m&#39;</span>
<span class="bp">self</span><span class="o">.</span><span class="n">cmdu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">+</span><span class="s1">&#39;u&#39;</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>WebReader command literals (50)</em>.
Used by     → <a class="reference internal" href="#webreader-class-parses-the-input-file-building-the-web-structure-35">WebReader class - parses the input file, building the Web structure (35)</a>.</p>
</div>
</section>
<section id="the-tokenizer-class">
<h4><a class="toc-backref" href="#id66" role="doc-backlink">The Tokenizer Class</a><a class="headerlink" href="#the-tokenizer-class" title="Link to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">WebReader</span></code> requires a tokenizer. The tokenizer breaks the input text into a stream of tokens.
There are two broad classes of tokens:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">r'&#64;.'</span></code> command tokens, including the structural, inline, and content
commands.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">r'\n'</span></code>. Inside text, these matter.
Within structural command tokens, these don’t matter.
Except after the filename after an <code class="docutils literal notranslate"><span class="pre">&#64;i</span></code> command, where one of these end the command.</p></li>
<li><p>The remaining text; neither newlines nor commands.</p></li>
</ul>
<p>The tokenizer works by reading the entire file and splitting on <code class="docutils literal notranslate"><span class="pre">r'&#64;.'</span></code> patterns.
The <code class="docutils literal notranslate"><span class="pre">re.split()</span></code> function will separate the input and preserve the actual character sequence on which the input was split.
This breaks the input into blocks of text separated by the <code class="docutils literal notranslate"><span class="pre">r'&#64;.'</span></code> characters.</p>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pat</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="s2">&quot;@{hi mom@}&quot;</span><span class="p">)</span>
<span class="go">[&#39;&#39;, &#39;@{&#39;, &#39;hi mom&#39;, &#39;@}&#39;, &#39;&#39;]</span>
</pre></div>
</div>
<p>This tokenizer splits the input using <code class="docutils literal notranslate"><span class="pre">r'&#64;.|\n'</span></code>.
The idea is that  we locate commands, newlines and the interstitial text as three classes of tokens.
We can then assemble each <code class="docutils literal notranslate"><span class="pre">Command</span></code> instance from a short sequence of tokens.
The core <code class="docutils literal notranslate"><span class="pre">TextCommand</span></code> and <code class="docutils literal notranslate"><span class="pre">CodeCommand</span></code> will be a line of text ending with the <code class="docutils literal notranslate"><span class="pre">\n</span></code>.</p>
<p>The tokenizer counts newline characters for us, so that error messages can include a line number.
Also, we can tangle extract comments into a file to reveal source line numbers.</p>
<p>Since the tokenizer is a proper iterator, we can use <code class="docutils literal notranslate"><span class="pre">tokens</span> <span class="pre">=</span> <span class="pre">iter(Tokenizer(source))</span></code> and <code class="docutils literal notranslate"><span class="pre">next(tokens)</span></code> to step through the sequence of tokens until we raise a <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code>
exception.</p>
<p class="rubric" id="imports-51">Imports (51) +=</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">Iterable</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Imports (51)</em>.
Used by     → <a class="reference internal" href="#pyweb-py-80">pyweb.py (80)</a>.</p>
</div>
<p class="rubric" id="tokenizer-class-breaks-input-into-tokens-52">Tokenizer class - breaks input into tokens (52) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Tokenizer</span><span class="p">(</span><span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">,</span> <span class="n">command_char</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;@&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">command_char</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parsePat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="si">}</span><span class="s1">.|</span><span class="se">\\</span><span class="s1">n)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token_iter</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsePat</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">())</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lineNumber</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token_iter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lineNumber</span> <span class="o">+=</span> <span class="n">token</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">token</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Tokenizer class - breaks input into tokens (52)</em>.
Used by     → <a class="reference internal" href="#base-class-definitions-34">Base Class Definitions (34)</a>.</p>
</div>
</section>
</section>
<section id="other-application-components">
<h3><a class="toc-backref" href="#id67" role="doc-backlink">Other Application Components</a><a class="headerlink" href="#other-application-components" title="Link to this heading">¶</a></h3>
<p>There are a number of other components:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#error-class">Error class</a> Defines a uniform exception for this module.</p></li>
<li><p><a class="reference internal" href="#action-class-hierarchy">Action Class Hierarchy</a> defines the actions the application can perform.
This includes loading the WEB file, weaving, tangling, and doing combinations of actions.</p></li>
<li><p><a class="reference internal" href="#the-application-class">The Application Class</a> is a high-level definition of the <strong>py-web-lp</strong> application as a whole.</p></li>
<li><p><a class="reference internal" href="#logging-setup">Logging setup</a> defines a handy context manager to configure and shut down logging.</p></li>
<li><p><a class="reference internal" href="#the-main-function">The Main Function</a> is a top-level function to create an instance of <code class="docutils literal notranslate"><span class="pre">Application</span></code>,
and execute it with either supplied arguments or (by default) the actual command-line
arguments. This makes it easy to import and reuse <code class="docutils literal notranslate"><span class="pre">main()</span></code> in other applications.</p></li>
</ul>
<section id="error-class">
<h4><a class="toc-backref" href="#id68" role="doc-backlink">Error class</a><a class="headerlink" href="#error-class" title="Link to this heading">¶</a></h4>
<p>An <code class="docutils literal notranslate"><span class="pre">Error</span></code> is raised whenever processing cannot continue.
Since it is a subclass of <code class="docutils literal notranslate"><span class="pre">Exception</span></code>, it takes an arbitrary number of arguments.
The first should be the basic message text.
Subsequent arguments provide additional details.
We will try to be sure that all of our internal exceptions reference a specific chunk, if possible.
This means either including the chunk as an argument, or catching the  exception and appending the current chunk to the exception’s arguments.</p>
<p>The Python <code class="docutils literal notranslate"><span class="pre">raise</span></code> statement takes an instance of <code class="docutils literal notranslate"><span class="pre">Error</span></code> and passes it to the enclosing <code class="docutils literal notranslate"><span class="pre">try/except</span></code> statement for processing.</p>
<p>The typical creation is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no full name for </span><span class="si">{</span><span class="n">chunk</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">chunk</span><span class="p">)</span>
</pre></div>
</div>
<p>A typical exception-handling suite might look like this:</p>
<pre class="literal-block">try:
    <em>...something that may raise an Error or Exception...</em>
except Error as e:
    print(e.args) # this is a pyWeb internal Error
except Exception as w:
    print(w.args) # this is some other Python Exception</pre>
<p>The <code class="docutils literal notranslate"><span class="pre">Error</span></code> class is a subclass of <code class="docutils literal notranslate"><span class="pre">Exception</span></code> used to differentiate
application-specific exceptions from other Python exceptions.
It does no additional processing, but merely creates a distinct class to facilitate writing <code class="docutils literal notranslate"><span class="pre">except</span></code> statements.</p>
<p class="rubric" id="error-class-defines-the-errors-raised-53">Error class defines the errors raised (53) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Error</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Error class defines the errors raised (53)</em>.
Used by     → <a class="reference internal" href="#pyweb-py-80">pyweb.py (80)</a>.</p>
</div>
</section>
<section id="action-class-hierarchy">
<h4><a class="toc-backref" href="#id69" role="doc-backlink">Action Class Hierarchy</a><a class="headerlink" href="#action-class-hierarchy" title="Link to this heading">¶</a></h4>
<p>This application performs three major actions: loading the document web, weaving and tangling.
Generally, the use case is to perform a load, weave and tangle.
However, a less common use case is to first load and tangle output files, run a regression test and then load and weave a result that includes the test output file.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">-xw</span></code> option excludes the weave pass, doing only the tangle action.
The <code class="docutils literal notranslate"><span class="pre">-xt</span></code> option excludes the tangle pass, doing the weave action.</p>
<p>This two pass action might be embedded in the following type of Python program.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pyweb</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">runpy</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">pathlib</span><span class="o">,</span> <span class="nn">contextlib</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;source.log&quot;</span><span class="p">)</span>
<span class="n">Tangler</span><span class="p">()</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">web</span><span class="p">)</span>
<span class="k">with</span> <span class="n">log</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">target</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">redirect_stdout</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
        <span class="c1"># run the app, capturing the output</span>
        <span class="n">runpy</span><span class="o">.</span><span class="n">run_path</span><span class="p">(</span><span class="s1">&#39;source.py&#39;</span><span class="p">)</span>
        <span class="c1"># Alternatives include using pytest or doctest</span>
<span class="n">Weaver</span><span class="p">()</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">web</span><span class="p">,</span> <span class="s2">&quot;something.rst&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The first step runs <strong>py-web-lp</strong> , excluding the final weaving pass.
The second step runs the tangled program, <code class="docutils literal notranslate"><span class="pre">source.py</span></code>, and produces test results in
some log file, <code class="docutils literal notranslate"><span class="pre">source.log</span></code>.
The third step runs <strong>py-web-lp</strong>  excluding the tangle pass.
This produces a final document that includes the <code class="docutils literal notranslate"><span class="pre">source.log</span></code>  test results.</p>
<p>To accomplish this, we provide a class hierarchy that defines the various actions of the <strong>py-web-lp</strong>  application.
This class hierarchy defines an extensible set of fundamental actions.
This gives us the flexibility to create a simple sequence of actions and execute any combination of these.
It eliminates the need for a  forest of <code class="docutils literal notranslate"><span class="pre">if</span></code>-statements to determine precisely what will be done.</p>
<p>Each action has the potential to update the state of the overall application.
A partner with this command hierarchy is the <code class="docutils literal notranslate"><span class="pre">Application</span></code> class
that defines the application options, inputs and results.</p>
<p class="rubric" id="action-class-hierarchy-used-to-describe-actions-of-the-application-54">Action class hierarchy used to describe actions of the application (54) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span>→ `Action base class has common features of all actions (55)`_
→ `ActionSequence subclass that holds a sequence of other actions (58)`_
→ `WeaveAction subclass initiates the weave action (61)`_
→ `TangleAction subclass initiates the tangle action (64)`_
→ `LoadAction subclass loads the document web (67)`_
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Action class hierarchy used to describe actions of the application (54)</em>.
Used by     → <a class="reference internal" href="#pyweb-py-80">pyweb.py (80)</a>.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Action</span></code> class embodies the basic operations of <strong>py-web-lp</strong> .
The intent of this hierarchy is to both provide an easily expanded method of
adding new actions, but an easily specified list of actions for a particular
run of <strong>py-web-lp</strong> .</p>
<p>The overall process of the application is defined by an instance of <code class="docutils literal notranslate"><span class="pre">Action</span></code>.
This instance may be the <code class="docutils literal notranslate"><span class="pre">WeaveAction</span></code> instance, the <code class="docutils literal notranslate"><span class="pre">TangleAction</span></code> instance
or a <code class="docutils literal notranslate"><span class="pre">ActionSequence</span></code> instance.</p>
<p>The instance is constructed during parsing of the input parameters.
Then the  <code class="docutils literal notranslate"><span class="pre">Action</span></code> class <code class="docutils literal notranslate"><span class="pre">perform()</span></code> method is called to actually perform the action.
There are three standard <code class="docutils literal notranslate"><span class="pre">Action</span></code> instances available: an instance
that is a macro and does both tangling and weaving, an instance that excludes tangling, and an instance that excludes weaving.
These correspond to the command-line options.</p>
<pre class="literal-block">anOp = SomeAction(&quot;name&quot;)
anOp(<em>argparse.Namespace</em>)</pre>
<p>The <code class="docutils literal notranslate"><span class="pre">Action</span></code> is the base class for all action class definitions.
An <code class="docutils literal notranslate"><span class="pre">Action</span></code> has a number of common attributes.</p>
<dl class="field-list simple">
<dt class="field-odd">name<span class="colon">:</span></dt>
<dd class="field-odd"><p>A name for this action.</p>
</dd>
<dt class="field-even">options<span class="colon">:</span></dt>
<dd class="field-even"><p>The <code class="docutils literal notranslate"><span class="pre">argparse.Namespace</span></code> object.
A LoadAction will update this with the <code class="docutils literal notranslate"><span class="pre">Web</span></code> object that was loaded.</p>
</dd>
</dl>
<dl class="simple">
<dt>!start:</dt><dd><p>The time at which the action started.</p>
</dd>
</dl>
<p class="rubric" id="action-base-class-has-common-features-of-all-actions-55">Action base class has common features of all actions (55) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span>class Action:
    &quot;&quot;&quot;An action performed by pyWeb.&quot;&quot;&quot;
    start: float
    options: argparse.Namespace

    def __init__(self, name: str) -&gt; None:
        self.name = name
        self.logger = logging.getLogger(self.__class__.__qualname__)

    def __str__(self) -&gt; str:
        return f&quot;{self.name!s} [{self.options.web!s}]&quot;


→ `Action call method actually does the real work (56)`_


→ `Action final summary of what was done (57)`_
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Action base class has common features of all actions (55)</em>.
Used by     → <a class="reference internal" href="#action-class-hierarchy-used-to-describe-actions-of-the-application-54">Action class hierarchy used to describe actions of the application (54)</a>.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">__call__()</span></code> method does the real work of the action.
For the base class, it merely logs a message.  This is overridden
by a subclass.</p>
<p class="rubric" id="action-call-method-actually-does-the-real-work-56">Action call method actually does the real work (56) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">process_time</span><span class="p">()</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Action call method actually does the real work (56)</em>.
Used by     → <a class="reference internal" href="#action-base-class-has-common-features-of-all-actions-55">Action base class has common features of all actions (55)</a>.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">summary()</span></code> method returns some basic processing statistics for this action.</p>
<p class="rubric" id="action-final-summary-of-what-was-done-57">Action final summary of what was done (57) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">duration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return duration of the action.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="ow">and</span> <span class="n">time</span><span class="o">.</span><span class="n">process_time</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">!s}</span><span class="s2"> in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">()</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2"> sec.&quot;</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Action final summary of what was done (57)</em>.
Used by     → <a class="reference internal" href="#action-base-class-has-common-features-of-all-actions-55">Action base class has common features of all actions (55)</a>.</p>
</div>
</section>
<section id="actionsequence-class">
<h4><a class="toc-backref" href="#id70" role="doc-backlink">ActionSequence Class</a><a class="headerlink" href="#actionsequence-class" title="Link to this heading">¶</a></h4>
<p>A <code class="docutils literal notranslate"><span class="pre">ActionSequence</span></code> defines a composite action; it is a sequence of other actions.
When the macro is performed, it delegates to the  sub-actions.</p>
<p>The instance is created during parsing of input parameters.
An instance of this class is one of the three standard actions available;
it generally is the default, “do everything”  action.</p>
<p>This class overrides the <code class="docutils literal notranslate"><span class="pre">perform()</span></code> method of the superclass.
It also adds an <code class="docutils literal notranslate"><span class="pre">append()</span></code> method that is used to construct the sequence of actions.</p>
<p class="rubric" id="actionsequence-subclass-that-holds-a-sequence-of-other-actions-58">ActionSequence subclass that holds a sequence of other actions (58) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span>class ActionSequence(Action):
    &quot;&quot;&quot;An action composed of a sequence of other actions.&quot;&quot;&quot;
    def __init__(self, name: str, opSequence: list[Action] | None = None) -&gt; None:
        super().__init__(name)
        if opSequence: self.opSequence = opSequence
        else: self.opSequence = []

    def __str__(self) -&gt; str:
        return &quot;; &quot;.join([str(x) for x in self.opSequence])


→ `ActionSequence call method delegates the sequence of ations (59)`_


→ `ActionSequence summary summarizes each step (60)`_
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>ActionSequence subclass that holds a sequence of other actions (58)</em>.
Used by     → <a class="reference internal" href="#action-class-hierarchy-used-to-describe-actions-of-the-application-54">Action class hierarchy used to describe actions of the application (54)</a>.</p>
</div>
<p>Since the macro <code class="docutils literal notranslate"><span class="pre">__call__()</span></code> method delegates to other Actions,
it is possible to short-cut argument processing by using the Python
<code class="docutils literal notranslate"><span class="pre">*args</span></code> construct to accept all arguments and pass them to each
sub-action.</p>
<p class="rubric" id="actionsequence-call-method-delegates-the-sequence-of-ations-59">ActionSequence call method delegates the sequence of ations (59) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opSequence</span><span class="p">:</span>
        <span class="n">o</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>ActionSequence call method delegates the sequence of ations (59)</em>.
Used by     → <a class="reference internal" href="#actionsequence-subclass-that-holds-a-sequence-of-other-actions-58">ActionSequence subclass that holds a sequence of other actions (58)</a>.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">summary()</span></code> method returns some basic processing
statistics for each step of this action.</p>
<p class="rubric" id="actionsequence-summary-summarizes-each-step-60">ActionSequence summary summarizes each step (60) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">o</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opSequence</span><span class="p">])</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>ActionSequence summary summarizes each step (60)</em>.
Used by     → <a class="reference internal" href="#actionsequence-subclass-that-holds-a-sequence-of-other-actions-58">ActionSequence subclass that holds a sequence of other actions (58)</a>.</p>
</div>
</section>
<section id="weaveaction-class">
<h4><a class="toc-backref" href="#id71" role="doc-backlink">WeaveAction Class</a><a class="headerlink" href="#weaveaction-class" title="Link to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">WeaveAction</span></code> defines the action of weaving.
This action logs a message, and invokes the <code class="docutils literal notranslate"><span class="pre">weave()</span></code> method of the <code class="docutils literal notranslate"><span class="pre">Web</span></code> instance.
This method also includes the basic decision on which weaver to use.
If a <code class="docutils literal notranslate"><span class="pre">Weaver</span></code> was specified on the command line, this instance is used.
Otherwise, the first few characters are examined and a weaver is selected.</p>
<p>This class overrides the <code class="docutils literal notranslate"><span class="pre">__call__()</span></code> method of the superclass.</p>
<p>If the options include <code class="docutils literal notranslate"><span class="pre">theWeaver</span></code>, specifying the <code class="docutils literal notranslate"><span class="pre">Weaver</span></code> instance to be used.</p>
<p class="rubric" id="weaveaction-subclass-initiates-the-weave-action-61">WeaveAction subclass initiates the weave action (61) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span>class WeaveAction(Action):
    &quot;&quot;&quot;Weave the final document.&quot;&quot;&quot;
    def __init__(self) -&gt; None:
        super().__init__(&quot;Weave&quot;)

    def __str__(self) -&gt; str:
        return f&quot;{self.name!s} [{self.options.web!s}, {self.options.theWeaver!s}]&quot;


→ `WeaveAction call method to weave (62)`_


→ `WeaveAction summary (63)`_
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>WeaveAction subclass initiates the weave action (61)</em>.
Used by     → <a class="reference internal" href="#action-class-hierarchy-used-to-describe-actions-of-the-application-54">Action class hierarchy used to describe actions of the application (54)</a>.</p>
</div>
<p>The language for the weaver templates is set just prior to weaving.
Weaving can only raise an exception when there is a reference to a chunk that
is never defined.</p>
<p class="rubric" id="weaveaction-call-method-to-weave-62">WeaveAction call method to weave (62) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">theWeaver</span><span class="o">.</span><span class="n">set_markup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">weaver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">theWeaver</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">web</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished Normally&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Problems weaving document from </span><span class="si">%r</span><span class="s2"> (weave file is faulty).&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">web_path</span><span class="p">)</span>
        <span class="c1">#raise</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>WeaveAction call method to weave (62)</em>.
Used by     → <a class="reference internal" href="#weaveaction-subclass-initiates-the-weave-action-61">WeaveAction subclass initiates the weave action (61)</a>.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">summary()</span></code> method returns some basic processing
statistics for the weave action.</p>
<p class="rubric" id="weaveaction-summary-63">WeaveAction summary (63) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">theWeaver</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">theWeaver</span><span class="o">.</span><span class="n">linesWritten</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">!s}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">theWeaver</span><span class="o">.</span><span class="n">linesWritten</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> lines in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">()</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2"> sec.&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;did not </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">!s}</span><span class="s2">&quot;</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>WeaveAction summary (63)</em>.
Used by     → <a class="reference internal" href="#weaveaction-subclass-initiates-the-weave-action-61">WeaveAction subclass initiates the weave action (61)</a>.</p>
</div>
</section>
<section id="tangleaction-class">
<h4><a class="toc-backref" href="#id72" role="doc-backlink">TangleAction Class</a><a class="headerlink" href="#tangleaction-class" title="Link to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">TangleAction</span></code> defines the action of tangling.
This operation logs a message, and invokes the <code class="docutils literal notranslate"><span class="pre">weave()</span></code> method of the <code class="docutils literal notranslate"><span class="pre">Web</span></code> instance.
This method also includes the basic decision on which weaver to use.
If a <code class="docutils literal notranslate"><span class="pre">Weaver</span></code> was specified on the command line, this instance is used.  Otherwise, the first few characters are examined and a weaver is selected.</p>
<p>This class overrides the <code class="docutils literal notranslate"><span class="pre">__call__()</span></code> method of the superclass.</p>
<p>The options <strong>must</strong> include <code class="docutils literal notranslate"><span class="pre">theTangler</span></code>, with the <code class="docutils literal notranslate"><span class="pre">Tangler</span></code> instance to be used.</p>
<p class="rubric" id="tangleaction-subclass-initiates-the-tangle-action-64">TangleAction subclass initiates the tangle action (64) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span>class TangleAction(Action):
    &quot;&quot;&quot;Tangle source files.&quot;&quot;&quot;
    def __init__(self) -&gt; None:
        super().__init__(&quot;Tangle&quot;)


→ `TangleAction call method does tangling of the output files (65)`_


→ `TangleAction summary method provides total lines tangled (66)`_
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>TangleAction subclass initiates the tangle action (64)</em>.
Used by     → <a class="reference internal" href="#action-class-hierarchy-used-to-describe-actions-of-the-application-54">Action class hierarchy used to describe actions of the application (54)</a>.</p>
</div>
<p>Tangling can only raise an exception when a cross reference request (<code class="docutils literal notranslate"><span class="pre">&#64;f</span></code>, <code class="docutils literal notranslate"><span class="pre">&#64;m</span></code> or <code class="docutils literal notranslate"><span class="pre">&#64;u</span></code>) occurs in a program code chunk.
Program code chunks are defined  with any of <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> or <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code>  and use <code class="docutils literal notranslate"><span class="pre">&#64;{</span></code> <code class="docutils literal notranslate"><span class="pre">&#64;}</span></code> brackets.</p>
<p class="rubric" id="tangleaction-call-method-does-tangling-of-the-output-files-65">TangleAction call method does tangling of the output files (65) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">theTangler</span><span class="o">.</span><span class="n">include_line_numbers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">tangler_line_numbers</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">theTangler</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">web</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Problems tangling outputs from </span><span class="si">%r</span><span class="s2"> (tangle files are faulty).&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">web_path</span><span class="p">)</span>
        <span class="c1">#raise</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>TangleAction call method does tangling of the output files (65)</em>.
Used by     → <a class="reference internal" href="#tangleaction-subclass-initiates-the-tangle-action-64">TangleAction subclass initiates the tangle action (64)</a>.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">summary()</span></code> method returns some basic processing
statistics for the tangle action.</p>
<p class="rubric" id="tangleaction-summary-method-provides-total-lines-tangled-66">TangleAction summary method provides total lines tangled (66) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">theTangler</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">theTangler</span><span class="o">.</span><span class="n">linesWritten</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">!s}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">theTangler</span><span class="o">.</span><span class="n">totalLines</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> lines in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">()</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2"> sec.&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;did not </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">!r}</span><span class="s2">&quot;</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>TangleAction summary method provides total lines tangled (66)</em>.
Used by     → <a class="reference internal" href="#tangleaction-subclass-initiates-the-tangle-action-64">TangleAction subclass initiates the tangle action (64)</a>.</p>
</div>
</section>
<section id="loadaction-class">
<h4><a class="toc-backref" href="#id73" role="doc-backlink">LoadAction Class</a><a class="headerlink" href="#loadaction-class" title="Link to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">LoadAction</span></code> defines the action of loading the web structure.
This action uses the application’s <code class="docutils literal notranslate"><span class="pre">webReader</span></code> to actually do the load.</p>
<p>An instance is created during parsing of the input parameters.
An instance of this class is part of any of the weave, tangle and “do everything” action.</p>
<p>This class overrides the <code class="docutils literal notranslate"><span class="pre">__call__()</span></code> method of the superclass.</p>
<p>The options <strong>must</strong> include <code class="docutils literal notranslate"><span class="pre">webReader</span></code>, with the <code class="docutils literal notranslate"><span class="pre">WebReader</span></code> instance to be used.</p>
<p class="rubric" id="loadaction-subclass-loads-the-document-web-67">LoadAction subclass loads the document web (67) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span>class LoadAction(Action):
    &quot;&quot;&quot;Load the source web.&quot;&quot;&quot;
    def __init__(self) -&gt; None:
        super().__init__(&quot;Load&quot;)

    def __str__(self) -&gt; str:
        return f&quot;Load [{self.webReader!s}, {self.options.web!s}]&quot;


→ `LoadAction call method loads the input files (68)`_


→ `LoadAction summary provides lines read (69)`_
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>LoadAction subclass loads the document web (67)</em>.
Used by     → <a class="reference internal" href="#action-class-hierarchy-used-to-describe-actions-of-the-application-54">Action class hierarchy used to describe actions of the application (54)</a>.</p>
</div>
<p>Trying to load the web involves two steps, either of which can raise
exceptions due to incorrect inputs.</p>
<ol class="arabic simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">WebReader</span></code> class <code class="docutils literal notranslate"><span class="pre">load()</span></code> method can raise exceptions for a number of
syntax errors as well as OS errors.</p>
<ul class="simple">
<li><p>Missing closing brackets (<code class="docutils literal notranslate"><span class="pre">&#64;}</span></code>, <code class="docutils literal notranslate"><span class="pre">&#64;]</span></code> or <code class="docutils literal notranslate"><span class="pre">&#64;&gt;</span></code>).</p></li>
<li><p>Missing opening bracket (<code class="docutils literal notranslate"><span class="pre">&#64;{</span></code> or <code class="docutils literal notranslate"><span class="pre">&#64;[</span></code>) after a chunk name (<code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> or <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code>).</p></li>
<li><p>Extra brackets (<code class="docutils literal notranslate"><span class="pre">&#64;{</span></code>, <code class="docutils literal notranslate"><span class="pre">&#64;[</span></code>, <code class="docutils literal notranslate"><span class="pre">&#64;}</span></code>, <code class="docutils literal notranslate"><span class="pre">&#64;]</span></code>).</p></li>
<li><p>Extra <code class="docutils literal notranslate"><span class="pre">&#64;|</span></code>.</p></li>
<li><p>The input file does not exist or is not readable.</p></li>
</ul>
</li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">Web</span></code> class <code class="docutils literal notranslate"><span class="pre">createUsedBy()</span></code> method can raise an exception when a
chunk reference cannot be resolved to a named chunk.</p></li>
</ol>
<p class="rubric" id="loadaction-call-method-loads-the-input-files-68">LoadAction call method loads the input files (68) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">webReader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">webReader</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">webReader</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">command</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">webReader</span><span class="o">.</span><span class="n">permitList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">permitList</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Reader Class </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">webReader</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="n">error</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Problems with source file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">source_path</span><span class="si">!r}</span><span class="s2">, no output produced.&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">webReader</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">source_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">webReader</span><span class="o">.</span><span class="n">errors</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Syntax Errors in the Web&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Read </span><span class="si">%d</span><span class="s2"> Chunks&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">web</span> <span class="o">=</span> <span class="n">Web</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">web_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">source_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Web contains </span><span class="si">%3d</span><span class="s2"> chunks&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">chunks</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Web defines  </span><span class="si">%3d</span><span class="s2"> files&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">files</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Web defines  </span><span class="si">%3d</span><span class="s2"> macros&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">macros</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Web defines  </span><span class="si">%3d</span><span class="s2"> names&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">userids</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="k">raise</span>  <span class="c1"># Could not be parsed or built.</span>
    <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="k">raise</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>LoadAction call method loads the input files (68)</em>.
Used by     → <a class="reference internal" href="#loadaction-subclass-loads-the-document-web-67">LoadAction subclass loads the document web (67)</a>.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">summary()</span></code> method returns some basic processing
statistics for the load action.</p>
<p class="rubric" id="loadaction-summary-provides-lines-read-69">LoadAction summary provides lines read (69) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">!s}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">webReader</span><span class="o">.</span><span class="n">totalLines</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> lines from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">webReader</span><span class="o">.</span><span class="n">totalFiles</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> files in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">()</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2"> sec.&quot;</span>
    <span class="p">)</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>LoadAction summary provides lines read (69)</em>.
Used by     → <a class="reference internal" href="#loadaction-subclass-loads-the-document-web-67">LoadAction subclass loads the document web (67)</a>.</p>
</div>
</section>
<section id="the-application-class">
<h4><a class="toc-backref" href="#id74" role="doc-backlink">The Application Class</a><a class="headerlink" href="#the-application-class" title="Link to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">Application</span></code> class is provided so that the <code class="docutils literal notranslate"><span class="pre">Action</span></code> instances have an overall application to update.
This allows the <code class="docutils literal notranslate"><span class="pre">WeaveAction</span></code> to  provide the selected <code class="docutils literal notranslate"><span class="pre">Weaver</span></code> instance to the application.
It also provides a central location for the various options and alternatives that might be accepted from the the configuration file and the command line.</p>
<p>Note the binding of working directories:</p>
<ul class="simple">
<li><p>Weaver writes to <code class="docutils literal notranslate"><span class="pre">Path.cwd()</span> <span class="pre">/</span> <span class="pre">&quot;docs&quot;</span></code>. The <code class="docutils literal notranslate"><span class="pre">-o</span></code> option resets this.
<code class="docutils literal notranslate"><span class="pre">-o</span> <span class="pre">.</span></code> is previous version behavior.</p></li>
<li><p>Tangler writes to <code class="docutils literal notranslate"><span class="pre">Path.cwd()</span></code>. Previously, the <code class="docutils literal notranslate"><span class="pre">-o</span></code> option controlled this.
Now, there’s a <code class="docutils literal notranslate"><span class="pre">-t</span></code> <code class="docutils literal notranslate"><span class="pre">--target</span></code> option for a tangling directory, if needed.</p></li>
</ul>
<p>The constructor creates a default <code class="docutils literal notranslate"><span class="pre">argparse.Namespace</span></code> with values
suitable for weaving and tangling.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">parseArgs()</span></code> method uses the <code class="docutils literal notranslate"><span class="pre">sys.argv</span></code> sequence to  parse the command line arguments and update the options.
This allows another application to pre-process the arguments, passing other arguments to this module’s class definitions.</p>
<p>After this, the <code class="docutils literal notranslate"><span class="pre">process()</span></code> method processes the list of files defined by given argument values.
The configuration can be either a <code class="docutils literal notranslate"><span class="pre">types.SimpleNamespace</span></code> or an
<code class="docutils literal notranslate"><span class="pre">argparse.Namespace</span></code> instance.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">parseArgs()</span></code> and <code class="docutils literal notranslate"><span class="pre">process()</span></code> functions are separated so that
another application can <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">pyweb</span></code>, bypass command-line parsing, yet still perform
the basic actions consistently.
For example:</p>
<pre class="literal-block">import pyweb, argparse, sys, tomllib

config = tomlib.load((Path.cwd() / &quot;yourapp.toml&quot;).read_bytes())

p = argparse.ArgumentParser()
<em>argument definitions</em>
p.set_defaults(**config)
args = p.parse_args(sys.argv[1:])

a = pyweb.Application()
args = a.expand(args)
a.process(args)</pre>
<p>The built-in behavior is defined by the <code class="docutils literal notranslate"><span class="pre">main()</span></code> function.
This creates an <code class="docutils literal notranslate"><span class="pre">Application</span></code> instance and calls the <code class="docutils literal notranslate"><span class="pre">args</span> <span class="pre">=</span> <span class="pre">application.parseArgs(sys.argv[1:],</span> <span class="pre">**defaults)</span></code>, and <code class="docutils literal notranslate"><span class="pre">process(args)</span></code> methods.
This provides the expected behavior for this module when it is used as the main program.</p>
<p class="rubric" id="imports-70">Imports (70) +=</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">shlex</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Imports (70)</em>.
Used by     → <a class="reference internal" href="#pyweb-py-80">pyweb.py (80)</a>.</p>
</div>
<p class="rubric" id="application-class-for-overall-cli-operation-71">Application Class for overall CLI operation (71) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span>class Application:
    def __init__(self) -&gt; None:
        self.logger = logging.getLogger(self.__class__.__qualname__)

→ `Application default options (72)`_


→ `Application parse command line (73)`_


→ `Application class process all files (74)`_
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Application Class for overall CLI operation (71)</em>.
Used by     → <a class="reference internal" href="#pyweb-py-80">pyweb.py (80)</a>.</p>
</div>
<p>The first part of parsing the command line uses application defaults and an application configuration file to set default parameter values.
The default values are set as follows:</p>
<dl class="field-list simple">
<dt class="field-odd">webReader<span class="colon">:</span></dt>
<dd class="field-odd"><p>is the <code class="docutils literal notranslate"><span class="pre">WebReader</span></code> instance created for the current input file.</p>
</dd>
<dt class="field-even">doWeave<span class="colon">:</span></dt>
<dd class="field-even"><p>instance of <code class="docutils literal notranslate"><span class="pre">Action</span></code> that does weaving only.</p>
</dd>
<dt class="field-odd">doTangle<span class="colon">:</span></dt>
<dd class="field-odd"><p>instance of <code class="docutils literal notranslate"><span class="pre">Action</span></code> that does tangling only.</p>
</dd>
<dt class="field-even">theAction<span class="colon">:</span></dt>
<dd class="field-even"><p>is an instance of <code class="docutils literal notranslate"><span class="pre">Action</span></code> that describes
the default overall action: often load, tangle and weave.  This is the default unless
overridden by an option.</p>
</dd>
</dl>
<p>Here are the configuration values.
These are attributes of an <code class="docutils literal notranslate"><span class="pre">argparse.Namespace</span></code> default as well as the updated namespace returned by <code class="docutils literal notranslate"><span class="pre">parseArgs()</span></code>.</p>
<dl class="field-list simple">
<dt class="field-odd">verbosity<span class="colon">:</span></dt>
<dd class="field-odd"><p>Either <code class="docutils literal notranslate"><span class="pre">logging.INFO</span></code>, <code class="docutils literal notranslate"><span class="pre">logging.WARN</span></code> or <code class="docutils literal notranslate"><span class="pre">logging.DEBUG</span></code></p>
</dd>
<dt class="field-even">command<span class="colon">:</span></dt>
<dd class="field-even"><p>is set to <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> as the  default command introducer.</p>
</dd>
<dt class="field-odd">permit<span class="colon">:</span></dt>
<dd class="field-odd"><p>The raw list of permitted command characters, perhaps <code class="docutils literal notranslate"><span class="pre">'i'</span></code>.</p>
</dd>
<dt class="field-even">permitList<span class="colon">:</span></dt>
<dd class="field-even"><p>provides a list of commands that are permitted
to fail.  Typically this is empty, or contains <code class="docutils literal notranslate"><span class="pre">&#64;i</span></code> to allow the include
command to fail.</p>
</dd>
<dt class="field-odd">files<span class="colon">:</span></dt>
<dd class="field-odd"><p>is the final list of argument files from the command line;
these will be processed unless overridden in the call to <code class="docutils literal notranslate"><span class="pre">process()</span></code>.</p>
</dd>
<dt class="field-even">skip<span class="colon">:</span></dt>
<dd class="field-even"><p>a list of steps to skip: perhaps <code class="docutils literal notranslate"><span class="pre">'w'</span></code> or <code class="docutils literal notranslate"><span class="pre">'t'</span></code> to skip weaving or tangling.</p>
</dd>
<dt class="field-odd">weaver<span class="colon">:</span></dt>
<dd class="field-odd"><p>the short name of the weaver.</p>
</dd>
<dt class="field-even">theTangler<span class="colon">:</span></dt>
<dd class="field-even"><p>is set to a <code class="docutils literal notranslate"><span class="pre">TanglerMake</span></code> instance
to create the output files.</p>
</dd>
<dt class="field-odd">theWeaver<span class="colon">:</span></dt>
<dd class="field-odd"><p>is set to an instance of a subclass of <code class="docutils literal notranslate"><span class="pre">Weaver</span></code> based on <code class="docutils literal notranslate"><span class="pre">weaver</span></code></p>
</dd>
</dl>
<p class="rubric" id="application-default-options-72">Application default options (72) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">(</span>
    <span class="n">verbosity</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
    <span class="n">command</span><span class="o">=</span><span class="s1">&#39;@&#39;</span><span class="p">,</span>
    <span class="n">weaver</span><span class="o">=</span><span class="s1">&#39;rst&#39;</span><span class="p">,</span>
    <span class="n">skip</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>  <span class="c1"># Don&#39;t skip any steps</span>
    <span class="n">permit</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>  <span class="c1"># Don&#39;t tolerate failing commands</span>
    <span class="n">reference</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span>  <span class="c1"># Simple references</span>
    <span class="n">tangler_line_numbers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">output</span><span class="o">=</span><span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;docs&quot;</span><span class="p">,</span>  <span class="c1"># Weaving output</span>
    <span class="n">target</span><span class="o">=</span><span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">(),</span>  <span class="c1"># Tangling output</span>
    <span class="p">)</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Application default options (72)</em>.
Used by     → <a class="reference internal" href="#application-class-for-overall-cli-operation-71">Application Class for overall CLI operation (71)</a>.</p>
</div>
<p>The algorithm for parsing the command line parameters uses the built in <code class="docutils literal notranslate"><span class="pre">argparse</span></code> module.
We have to build a parser, define the options, and the parse the command-line arguments, updating the default namespace.</p>
<p>The last step is to create argument values where string values are transformed into more useful objects.
Also, in some cases, derived objects are created from the parameterv values.</p>
<p class="rubric" id="application-parse-command-line-73">Application parse command line (73) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">parseArgs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argv</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">**</span><span class="n">config</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="s2">&quot;--verbose&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;verbosity&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_const&quot;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-s&quot;</span><span class="p">,</span> <span class="s2">&quot;--silent&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;verbosity&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_const&quot;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">WARN</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-d&quot;</span><span class="p">,</span> <span class="s2">&quot;--debug&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;verbosity&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_const&quot;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="s2">&quot;--command&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;command&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-w&quot;</span><span class="p">,</span> <span class="s2">&quot;--weaver&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;weaver&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-x&quot;</span><span class="p">,</span> <span class="s2">&quot;--except&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="s2">&quot;--permit&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;permit&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-n&quot;</span><span class="p">,</span> <span class="s2">&quot;--linenumbers&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;tangler_line_numbers&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="s2">&quot;--output&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Weaver output&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-t&quot;</span><span class="p">,</span> <span class="s2">&quot;--target&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Tangler output&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-V&quot;</span><span class="p">,</span> <span class="s2">&quot;--Version&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;py-web-lp pyweb.py </span><span class="si">{</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;files&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">)</span>

    <span class="n">defaults</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">)</span> <span class="o">|</span> <span class="n">config</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">(</span><span class="o">**</span><span class="n">defaults</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>

    <span class="c1"># Expand the permitted errors, usual case is ``-pi`` to permit the ``@i`` command to fail.</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">permit</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">permitList</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">command</span><span class="si">!s}{</span><span class="n">c</span><span class="si">!s}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">permit</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">permitList</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">return</span> <span class="n">args</span>

<span class="k">def</span> <span class="nf">inject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Inject final classes by creating instances.</span>
<span class="sd">    This **updates** the args namespace.</span>
<span class="sd">    It puts concrete classes in place.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Primitive Actions</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">loadOp</span> <span class="o">=</span> <span class="n">LoadAction</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">weaveOp</span> <span class="o">=</span> <span class="n">WeaveAction</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tangleOp</span> <span class="o">=</span> <span class="n">TangleAction</span><span class="p">()</span>

    <span class="c1"># Composite Actions</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">doWeave</span> <span class="o">=</span> <span class="n">ActionSequence</span><span class="p">(</span><span class="s2">&quot;load and weave&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loadOp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weaveOp</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">doTangle</span> <span class="o">=</span> <span class="n">ActionSequence</span><span class="p">(</span><span class="s2">&quot;load and tangle&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loadOp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tangleOp</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">theAction</span> <span class="o">=</span> <span class="n">ActionSequence</span><span class="p">(</span><span class="s2">&quot;load, tangle and weave&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loadOp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tangleOp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weaveOp</span><span class="p">])</span>

    <span class="c1"># Create Weaver &amp; Tangler used by the Actions.</span>
    <span class="c1"># Update Weaver macros from config file.</span>
    <span class="n">args</span><span class="o">.</span><span class="n">theWeaver</span> <span class="o">=</span> <span class="n">Weaver</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;macros&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">theWeaver</span><span class="o">.</span><span class="n">config_macros</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">macros</span>
    <span class="n">args</span><span class="o">.</span><span class="n">theTangler</span> <span class="o">=</span> <span class="n">TanglerMake</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>

    <span class="c1"># Create the configured WebReader used by the Actions.</span>
    <span class="n">args</span><span class="o">.</span><span class="n">webReader</span> <span class="o">=</span> <span class="n">WebReader</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;config: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">args</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Application parse command line (73)</em>.
Used by     → <a class="reference internal" href="#application-class-for-overall-cli-operation-71">Application Class for overall CLI operation (71)</a>.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">process()</span></code> function uses the final <code class="docutils literal notranslate"><span class="pre">argparse.Namespace</span></code> to process each file as follows:</p>
<ol class="arabic simple">
<li><p>Create a new <code class="docutils literal notranslate"><span class="pre">WebReader</span></code> for the <code class="docutils literal notranslate"><span class="pre">Application</span></code>, providing
the parameters required to process the input file.</p></li>
<li><p>Create a <code class="docutils literal notranslate"><span class="pre">Web</span></code> instance, <em>w</em>,
and set the Web’s <em>sourceFileName</em> from the WebReader’s <em>filePath</em>.</p></li>
<li><p>Perform the given command, typically a <code class="docutils literal notranslate"><span class="pre">ActionSequence</span></code>,
which does some combination of load, tangle the output files and
weave the final document in the target markup language.</p></li>
<li><p>Print a performance summary line that shows lines processed per second.</p></li>
</ol>
<p>In the event of failure in any of the major processing steps, a summary message is produced to clarify the state of the output files, and the exception is reraised.
The re-raising is done so that all exceptions are handled by the outermost main program.</p>
<p class="rubric" id="application-class-process-all-files-74">Application class process all files (74) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
    <span class="n">root</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">verbosity</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting root log level to </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLevelName</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">getEffectiveLevel</span><span class="p">()))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">command</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Command character </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">command</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">skip</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">skip</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">):</span>  <span class="c1"># not weaving == tangling</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">theAction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doTangle</span>
        <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">skip</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">):</span>  <span class="c1"># not tangling == weaving</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">theAction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doWeave</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown -x option </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">skip</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theAction</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">__version__</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">source_path</span> <span class="o">=</span> <span class="n">f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theAction</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theAction</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Application class process all files (74)</em>.
Used by     → <a class="reference internal" href="#application-class-for-overall-cli-operation-71">Application Class for overall CLI operation (71)</a>.</p>
</div>
</section>
<section id="logging-setup">
<h4><a class="toc-backref" href="#id75" role="doc-backlink">Logging Setup</a><a class="headerlink" href="#logging-setup" title="Link to this heading">¶</a></h4>
<p>We’ll create a logging context manager.
This allows us to wrap the <code class="docutils literal notranslate"><span class="pre">main()</span></code> function in an explicit <code class="docutils literal notranslate"><span class="pre">with</span></code> statement that assures that logging is configured and cleaned up politely.</p>
<p class="rubric" id="imports-75">Imports (75) +=</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">logging.config</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Imports (75)</em>.
Used by     → <a class="reference internal" href="#pyweb-py-80">pyweb.py (80)</a>.</p>
</div>
<p>This has two configuration approaches.
If a positional argument is given, that dictionary is used for <code class="docutils literal notranslate"><span class="pre">logging.config.dictConfig</span></code>.
Otherwise, keyword arguments are provided to <code class="docutils literal notranslate"><span class="pre">logging.basicConfig</span></code>.</p>
<p>A subclass might properly load a dictionary encoded in TOML or YAML and use that with <code class="docutils literal notranslate"><span class="pre">logging.config.dictConfig</span></code>.</p>
<p class="rubric" id="logging-setup-76">Logging Setup (76) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Logger</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw_config</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dict_config</span> <span class="o">=</span> <span class="n">dict_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kw_config</span> <span class="o">=</span> <span class="n">kw_config</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Logger&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_config</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dictConfig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dict_config</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kw_config</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">False</span><span class="p">]:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">False</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Logging Setup (76)</em>.
Used by     → <a class="reference internal" href="#pyweb-py-80">pyweb.py (80)</a>.</p>
</div>
<p>Here’s a sample logging setup.
This creates a simple console handler and a formatter that matches the <code class="docutils literal notranslate"><span class="pre">basicConfig</span></code> formatter.</p>
<p>This configuration dictionary defines the root logger plus some overrides for class loggers that might be used to gather additional information.</p>
<p class="rubric" id="logging-setup-77">Logging Setup (77) +=</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">default_logging_config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;disable_existing_loggers&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># Allow pre-existing loggers to work.</span>
    <span class="s1">&#39;style&#39;</span><span class="p">:</span> <span class="s1">&#39;{&#39;</span><span class="p">,</span>
    <span class="s1">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;console&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;logging.StreamHandler&#39;</span><span class="p">,</span>
            <span class="s1">&#39;stream&#39;</span><span class="p">:</span> <span class="s1">&#39;ext://sys.stderr&#39;</span><span class="p">,</span>
            <span class="s1">&#39;formatter&#39;</span><span class="p">:</span> <span class="s1">&#39;basic&#39;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="s1">&#39;formatters&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;basic&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{levelname}</span><span class="s2">:</span><span class="si">{name}</span><span class="s2">:</span><span class="si">{message}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s1">&#39;style&#39;</span><span class="p">:</span> <span class="s2">&quot;{&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">},</span>

    <span class="s1">&#39;root&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;console&#39;</span><span class="p">],</span> <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,},</span>

    <span class="c1"># For specific debugging support...</span>
    <span class="s1">&#39;loggers&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;Weaver&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">},</span>
        <span class="s1">&#39;WebReader&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">},</span>
        <span class="s1">&#39;Tangler&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">},</span>
        <span class="s1">&#39;TanglerMake&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">},</span>
        <span class="s1">&#39;indent.TanglerMake&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">},</span>
        <span class="s1">&#39;Web&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">},</span>
        <span class="c1"># Unit test requires this...</span>
        <span class="s1">&#39;ReferenceCommand&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">},</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Logging Setup (77)</em>.
Used by     → <a class="reference internal" href="#pyweb-py-80">pyweb.py (80)</a>.</p>
</div>
<p>The above is wired into the application as a default.
Exposing this via a configuration file is better.</p>
<p class="rubric" id="pyweb-toml-78">pyweb.toml (78) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span>[pyweb]
# PyWeb options go here.
# Override macro definitions.
# macros = [
# &quot;&quot;&quot;{% macro begin_code(chunk) %}...{% endmacro %}&quot;&quot;&quot;,
# &quot;&quot;&quot;{% macro end_code(chunk) %}...{% endmacro %}&quot;&quot;&quot;
# ]

[logging]
version = 1
disable_existing_loggers = false

[logging.root]
handlers = [&quot;console&quot;,]
level = &quot;DEBUG&quot;

[logging.handlers.console]
class = &quot;logging.StreamHandler&quot;
stream = &quot;ext://sys.stderr&quot;
formatter = &quot;basic&quot;

[logging.formatters.basic]
format = &quot;{levelname}:{name}:{message}&quot;
style = &quot;{&quot;

[logging.loggers.Application]
level = &quot;INFO&quot;

[logging.loggers.Weaver]
level = &quot;INFO&quot;

[logging.loggers.WebReader]
level = &quot;INFO&quot;

[logging.loggers.Tangler]
level = &quot;INFO&quot;

[logging.loggers.TanglerMake]
level = &quot;INFO&quot;

[logging.loggers.indent.TanglerMake]
level = &quot;INFO&quot;

[logging.loggers.ReferenceCommand]
# Unit test requires this...
level = &quot;INFO&quot;
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>pyweb.toml (78)</em>.</p>
</div>
<p>We can load this with something like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">config_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;pyweb.toml&quot;</span><span class="p">)</span>
<span class="k">with</span> <span class="n">config_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">config_file</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">toml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
<span class="n">log_config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logging&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">})</span>
</pre></div>
</div>
<p>This makes it slightly easier to add and change debuging alternatives.
Rather then use the <code class="docutils literal notranslate"><span class="pre">-v</span></code> and <code class="docutils literal notranslate"><span class="pre">-d</span></code> options, the <code class="docutils literal notranslate"><span class="pre">pyweb.toml</span></code>
provides a complete logging config.</p>
<p>Also, we might want a decorator to define loggers more consistently for each class definition.</p>
</section>
<section id="the-main-function">
<h4><a class="toc-backref" href="#id76" role="doc-backlink">The Main Function</a><a class="headerlink" href="#the-main-function" title="Link to this heading">¶</a></h4>
<p>The top-level interface is the <code class="docutils literal notranslate"><span class="pre">main()</span></code> function.
This function creates an <code class="docutils literal notranslate"><span class="pre">Application</span></code> instance.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Application</span></code> object parses the command-line arguments.
Then the <code class="docutils literal notranslate"><span class="pre">Application</span></code> object does the requested processing.
This two-step process allows for some dependency injection to customize argument processing.</p>
<p>We might also want to parse a logging configuration file, as well
as a weaver template configuration file.</p>
<p class="rubric" id="interface-functions-79">Interface Functions (79) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">argv</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">base_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">Application</span><span class="p">()</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">parseArgs</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">base_config</span> <span class="ow">or</span> <span class="p">{}))</span>
    <span class="n">a</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Interface Functions (79)</em>.
Used by     → <a class="reference internal" href="#pyweb-py-80">pyweb.py (80)</a>.</p>
</div>
</section>
</section>
<section id="pyweb-module-file">
<h3><a class="toc-backref" href="#id77" role="doc-backlink"><strong>pyWeb</strong> Module File</a><a class="headerlink" href="#pyweb-module-file" title="Link to this heading">¶</a></h3>
<p>The <strong>pyWeb</strong> application file is shown below:</p>
<p class="rubric" id="pyweb-py-80">pyweb.py (80) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span>→ `Overheads (82)`_
→ `Imports (2)`_
→ `Error class defines the errors raised (53)`_
→ `Base Class Definitions (1)`_
→ `Action class hierarchy used to describe actions of the application (54)`_
→ `Application Class for overall CLI operation (71)`_
→ `Logging Setup (76)`_
→ `Interface Functions (79)`_

if __name__ == &quot;__main__&quot;:
    config_dirs = Path.cwd(), Path.home(), Path(__file__).parent
    base_config: dict[str, Any] = {}
    for dir in config_dirs:
        cp = dir / &quot;pyweb.toml&quot;
        if cp.exists():
            with cp.open(&#39;rb&#39;) as config_file:
                base_config = toml.load(config_file)
            break
    log_config = base_config.get(&#39;logging&#39;, default_logging_config)
    with Logger(log_config):
        main(base_config=base_config.get(&#39;pyweb&#39;, {}))
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>pyweb.py (80)</em>.</p>
</div>
<p>The <a class="reference internal" href="#overheads">Overheads</a> are described below, they include things like:</p>
<ul class="simple">
<li><p>shell escape</p></li>
<li><p>doc string</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">__version__</span></code> setting</p></li>
</ul>
<p><a class="reference internal" href="#python-library-imports">Python Library Imports</a> are actually scattered in various places in this description.</p>
<p>The more important elements are described in separate sections:</p>
<ul class="simple">
<li><p>Base Class Definitions</p></li>
<li><p>Application Class and Main Functions</p></li>
<li><p>Interface Functions</p></li>
</ul>
<section id="python-library-imports">
<h4><a class="toc-backref" href="#id78" role="doc-backlink">Python Library Imports</a><a class="headerlink" href="#python-library-imports" title="Link to this heading">¶</a></h4>
<p>Numerous Python library modules are used by this application.</p>
<p>A few are listed here because they’re used widely. Others are listed
closer to where they’re referenced.</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">os</span></code> module provide os-specific file and path manipulations; it is used
to transform the input file name into the output file name as well as track down file modification
times.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">time</span></code> module provides a handy current-time string; this is used
to by the HTML Weaver to write a closing timestamp on generated HTML files,
as well as log messages.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">datetime</span></code> module is used to format times, phasing out use of <code class="docutils literal notranslate"><span class="pre">time</span></code>.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">types</span></code> module is used to get at <code class="docutils literal notranslate"><span class="pre">SimpleNamespace</span></code> for configuration.</p></li>
</ul>
<p class="rubric" id="imports-81">Imports (81) +=</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tomllib</span> <span class="k">as</span> <span class="nn">toml</span>
<span class="kn">import</span> <span class="nn">types</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Imports (81)</em>.
Used by     → <a class="reference internal" href="#pyweb-py-80">pyweb.py (80)</a>.</p>
</div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">os.path</span></code>, <code class="docutils literal notranslate"><span class="pre">time</span></code>, <code class="docutils literal notranslate"><span class="pre">datetime</span></code> and <code class="docutils literal notranslate"><span class="pre">platform`</span></code>
are provided in the expression context.</p>
</section>
<section id="overheads">
<h4><a class="toc-backref" href="#id79" role="doc-backlink">Overheads</a><a class="headerlink" href="#overheads" title="Link to this heading">¶</a></h4>
<p>The shell escape is provided so that the user can define this
file as executable, and launch it directly from their shell.
The shell reads the first line of a file; when it finds the <code class="docutils literal notranslate"><span class="pre">'#!'</span></code> shell
escape, the remainder of the line is taken as the path to the binary program
that should be run.  The shell runs this binary, providing the
file as standard input.</p>
<p class="rubric" id="overheads-82">Overheads (82) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Overheads (82)</em>.
Used by     → <a class="reference internal" href="#pyweb-py-80">pyweb.py (80)</a>.</p>
</div>
<p>A Python <code class="docutils literal notranslate"><span class="pre">__doc__</span></code> string provides a standard vehicle for documenting
the module or the application program.  The usual style is to provide
a one-sentence summary on the first line.  This is followed by more
detailed usage information.</p>
<p class="rubric" id="overheads-83">Overheads (83) +=</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;py-web-lp Literate Programming.</span>

<span class="sd">Yet another simple literate programming tool derived from **nuweb**,</span>
<span class="sd">implemented entirely in Python.</span>
<span class="sd">With a suitable configuration, this weaves documents with any markup language,</span>
<span class="sd">and tangles source files for any programming language.</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Overheads (83)</em>.
Used by     → <a class="reference internal" href="#pyweb-py-80">pyweb.py (80)</a>.</p>
</div>
<p>The keyword cruft is a standard way of placing version control information into
a Python module so it is preserved.  See PEP (Python Enhancement Proposal) #8 for information
on recommended styles.</p>
<p>We also sneak in a “DO NOT EDIT” warning that belongs in all generated application
source files.</p>
<p class="rubric" id="overheads-84">Overheads (84) +=</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;3.3&quot;&quot;&quot;</span>

<span class="c1">### DO NOT EDIT THIS FILE!</span>
<span class="c1">### It was created by src/pyweb.py, __version__=&#39;3.3&#39;.</span>
<span class="c1">### From source web/impl.w modified Thu Oct 24 08:57:55 2024.</span>
<span class="c1">### In working directory &#39;/Users/slott/Documents/Projects/py-web-tool&#39;.</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>Overheads (84)</em>.
Used by     → <a class="reference internal" href="#pyweb-py-80">pyweb.py (80)</a>.</p>
</div>
<p>This can be extended by doing something like the following.</p>
<ol class="arabic simple">
<li><p>Subclass <code class="docutils literal notranslate"><span class="pre">Weaver</span></code> create a subclass with different templates.</p></li>
<li><p>Update the <code class="docutils literal notranslate"><span class="pre">pyweb.weavers</span></code> dictionary.</p></li>
<li><p>Call <code class="docutils literal notranslate"><span class="pre">pyweb.main()</span></code> to run the existing
main program with extra classes available to it.</p></li>
</ol>
<pre class="literal-block">import pyweb
class MyWeaver(HTML):
   <em>Any template changes</em>

pyweb.weavers['myweaver']= MyWeaver()
pyweb.main()</pre>
<p>This will create a variant on <strong>py-web-lp</strong> that will handle a different
weaver via the command-line option <code class="docutils literal notranslate"><span class="pre">-w</span> <span class="pre">myweaver</span></code>.</p>
</section>
</section>
</section>
<section id="handy-scripts">
<h2><a class="toc-backref" href="#id80" role="doc-backlink">Handy Scripts</a><a class="headerlink" href="#handy-scripts" title="Link to this heading">¶</a></h2>
<p>Two aditional scripts, <code class="docutils literal notranslate"><span class="pre">tangle.py</span></code> and <code class="docutils literal notranslate"><span class="pre">weave.py</span></code>, are provided as examples which can be customized and extended.</p>
<section id="tangle-py-script">
<h3><a class="toc-backref" href="#id81" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">tangle.py</span></code> Script</a><a class="headerlink" href="#tangle-py-script" title="Link to this heading">¶</a></h3>
<p>This script shows a simple version of Tangling.
This has a permitted error for ‘&#64;i’ commands to allow an include file to be omitted from a tangle operation.
This permits a WEB to include the log from test output.
When tangling the code and test cases, the log is not available, and can be safely ignored.
When weaving a final document after testing, the log will be available.</p>
<p>Note the general flow of this top-level script.</p>
<ol class="arabic simple">
<li><p>Create the logging context.</p></li>
<li><p>Create the options. This hard-coded object is a stand-in for
parsing command-line options.</p></li>
<li><p>Create the <code class="docutils literal notranslate"><span class="pre">Web</span></code> object.</p></li>
<li><p>For each action (<code class="docutils literal notranslate"><span class="pre">LoadAction</span></code> and <code class="docutils literal notranslate"><span class="pre">TangleAction</span></code> in this example)
Set the web, set the options, execute the callable action, and write
a summary.</p></li>
</ol>
<p>Conspicuous by its absence is CLI parsing to get the name of a WEB file to process.</p>
<p class="rubric" id="tangle-py-85">tangle.py (85) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">&quot;&quot;&quot;Sample tangle.py script.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">pyweb</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">pyweb</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="n">pyweb</span><span class="o">.</span><span class="n">default_logging_config</span><span class="p">):</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>

        <span class="n">options</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">(</span>
            <span class="n">source_path</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
            <span class="n">output</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
            <span class="n">verbosity</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="s1">&#39;@&#39;</span><span class="p">,</span>
            <span class="n">permitList</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;@i&#39;</span><span class="p">],</span>
            <span class="n">tangler_line_numbers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">webReader</span><span class="o">=</span><span class="n">pyweb</span><span class="o">.</span><span class="n">WebReader</span><span class="p">(),</span>
            <span class="n">theTangler</span><span class="o">=</span><span class="n">pyweb</span><span class="o">.</span><span class="n">TanglerMake</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">parent</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Options </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">pyweb</span><span class="o">.</span><span class="n">LoadAction</span><span class="p">(),</span> <span class="n">pyweb</span><span class="o">.</span><span class="n">TangleAction</span><span class="p">():</span>
            <span class="n">action</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># CLI parsing goes here...</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;examples/test_rst.w&quot;</span><span class="p">)</span>
    <span class="n">main</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>tangle.py (85)</em>.</p>
</div>
</section>
<section id="weave-py-script">
<h3><a class="toc-backref" href="#id82" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">weave.py</span></code> Script</a><a class="headerlink" href="#weave-py-script" title="Link to this heading">¶</a></h3>
<p>This script shows a simple version of Weaving.
This shows how to define a customized set of templates for a new markup language, or to use new features of a supported language.</p>
<p>A customized weaver generally has three parts.</p>
<p class="rubric" id="weave-py-86">weave.py (86) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span>→ `weave.py overheads for correct operation of a script (87)`_

→ `weave.py custom weaver definition to customize the Weaver being used (88)`_

→ `weaver.py processing: load and weave the document (89)`_
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>weave.py (86)</em>.</p>
</div>
<p>Conspicuous by its absence is CLI parsing to get the name of a WEB file to process.</p>
<p class="rubric" id="weave-py-overheads-for-correct-operation-of-a-script-87">weave.py overheads for correct operation of a script (87) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">&quot;&quot;&quot;Sample weave.py script.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">textwrap</span> <span class="kn">import</span> <span class="n">dedent</span>

<span class="kn">import</span> <span class="nn">pyweb</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>weave.py overheads for correct operation of a script (87)</em>.
Used by     → <a class="reference internal" href="#weave-py-86">weave.py (86)</a>.</p>
</div>
<p>To override templates, a class needs to provide a list of text definitions for each Jinja <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">macro</span> <span class="pre">%}</span></code> definition.
This is used to update the base class
<code class="docutils literal notranslate"><span class="pre">template_name_map</span></code>, used by all <code class="docutils literal notranslate"><span class="pre">Weaver</span></code> classes.</p>
<p>Something like the following sets the macros in use.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">template_name_map</span><span class="p">[</span><span class="s1">&#39;html&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">my_templates</span><span class="p">,)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name_map</span><span class="p">[</span><span class="s1">&#39;html&#39;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The value of a template name is a tuple of definition lists, with the overriding definitions first, and the default definitions must follow later.
This will be used to build a <code class="docutils literal notranslate"><span class="pre">ChainMap</span></code>, ensuring the high-priority items defined first override the defaults defined later.</p>
<p class="rubric" id="weave-py-custom-weaver-definition-to-customize-the-weaver-being-used-88">weave.py custom weaver definition to customize the Weaver being used (88) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bootstrap_html</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">    {%- macro begin_code(chunk) %}</span>
<span class="s2">    &lt;div class=&quot;card&quot;&gt;</span>
<span class="s2">      &lt;div class=&quot;card-header&quot;&gt;</span>
<span class="s2">        &lt;a type=&quot;button&quot; class=&quot;btn btn-primary&quot; name=&quot;pyweb_{{chunk.seq}}&quot;&gt;&lt;/a&gt;</span>
<span class="s2">        &lt;!--line number {{chunk.location}}--&gt;</span>
<span class="s2">        &lt;p class=&quot;small&quot;&gt;&lt;em&gt;{{chunk.full_name or chunk.name}} ({{chunk.seq}})&lt;/em&gt; {</span><span class="si">% i</span><span class="s2">f chunk.initial %}={</span><span class="si">% e</span><span class="s2">lse %}+={</span><span class="si">% e</span><span class="s2">ndif %}&lt;/p&gt;</span>
<span class="s2">       &lt;/div&gt;</span>
<span class="s2">      &lt;div class=&quot;card-body&quot;&gt;</span>
<span class="s2">        &lt;pre&gt;&lt;code&gt;</span>
<span class="s2">    {</span><span class="si">%- e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">),</span>
    <span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">    {%- macro end_code(chunk) %}</span>
<span class="s2">        &lt;/code&gt;&lt;/pre&gt;</span>
<span class="s2">      &lt;/div&gt;</span>
<span class="s2">    &lt;div class=&quot;card-footer&quot;&gt;</span>
<span class="s2">      &lt;p&gt;&amp;#8718; &lt;em&gt;{{chunk.full_name or chunk.name}} ({{chunk.seq}})&lt;/em&gt;.</span>
<span class="s2">      &lt;/p&gt;</span>
<span class="s2">    &lt;/div&gt;</span>
<span class="s2">    &lt;/div&gt;</span>
<span class="s2">    {</span><span class="si">% e</span><span class="s2">ndmacro -%}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="p">]</span>

<span class="k">class</span> <span class="nc">MyHTML</span><span class="p">(</span><span class="n">pyweb</span><span class="o">.</span><span class="n">Weaver</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MyHTML </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template_name_map</span><span class="p">[</span><span class="s1">&#39;html&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">bootstrap_html</span><span class="p">,)</span> <span class="o">+</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">template_name_map</span><span class="p">[</span><span class="s1">&#39;html&#39;</span><span class="p">]</span>
        <span class="p">)</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>weave.py custom weaver definition to customize the Weaver being used (88)</em>.
Used by     → <a class="reference internal" href="#weave-py-86">weave.py (86)</a>.</p>
</div>
<p class="rubric" id="weaver-py-processing-load-and-weave-the-document-89">weaver.py processing: load and weave the document (89) =</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">pyweb</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="n">pyweb</span><span class="o">.</span><span class="n">default_logging_config</span><span class="p">):</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>

        <span class="n">options</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">(</span>
            <span class="n">source_path</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
            <span class="n">output</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
            <span class="n">verbosity</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="n">weaver</span><span class="o">=</span><span class="s2">&quot;html&quot;</span><span class="p">,</span>
            <span class="n">command</span><span class="o">=</span><span class="s1">&#39;@&#39;</span><span class="p">,</span>
            <span class="n">permitList</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">tangler_line_numbers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">webReader</span><span class="o">=</span><span class="n">pyweb</span><span class="o">.</span><span class="n">WebReader</span><span class="p">(),</span>

            <span class="n">theWeaver</span><span class="o">=</span><span class="n">MyHTML</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">parent</span><span class="p">),</span>  <span class="c1"># Customized with a specific Weaver subclass</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Options </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">pyweb</span><span class="o">.</span><span class="n">LoadAction</span><span class="p">(),</span> <span class="n">pyweb</span><span class="o">.</span><span class="n">WeaveAction</span><span class="p">():</span>
            <span class="n">action</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># CLI parsing goes here...</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;examples/test_rst.w&quot;</span><span class="p">)</span>
    <span class="n">main</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</pre></div>
</div>
<div class="small docutils container">
<p>∎ <em>weaver.py processing: load and weave the document (89)</em>.
Used by     → <a class="reference internal" href="#weave-py-86">weave.py (86)</a>.</p>
</div>
</section>
</section>
<section id="to-do">
<span id="todo"></span><h2><a class="toc-backref" href="#id83" role="doc-backlink">To Do</a><a class="headerlink" href="#to-do" title="Link to this heading">¶</a></h2>
<section id="additional-features-for-3-3">
<h3><a class="toc-backref" href="#id84" role="doc-backlink">Additional Features for 3.3</a><a class="headerlink" href="#additional-features-for-3-3" title="Link to this heading">¶</a></h3>
<p>For writing books, we need a number of new features.</p>
<dl>
<dt>[x] Implement <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> command with a <code class="docutils literal notranslate"><span class="pre">-noweave</span></code> option.</dt><dd><p>Tangling will always create all files.
Weaving will ignore this file, producing <strong>no</strong> output for this <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code>.</p>
<p>The use case is a book chapter with numerous examples in the text.
The resulting <code class="docutils literal notranslate"><span class="pre">*.py</span></code> or <code class="docutils literal notranslate"><span class="pre">*.txt</span></code> file is not shown in all of it’s glorious detail.
This file is tangled, so the code examples can be wrapped with test cases,
but this file is not described anywhere.
See <a class="reference external" href="https://github.com/slott56/py-web-tool/wiki/Tangle-only-Output">https://github.com/slott56/py-web-tool/wiki/Tangle-only-Output</a>.</p>
</dd>
</dl>
<p>[x] Refactor options parsers into class <code class="docutils literal notranslate"><span class="pre">OutputChunk</span></code> or <code class="docutils literal notranslate"><span class="pre">NamedChunk</span></code>, removing them from the <code class="docutils literal notranslate"><span class="pre">WebReader</span></code> <code class="docutils literal notranslate"><span class="pre">handleCommand()</span></code> method.</p>
<dl>
<dt>[x] Refactor macro definitions and the override rules.</dt><dd><p>Remove the limited two-tier overrides done via Jinja <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">if</span> <span class="pre">%}</span></code> constructs.
Build a <code class="docutils literal notranslate"><span class="pre">ChainMap</span></code> of all macro definitions in priority order.
The ordering is [<code class="docutils literal notranslate"><span class="pre">&#64;t</span> <span class="pre">macro</span></code>, <code class="docutils literal notranslate"><span class="pre">config.macros</span></code>, app overrides, app defaults].
Then, reduce the chain map to a single list of the highest-priority definitions of each macro.
From this list, build a final macro template for the loader.</p>
<p>This enables <code class="docutils literal notranslate"><span class="pre">&#64;t</span> <span class="pre">macro</span></code> and config-file macro definition.</p>
</dd>
<dt>[x] Refactor config file and CLI argument processing.</dt><dd><p>This can make it easier to use the config file to define macro overrides.</p>
</dd>
<dt>[x] Use additional <code class="docutils literal notranslate"><span class="pre">style</span></code> attribute of a <code class="docutils literal notranslate"><span class="pre">NamedChunk</span></code> in the  <code class="docutils literal notranslate"><span class="pre">begin_code()</span></code> template.</dt><dd><p>Source syntax uses an option to set the <code class="docutils literal notranslate"><span class="pre">style</span></code> attribute: <code class="docutils literal notranslate"><span class="pre">&#64;d</span> <span class="pre">-style</span> <span class="pre">console</span></code> or <code class="docutils literal notranslate"><span class="pre">&#64;d</span> <span class="pre">-style</span> <span class="pre">code</span></code>.
This updates the <code class="docutils literal notranslate"><span class="pre">NamedChunk</span></code> parameter parsing and the templates.</p>
<p>The use case is a book chapter with distinct formatting for REPL examples and code examples.
It may be as small as CSS classes for RST or HTML.
It may be a more elaborate set of differences in LaTeX.</p>
</dd>
<dt>[x] Provide <code class="docutils literal notranslate"><span class="pre">latex-minted</span></code> (and <code class="docutils literal notranslate"><span class="pre">tex-minted</span></code>) macros.</dt><dd><p>Also <code class="docutils literal notranslate"><span class="pre">latex-verbatim</span></code> (and <code class="docutils literal notranslate"><span class="pre">tex-verbatim</span></code>) macros.
Make minted the default.</p>
</dd>
</dl>
<p>[x] Accept macro definitions from the configuration file.</p>
<p>[x] Clean up path/directory processing to remove some assumptions uncovered via testing with pytest <code class="docutils literal notranslate"><span class="pre">tmp_path</span></code> fixture.</p>
</section>
<section id="other-extensions-for-3-4">
<h3><a class="toc-backref" href="#id85" role="doc-backlink">Other Extensions for 3.4</a><a class="headerlink" href="#other-extensions-for-3-4" title="Link to this heading">¶</a></h3>
<ol class="arabic">
<li><p>Implement <code class="docutils literal notranslate"><span class="pre">&#64;t</span></code> command to define template macros.
Add feature to <code class="docutils literal notranslate"><span class="pre">Web</span></code> to find the macro definitions.
Add feature to <code class="docutils literal notranslate"><span class="pre">Weaver</span></code> initialization.</p>
<p>A <code class="docutils literal notranslate"><span class="pre">&#64;t</span> <span class="pre">macro</span> <span class="pre">&#64;{</span></code> <em>jinja</em> <code class="docutils literal notranslate"><span class="pre">&#64;}</span></code> command will add a new macro to the list of macros to use for the current weaving language.
The <strong>Jinja</strong> code <strong>must</strong> be of the form <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">macro</span> <span class="pre">name(args)</span> <span class="pre">%}...{%</span> <span class="pre">endmacro</span> <span class="pre">%}</span></code>,
The <code class="docutils literal notranslate"><span class="pre">name</span></code> must be one of the pre-defined names, or it won’t be used by the base weaver template.</p>
<p>Also. character quote rules can be defined as part of a template. These rules will <strong>replace</strong> the default rules.</p>
<div class="highlight-jinja notranslate"><div class="highlight"><pre><span></span><span class="x">@t macro @{</span>
<span class="x">    </span><span class="cp">{%</span>- <span class="k">macro</span> <span class="nv">begin_code</span><span class="o">(</span><span class="nv">chunk</span><span class="o">)</span> <span class="cp">%}</span>
<span class="x">    ...</span>
<span class="x">    </span><span class="cp">{%</span>- <span class="k">endmacro</span> -<span class="cp">%}</span>
<span class="x">@}</span>
<span class="x">@t macro @{</span>
<span class="x">    </span><span class="cp">{%</span>- <span class="k">macro</span> <span class="nv">end_code</span><span class="o">(</span><span class="nv">chunk</span><span class="o">)</span> <span class="cp">%}</span>
<span class="x">    ...</span>
<span class="x">    </span><span class="cp">{%</span>- <span class="k">endmacro</span> -<span class="cp">%}</span>
<span class="x">@}</span>
<span class="x">@t quote @{</span>
<span class="x">    &quot;_&quot;: &quot;\_&quot;</span>
<span class="x">@}</span>
</pre></div>
</div>
</li>
</ol>
<ol class="arabic">
<li><p>Fully support <code class="docutils literal notranslate"><span class="pre">Tangler.include_line_numbers</span></code>.
This updates the <code class="docutils literal notranslate"><span class="pre">codeBlock()</span></code> method to
Stuff in a comment.</p>
<p>The comment start and comment end options
could use Jinja macros, but, a document
often has multiple languages, making this risky.</p>
</li>
</ol>
<ol class="arabic">
<li><p>Implement all four alternative references in the <code class="docutils literal notranslate"><span class="pre">end_code()</span></code> macro.</p>
<ul class="simple">
<li><p>Nothing.</p></li>
<li><p>The immediate reference.</p></li>
<li><p>The two variants on full paths:</p>
<ul>
<li><p>top-down <code class="docutils literal notranslate"><span class="pre">→</span> <span class="pre">Named</span> <span class="pre">(1)</span> <span class="pre">/</span> <span class="pre">→</span> <span class="pre">Sub-Named</span> <span class="pre">(2)</span> <span class="pre">/</span> <span class="pre">→</span> <span class="pre">Sub-Sub-Named</span> <span class="pre">(3)</span></code></p></li>
<li><p>bottom-up <code class="docutils literal notranslate"><span class="pre">→</span> <span class="pre">Sub-Sub-Named</span> <span class="pre">(3)</span> <span class="pre">∈</span> <span class="pre">→</span> <span class="pre">Sub-Named</span> <span class="pre">(2)</span> <span class="pre">∈</span> <span class="pre">→</span> <span class="pre">Named</span> <span class="pre">(1)</span></code></p></li>
</ul>
</li>
</ul>
<p>Provide needed parameters to configure the <code class="docutils literal notranslate"><span class="pre">Weaver</span></code> with one of these choices.
It seems burdensome to require a full macro definition in the config TOML file or as a <code class="docutils literal notranslate"><span class="pre">&#64;t</span> <span class="pre">macro</span></code> command.</p>
</li>
<li><p>Update the <code class="docutils literal notranslate"><span class="pre">-indent</span></code> option on <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> chunks to accept a numeric argument with the specific indentation value.
This becomes a kind of “noindent” with a given value; <code class="docutils literal notranslate"><span class="pre">-noindent</span></code> is short-hand for <code class="docutils literal notranslate"><span class="pre">-indent</span> <span class="pre">0</span></code>.
Currently, <cite>-indent</cite> and <cite>-noindent</cite> are true/false flags.</p>
<p>The complication is that <code class="docutils literal notranslate"><span class="pre">-indent</span></code> without a value becomes difficult to implement with <code class="docutils literal notranslate"><span class="pre">argparse</span></code>.</p>
</li>
<li><p>More gracefully handle the case where an output chunk has a multi-part definition.
For example,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@o</span> <span class="n">x</span><span class="o">.</span><span class="n">y</span>
<span class="o">@</span><span class="p">{</span>
<span class="o">...</span> <span class="n">part</span> <span class="mi">1</span> <span class="o">...</span>
<span class="o">@</span><span class="p">}</span>

<span class="nd">@o</span> <span class="n">x</span><span class="o">.</span><span class="n">y</span>
<span class="o">@</span><span class="p">{</span>
<span class="o">...</span> <span class="n">part</span> <span class="mi">2</span> <span class="o">...</span>
<span class="o">@</span><span class="p">}</span>
</pre></div>
</div>
<p>The above should have the same output as the following (more complex) alternative:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@o</span> <span class="n">x</span><span class="o">.</span><span class="n">y</span>
<span class="o">@</span><span class="p">{</span>
<span class="o">@&lt;</span><span class="n">part</span> <span class="mi">1</span><span class="o">@&gt;</span>
<span class="o">@&lt;</span><span class="n">part</span> <span class="mi">2</span><span class="o">@&gt;</span>
<span class="o">@</span><span class="p">}</span>

<span class="nd">@d</span> <span class="n">part</span> <span class="mi">1</span>
<span class="o">@</span><span class="p">{</span>
<span class="o">...</span> <span class="n">part</span> <span class="mi">1</span> <span class="o">...</span>
<span class="o">@</span><span class="p">}</span>

<span class="nd">@d</span> <span class="n">part</span> <span class="mi">2</span>
<span class="o">@</span><span class="p">{</span>
<span class="o">...</span> <span class="n">part</span> <span class="mi">2</span> <span class="o">...</span>
<span class="o">@</span><span class="p">}</span>
</pre></div>
</div>
<p>Currently, we casually treat the first instance as the “definition”, and don’t provide clear references to the additional parts of the definition.</p>
</li>
<li><p>Upgrade <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> to recursively examine each <code class="docutils literal notranslate"><span class="pre">Command</span></code> for RE patterns. <code class="docutils literal notranslate"><span class="pre">find_iter(re)</span></code>.
Build <code class="docutils literal notranslate"><span class="pre">has_any(re)</span></code> as an <code class="docutils literal notranslate"><span class="pre">any()</span></code> reduction of <code class="docutils literal notranslate"><span class="pre">Command</span></code> instances.</p></li>
<li><p>Upgrade <code class="docutils literal notranslate"><span class="pre">Command</span></code> to examine each line of text for an RE pattern. <code class="docutils literal notranslate"><span class="pre">find_iter(re)</span></code></p></li>
</ol>
</section>
<section id="some-additional-ideas">
<h3><a class="toc-backref" href="#id86" role="doc-backlink">Some additional ideas</a><a class="headerlink" href="#some-additional-ideas" title="Link to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p>Push <code class="docutils literal notranslate"><span class="pre">TypeId</span></code> meta-class into <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> hierarchy?
Would this break the <code class="docutils literal notranslate"><span class="pre">&#64;dataclass</span></code> nature?</p></li>
<li><p>We might want to decompose the <code class="docutils literal notranslate"><span class="pre">impl.w</span></code> file: it’s huge.
The four major sections – base model, output, input parsing, other components – make sense.
However, since the output is a <em>single</em> <code class="docutils literal notranslate"><span class="pre">.rst</span></code> file, it doesn’t change much to do this.</p></li>
<li><p>Rename the module from <code class="docutils literal notranslate"><span class="pre">pyweb</span></code> to <code class="docutils literal notranslate"><span class="pre">pylpweb</span></code> to avoid name squatting issues.
Rename the project from <code class="docutils literal notranslate"><span class="pre">py-web-lp</span></code> to <code class="docutils literal notranslate"><span class="pre">py-lpweb</span></code>.</p></li>
<li><p>Offer a basic XHTML template that uses <code class="docutils literal notranslate"><span class="pre">CDATA</span></code> sections instead of quoting.
Does require the standard quoting for the <code class="docutils literal notranslate"><span class="pre">CDATA</span></code> end tag.</p></li>
<li><p>Note that the overall <code class="docutils literal notranslate"><span class="pre">Web</span></code> is a bit like a <code class="docutils literal notranslate"><span class="pre">NamedChunk</span></code> that contains <code class="docutils literal notranslate"><span class="pre">Chunks</span></code>.
This similarity could be factored out.
While this will create a more proper <strong>Composition</strong> pattern implementation, it
leads to the question of why nest <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> or <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> chunks in the first place?</p></li>
</ol>
</section>
<section id="from-the-code">
<h3><a class="toc-backref" href="#id87" role="doc-backlink">From the code</a><a class="headerlink" href="#from-the-code" title="Link to this heading">¶</a></h3>
</section>
</section>
<section id="change-log">
<h2><a class="toc-backref" href="#id88" role="doc-backlink">Change Log</a><a class="headerlink" href="#change-log" title="Link to this heading">¶</a></h2>
<p>Changes for 3.3</p>
<ul>
<li><p>Change the output options and restructure the directories
to make the directory tree more conventional.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">docs</span></code> Has the woven documentation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">src</span></code> Has the Python application.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">web</span></code> Has the source <code class="docutils literal notranslate"><span class="pre">.w</span></code> files, except for the parent documents.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tests</span></code> Has the test modules.</p></li>
</ul>
<p>Change <code class="docutils literal notranslate"><span class="pre">pyweb</span></code> to use the following approach for output files:</p>
<ol class="arabic simple">
<li><p>A parent <code class="docutils literal notranslate"><span class="pre">.w</span></code> file is in the top-level project folder.
The location of the file is the current working directory when tangling or weaving.</p></li>
<li><p>A parent <code class="docutils literal notranslate"><span class="pre">.w</span></code> file generally uses <code class="docutils literal notranslate"><span class="pre">&#64;i</span> <span class="pre">web/this.w</span></code> to include sections into the overall web from a sub-directory, reducing clutter.</p></li>
<li><p>Each <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> uses <code class="docutils literal notranslate"><span class="pre">&#64;o</span> <span class="pre">src/whatever.py</span></code> or <code class="docutils literal notranslate"><span class="pre">&#64;o</span> <span class="pre">tests/test_whatever.py</span></code> as part of the filename. Command-line options should not be required for tangling.</p></li>
<li><p>Weaving has a default directory of <code class="docutils literal notranslate"><span class="pre">docs</span></code>, possibly overridden by the <code class="docutils literal notranslate"><span class="pre">-o</span></code> command-line option. The legacy behavior is <code class="docutils literal notranslate"><span class="pre">-o</span> <span class="pre">.</span></code>.</p></li>
</ol>
<p>This disentangles the current muddle of files found in the <code class="docutils literal notranslate"><span class="pre">src</span></code> directory.
It also allows tools like <code class="docutils literal notranslate"><span class="pre">uv</span></code> to work.</p>
<p>Changes to the files.</p>
<ol class="arabic simple">
<li><p>Move <code class="docutils literal notranslate"><span class="pre">pyweb.w</span></code> and <code class="docutils literal notranslate"><span class="pre">pyweb_test.w</span></code> to the project directory.
This directory also has <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code>, <code class="docutils literal notranslate"><span class="pre">README.rst</span></code>, etc.</p></li>
<li><p>Move other <code class="docutils literal notranslate"><span class="pre">.w</span></code> files to new <code class="docutils literal notranslate"><span class="pre">web</span></code> directory.</p></li>
<li><p>Update the <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> commands to tangle to <code class="docutils literal notranslate"><span class="pre">tests</span></code> or <code class="docutils literal notranslate"><span class="pre">src</span></code> explicitly.
(Avoids using the <code class="docutils literal notranslate"><span class="pre">-t</span></code> option to tangle to a directory.)</p></li>
<li><p>Update the <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> to reflect new file locations.</p></li>
<li><p>Create a new <code class="docutils literal notranslate"><span class="pre">index.rst</span></code> root document (and fix <code class="docutils literal notranslate"><span class="pre">docs/conf.py</span></code>).
This top-level document includes <code class="docutils literal notranslate"><span class="pre">pyweb.rst</span></code> and <code class="docutils literal notranslate"><span class="pre">pyweb_test.rst</span></code> in its toctree.</p></li>
</ol>
</li>
</ul>
<p>Changes for 3.2</p>
<ul class="simple">
<li><p>Rename to <code class="docutils literal notranslate"><span class="pre">py-web-lp</span></code> to limit collisions in PyPI.</p></li>
<li><p>Replaced <code class="docutils literal notranslate"><span class="pre">toml</span></code> with <code class="docutils literal notranslate"><span class="pre">tomli</span></code> or built-in <code class="docutils literal notranslate"><span class="pre">tomllib</span></code>.</p></li>
<li><p>Fiddle with <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code> and <code class="docutils literal notranslate"><span class="pre">tox.ini</span></code> to eliminate <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>.</p></li>
<li><p>Replaced home-brewed <code class="docutils literal notranslate"><span class="pre">OptionParser</span></code> with <code class="docutils literal notranslate"><span class="pre">argparse.ArgumentParser</span></code>.
Now the options for <code class="docutils literal notranslate"><span class="pre">&#64;d</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> can be <em>much</em> more flexible.</p></li>
<li><p>Added the transitive path of references as a Chunk property.
Removes <code class="docutils literal notranslate"><span class="pre">SimpleReference</span></code> and <code class="docutils literal notranslate"><span class="pre">TransitiveReference</span></code> classes,
and the associated “reference_style” attribute of a <code class="docutils literal notranslate"><span class="pre">Weaver</span></code>.
To show transitive references, a revised <code class="docutils literal notranslate"><span class="pre">code_end</span></code> template is required.</p></li>
<li><p>Added a TOML-based configuration file with a <code class="docutils literal notranslate"><span class="pre">[logging]</span></code> section.</p></li>
<li><p>Incorporated Sphinx and PlantUML into the documentation.
Support continues for <code class="docutils literal notranslate"><span class="pre">`rst2html.py</span></code>. It’s used for test documentaion.
See <a class="reference external" href="https://github.com/slott56/py-web-tool/wiki/PlantUML-support-for-RST-%5BCompleted%5D">https://github.com/slott56/py-web-tool/wiki/PlantUML-support-for-RST-%5BCompleted%5D</a></p></li>
<li><p>Replaced weaving process with Jinja templates.
See <a class="reference external" href="https://github.com/slott56/py-web-tool/wiki/Jinja-Template-for-Weaving-%5BCompleted%5D">https://github.com/slott56/py-web-tool/wiki/Jinja-Template-for-Weaving-%5BCompleted%5D</a></p></li>
<li><p>Dramatic redesign to Class, Chunk, and Command class hierarchies.</p></li>
<li><p>Dramatic redesign to Emitters to switch to using Jinja templates.
By stepping away from the <code class="docutils literal notranslate"><span class="pre">string.Template</span></code>,
we can incorporate list-processing <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">for</span> <span class="pre">%}...{%</span> <span class="pre">endfor</span> <span class="pre">%}</span></code> construct that
pushes some processing into the template.</p></li>
<li><p>Removed <code class="docutils literal notranslate"><span class="pre">'\N{LOZENGE}'</span></code> (borrowed from Interscript) and use the <code class="docutils literal notranslate"><span class="pre">'\N{END</span> <span class="pre">OF</span> <span class="pre">PROOF}'</span></code> symbol instead.</p></li>
<li><p>Created a better <code class="docutils literal notranslate"><span class="pre">weave.py</span></code> example that shows how to incorporate bootstrap CSS into HTML overrides.
This also requires designing a more easily extended <code class="docutils literal notranslate"><span class="pre">Weaver</span></code> class.</p></li>
</ul>
<p>Changes for 3.1</p>
<ul class="simple">
<li><p>Change to Python 3.10 as the supported version.</p></li>
<li><p>Add type hints, f-strings, <code class="docutils literal notranslate"><span class="pre">pathlib</span></code>, <code class="docutils literal notranslate"><span class="pre">abc.ABC</span></code>.</p></li>
<li><p>Replace some complex <code class="docutils literal notranslate"><span class="pre">elif</span></code> blocks with <code class="docutils literal notranslate"><span class="pre">match</span></code> statements.</p></li>
<li><p>Use <strong>pytest</strong> as a test runner.</p></li>
<li><p>Add a <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>, <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code>, <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> and <code class="docutils literal notranslate"><span class="pre">requirements-dev.txt</span></code>.</p></li>
<li><p>Implement <code class="docutils literal notranslate"><span class="pre">-o</span> <span class="pre">dir</span></code> option to write output to a directory of choice, simplifying <strong>tox</strong> setup.</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">bootstrap</span></code> directory with a snapshot of a previous working release to simplify development.</p></li>
<li><p>Add Test cases for <code class="docutils literal notranslate"><span class="pre">weave.py</span></code> and <code class="docutils literal notranslate"><span class="pre">tangle.py</span></code></p></li>
<li><p>Replace hand-built mock classes with <code class="docutils literal notranslate"><span class="pre">unittest.mock.Mock</span></code> objects</p></li>
<li><p>Separate the project into <code class="docutils literal notranslate"><span class="pre">src</span></code>, <code class="docutils literal notranslate"><span class="pre">tests</span></code>, <code class="docutils literal notranslate"><span class="pre">examples</span></code>. Cleanup <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>, <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code>, etc.</p></li>
<li><p>Silence the ERROR-level logging during testing.</p></li>
<li><p>Clean up the examples</p></li>
</ul>
<p>Changes for 3.0</p>
<ul class="simple">
<li><p>Move to GitHub</p></li>
</ul>
<p>Changes for 2.3.2.</p>
<ul class="simple">
<li><p>Fix all <code class="docutils literal notranslate"><span class="pre">{:s}</span></code> format strings to be <code class="docutils literal notranslate"><span class="pre">{!s}</span></code>.</p></li>
</ul>
<p>Changes for 2.3.1.</p>
<ul class="simple">
<li><p>Cleanup some stray comment errors.</p></li>
<li><p>Revise the documentation structure and organization.</p></li>
<li><p>Tweak the error messages.</p></li>
</ul>
<p>Changes for 2.3.</p>
<ul class="simple">
<li><p>Changed to Python 3.3 – Fixed <code class="docutils literal notranslate"><span class="pre">except</span></code>, <code class="docutils literal notranslate"><span class="pre">raise</span></code> and <code class="docutils literal notranslate"><span class="pre">%</span></code>.</p></li>
<li><p>Removed <code class="docutils literal notranslate"><span class="pre">doWrite()</span></code> and simplified <code class="docutils literal notranslate"><span class="pre">doOpen()</span></code> and <code class="docutils literal notranslate"><span class="pre">doClose()</span></code>.</p></li>
<li><p>Cleaned up RST output to be much nicer.</p></li>
<li><p>Change the baseline <code class="docutils literal notranslate"><span class="pre">pyweb.w</span></code> file to be RST instead of HTML.
docutils required to produce HTML from the woven output.</p></li>
<li><p>Removed the unconstrained <code class="docutils literal notranslate"><span class="pre">eval()</span></code> function. Provided a slim set of globals.
<code class="docutils literal notranslate"><span class="pre">os</span></code> is really just <code class="docutils literal notranslate"><span class="pre">os.path</span></code>.
Any <code class="docutils literal notranslate"><span class="pre">os.getcwd()</span></code> can be changed to <code class="docutils literal notranslate"><span class="pre">os.path.realpath('.')</span></code>.
<code class="docutils literal notranslate"><span class="pre">time</span></code> was removed and replaced with <code class="docutils literal notranslate"><span class="pre">datetime</span></code>.
Any <code class="docutils literal notranslate"><span class="pre">time.asctime()</span></code> must be <code class="docutils literal notranslate"><span class="pre">datetime.datetime.now().ctime()</span></code>.</p></li>
<li><p>Resolved a small dispute between <code class="docutils literal notranslate"><span class="pre">weaveReferenceTo()</span></code> (wrong) and <code class="docutils literal notranslate"><span class="pre">tangle()</span></code> (right).
for NamedChunks. The issue was one of failure to understand the differences
between weaving – where indentation is localized – and tangling – where indentation
must be tracked globally. Root cause was a huge problem in <code class="docutils literal notranslate"><span class="pre">codeBlock()</span></code> which didn’t
really weave properly at all.</p></li>
<li><p>Fix the tokenizer and parsing. Stop using a complex tokenizer and use a simpler
iterator over the tokens with <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> exception handling.</p></li>
<li><p>Replace <code class="docutils literal notranslate"><span class="pre">optparse</span></code> with <code class="docutils literal notranslate"><span class="pre">argparse</span></code>.</p></li>
<li><p>Get rid of the global <code class="docutils literal notranslate"><span class="pre">logger</span></code> variable.</p></li>
<li><p>Remove the filename as part of <code class="docutils literal notranslate"><span class="pre">Web()</span></code> initial creation.
A basename comes from the initial <code class="docutils literal notranslate"><span class="pre">.w</span></code> file loaded by the <code class="docutils literal notranslate"><span class="pre">WebReader</span></code>.</p></li>
<li><p>Fix the Action class hierarchy so that composite actions are simpler.</p></li>
<li><p>Change references to return <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> objects, not <code class="docutils literal notranslate"><span class="pre">(name,sequence)</span></code> pairs.</p></li>
<li><p>Make the ref list separator in <code class="docutils literal notranslate"><span class="pre">Weaver</span> <span class="pre">reference</span> <span class="pre">summary...</span></code> a proper template
feature, not a hidden punctuation mark in the code.</p></li>
<li><p>Configure <code class="docutils literal notranslate"><span class="pre">Web.reference_style</span></code> properly so that simple or transitive references
can be included as a command-line option. The default is Simple.
Add the <code class="docutils literal notranslate"><span class="pre">-r</span></code> option so that <code class="docutils literal notranslate"><span class="pre">-rt</span></code> includes transitive references.</p></li>
<li><p>Reduce the “hard-coded” punctuation. For example, the <code class="docutils literal notranslate"><span class="pre">&quot;,</span> <span class="pre">&quot;</span></code> in
<code class="docutils literal notranslate"><span class="pre">&#64;d</span> <span class="pre">Web</span> <span class="pre">weave...</span></code> <code class="docutils literal notranslate"><span class="pre">weaveChunk()</span></code>.  This was moved into a template.</p></li>
<li><p>Add an <code class="docutils literal notranslate"><span class="pre">__enter__()</span></code> and <code class="docutils literal notranslate"><span class="pre">__exit__()</span></code> to make an <code class="docutils literal notranslate"><span class="pre">Emitter</span></code>
into a proper Context Manager that can be used with a <code class="docutils literal notranslate"><span class="pre">with</span></code> statement.</p></li>
<li><p>Add the <code class="docutils literal notranslate"><span class="pre">-n</span></code> option to include tangler line numbers if the <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code> includes
the comment characters.</p></li>
<li><p>Cleanup the <code class="docutils literal notranslate"><span class="pre">TanglerMake</span></code> unit tests to remove the <code class="docutils literal notranslate"><span class="pre">sleep()</span></code>
used to assure that the timestamps really are different.</p></li>
<li><p>Cleanup the syntax for adding a comment template to <code class="docutils literal notranslate"><span class="pre">&#64;o</span></code>. Use <code class="docutils literal notranslate"><span class="pre">-start</span></code> and <code class="docutils literal notranslate"><span class="pre">-end</span></code>
before the filename.</p></li>
<li><p>Cleanup the syntax for noindent named chunks. Use <code class="docutils literal notranslate"><span class="pre">-noindent</span></code> before the chunk name.
This creates a distinct <code class="docutils literal notranslate"><span class="pre">NamedChunk_Noindent</span></code> instance that handles indentation
differently from other <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> subclasses.</p></li>
<li><p>Cleanup the <code class="docutils literal notranslate"><span class="pre">TangleAction</span></code> summary.</p></li>
<li><p>Clean up the error messages. Raising an exception seems
heavy-handed and confusing.  Count errors instead.</p></li>
</ul>
<p>Changes since version 1.4</p>
<ul class="simple">
<li><p>Removed home-brewed logger.</p></li>
<li><p>Replaced <code class="docutils literal notranslate"><span class="pre">getopt</span></code> with <code class="docutils literal notranslate"><span class="pre">optparse</span></code>.</p></li>
<li><p>Replaced LaTeX markup.</p></li>
<li><p>Corrected significant problems in cross-reference resolution.</p></li>
<li><p>Replaced all HTML and LaTeX-specific features with a much simpler template
engine which applies a template to a Chunk.  The Templates are separate
configuration items.  The big issue with templates are conditional processing
and the use of loops to handle multiple references in a transitive closure.
While it’s nice to depend on Jinja2, it’s also nice to be totally stand-alone.
Sigh.  Choices include the no-logic <code class="docutils literal notranslate"><span class="pre">string.Template</span></code> in the standard library
or the <code class="docutils literal notranslate"><span class="pre">Templite+</span></code> Recipe 576663.</p></li>
<li><p>Looked at SCons API.  Renamed “Operation” to “Action”; renamed “perform” to “__call__”.
Consider having “__call__” which does logging, then call “execute”.</p></li>
<li><p>Eliminated the EmitterFactory; replace this with simple injection of
the proper template configuration.</p></li>
<li><p>Removed the <code class="docutils literal notranslate"><span class="pre">&#64;O</span></code> command; it was essentially a variant template for LaTeX.</p></li>
<li><p>Disentangled indentation and quoting in the codeBlock.
Indentation rules vary between Tangling and Weaving.
Quoting is unique to a woven codeBlock.  Fix <code class="docutils literal notranslate"><span class="pre">referenceTo()</span></code>  to write
indented without code quoting.</p></li>
<li><p>Offer a basic RST template.
Note that colorizing may be easier to handle with an RST template.
The weaving markup template degenerates
to <code class="docutils literal notranslate"><span class="pre">..</span>&#160;&#160; <span class="pre">parsed-literal::</span></code> and indent.  By doing this,
the RST output from <em>pyWeb</em> can be run through DocUtils <code class="docutils literal notranslate"><span class="pre">rst2html.py</span></code>
or perhaps <em>Sphix</em> to create final HTML. The hard part is the indent.</p></li>
<li><p>Tweaked (but didn’t fix) ReferenceCommand tangle and all setIndent/clrIndent operations.
Only a ReferenceCommand actually cares about indentation.  And that indentation
is totally based on the “context” plus the text in the Command immediate in front
of the ReferenceCommand.</p></li>
</ul>
</section>
<section id="indices">
<h2><a class="toc-backref" href="#id89" role="doc-backlink">Indices</a><a class="headerlink" href="#indices" title="Link to this heading">¶</a></h2>
<section id="files">
<h3><a class="toc-backref" href="#id90" role="doc-backlink">Files</a><a class="headerlink" href="#files" title="Link to this heading">¶</a></h3>
<dl class="field-list simple">
<dt class="field-odd">pyweb.toml<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#pyweb-toml-78">pyweb.toml (78)</a>:pyweb.py:
→ <a class="reference internal" href="#pyweb-py-80">pyweb.py (80)</a>:tangle.py:
→ <a class="reference internal" href="#tangle-py-85">tangle.py (85)</a>:weave.py:
→ <a class="reference internal" href="#weave-py-86">weave.py (86)</a></p>
</dd>
</dl>
</section>
<section id="macros">
<h3><a class="toc-backref" href="#id91" role="doc-backlink">Macros</a><a class="headerlink" href="#macros" title="Link to this heading">¶</a></h3>
<dl class="field-list simple">
<dt class="field-odd">Action base class has common features of all actions<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#action-base-class-has-common-features-of-all-actions-55">Action base class has common features of all actions (55)</a></p>
</dd>
<dt class="field-even">Action call method actually does the real work<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#action-call-method-actually-does-the-real-work-56">Action call method actually does the real work (56)</a></p>
</dd>
<dt class="field-odd">Action class hierarchy used to describe actions of the application<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#action-class-hierarchy-used-to-describe-actions-of-the-application-54">Action class hierarchy used to describe actions of the application (54)</a></p>
</dd>
<dt class="field-even">Action final summary of what was done<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#action-final-summary-of-what-was-done-57">Action final summary of what was done (57)</a></p>
</dd>
<dt class="field-odd">ActionSequence call method delegates the sequence of ations<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#actionsequence-call-method-delegates-the-sequence-of-ations-59">ActionSequence call method delegates the sequence of ations (59)</a></p>
</dd>
<dt class="field-even">ActionSequence subclass that holds a sequence of other actions<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#actionsequence-subclass-that-holds-a-sequence-of-other-actions-58">ActionSequence subclass that holds a sequence of other actions (58)</a></p>
</dd>
<dt class="field-odd">ActionSequence summary summarizes each step<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#actionsequence-summary-summarizes-each-step-60">ActionSequence summary summarizes each step (60)</a></p>
</dd>
<dt class="field-even">Application Class for overall CLI operation<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#application-class-for-overall-cli-operation-71">Application Class for overall CLI operation (71)</a></p>
</dd>
<dt class="field-odd">Application class process all files<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#application-class-process-all-files-74">Application class process all files (74)</a></p>
</dd>
<dt class="field-even">Application default options<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#application-default-options-72">Application default options (72)</a></p>
</dd>
<dt class="field-odd">Application parse command line<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#application-parse-command-line-73">Application parse command line (73)</a></p>
</dd>
<dt class="field-even">Base Class Definitions<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#base-class-definitions-1">Base Class Definitions (1)</a>, → <a class="reference internal" href="#base-class-definitions-19">Base Class Definitions (19)</a>, → <a class="reference internal" href="#base-class-definitions-34">Base Class Definitions (34)</a></p>
</dd>
<dt class="field-odd">Chunk class hierarchy – used to describe individual chunks<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#chunk-class-hierarchy-used-to-describe-individual-chunks-8">Chunk class hierarchy – used to describe individual chunks (8)</a>, → <a class="reference internal" href="#chunk-class-hierarchy-used-to-describe-individual-chunks-9">Chunk class hierarchy – used to describe individual chunks (9)</a></p>
</dd>
<dt class="field-even">Command class hierarchy – used to describe individual commands in a chunk<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#command-class-hierarchy-used-to-describe-individual-commands-in-a-chunk-10">Command class hierarchy – used to describe individual commands in a chunk (10)</a></p>
</dd>
<dt class="field-odd">Common base template – this is used for ALL weaving<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#common-base-template-this-is-used-for-all-weaving-23">Common base template – this is used for ALL weaving (23)</a></p>
</dd>
<dt class="field-even">Debug Macros – these display debugging information<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#debug-macros-these-display-debugging-information-25">Debug Macros – these display debugging information (25)</a></p>
</dd>
<dt class="field-odd">Emitter base class<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#emitter-base-class-21">Emitter base class (21)</a></p>
</dd>
<dt class="field-even">Emitter indent control<span class="colon">:</span></dt>
<dd class="field-even"><p>set, clear and reset:
→ <a class="reference internal" href="#emitter-indent-control-set-clear-and-reset-31">Emitter indent control: set, clear and reset (31)</a></p>
</dd>
<dt class="field-odd">Emitter write a block of code with proper indents<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#emitter-write-a-block-of-code-with-proper-indents-30">Emitter write a block of code with proper indents (30)</a></p>
</dd>
<dt class="field-even">Error class defines the errors raised<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#error-class-defines-the-errors-raised-53">Error class defines the errors raised (53)</a></p>
</dd>
<dt class="field-odd">HTML Macros – emit HTML weave output<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#html-macros-emit-html-weave-output-27">HTML Macros – emit HTML weave output (27)</a></p>
</dd>
<dt class="field-even">Imports<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#imports-2">Imports (2)</a>, → <a class="reference internal" href="#imports-11">Imports (11)</a>, → <a class="reference internal" href="#imports-20">Imports (20)</a>, → <a class="reference internal" href="#imports-32">Imports (32)</a>, → <a class="reference internal" href="#imports-43">Imports (43)</a>, → <a class="reference internal" href="#imports-48">Imports (48)</a>, → <a class="reference internal" href="#imports-51">Imports (51)</a>, → <a class="reference internal" href="#imports-70">Imports (70)</a>, → <a class="reference internal" href="#imports-75">Imports (75)</a>, → <a class="reference internal" href="#imports-81">Imports (81)</a></p>
</dd>
<dt class="field-odd">Interface Functions<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#interface-functions-79">Interface Functions (79)</a></p>
</dd>
<dt class="field-even">LaTeX Macros – emit LaTeX weave output<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#latex-macros-emit-latex-weave-output-28">LaTeX Macros – emit LaTeX weave output (28)</a></p>
</dd>
<dt class="field-odd">LoadAction call method loads the input files<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#loadaction-call-method-loads-the-input-files-68">LoadAction call method loads the input files (68)</a></p>
</dd>
<dt class="field-even">LoadAction subclass loads the document web<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#loadaction-subclass-loads-the-document-web-67">LoadAction subclass loads the document web (67)</a></p>
</dd>
<dt class="field-odd">LoadAction summary provides lines read<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#loadaction-summary-provides-lines-read-69">LoadAction summary provides lines read (69)</a></p>
</dd>
<dt class="field-even">Logging Setup<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#logging-setup-76">Logging Setup (76)</a>, → <a class="reference internal" href="#logging-setup-77">Logging Setup (77)</a></p>
</dd>
<dt class="field-odd">Overheads<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#overheads-82">Overheads (82)</a>, → <a class="reference internal" href="#overheads-83">Overheads (83)</a>, → <a class="reference internal" href="#overheads-84">Overheads (84)</a></p>
</dd>
<dt class="field-even">Quote Rules Base Class<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#quote-rules-base-class-24">Quote Rules Base Class (24)</a></p>
</dd>
<dt class="field-odd">RST Macros – the default weave output<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#rst-macros-the-default-weave-output-26">RST Macros – the default weave output (26)</a></p>
</dd>
<dt class="field-even">TangleAction call method does tangling of the output files<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#tangleaction-call-method-does-tangling-of-the-output-files-65">TangleAction call method does tangling of the output files (65)</a></p>
</dd>
<dt class="field-odd">TangleAction subclass initiates the tangle action<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#tangleaction-subclass-initiates-the-tangle-action-64">TangleAction subclass initiates the tangle action (64)</a></p>
</dd>
<dt class="field-even">TangleAction summary method provides total lines tangled<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#tangleaction-summary-method-provides-total-lines-tangled-66">TangleAction summary method provides total lines tangled (66)</a></p>
</dd>
<dt class="field-odd">Tangler Subclass – emits the output files<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#tangler-subclass-emits-the-output-files-29">Tangler Subclass – emits the output files (29)</a></p>
</dd>
<dt class="field-even">TanglerMake Subclass – extends Tangler to avoid touching files that didn’t change<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#tanglermake-subclass-extends-tangler-to-avoid-touching-files-that-didn-t-change-33">TanglerMake Subclass – extends Tangler to avoid touching files that didn’t change (33)</a></p>
</dd>
<dt class="field-odd">The CodeCommand Class<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#the-codecommand-class-16">The CodeCommand Class (16)</a></p>
</dd>
<dt class="field-even">The Command Abstract Base Class<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#the-command-abstract-base-class-13">The Command Abstract Base Class (13)</a></p>
</dd>
<dt class="field-odd">The HasText Type Hint – used instead of another abstract class<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#the-hastext-type-hint-used-instead-of-another-abstract-class-14">The HasText Type Hint – used instead of another abstract class (14)</a></p>
</dd>
<dt class="field-even">The ReferenceCommand Class<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#the-referencecommand-class-17">The ReferenceCommand Class (17)</a></p>
</dd>
<dt class="field-odd">The TextCommand Class<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#the-textcommand-class-15">The TextCommand Class (15)</a></p>
</dd>
<dt class="field-even">The TypeId Class – to help the template engine<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#the-typeid-class-to-help-the-template-engine-12">The TypeId Class – to help the template engine (12)</a></p>
</dd>
<dt class="field-odd">The XrefCommand Subclasses – files, macros, and user names<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#the-xrefcommand-subclasses-files-macros-and-user-names-18">The XrefCommand Subclasses – files, macros, and user names (18)</a></p>
</dd>
<dt class="field-even">Tokenizer class - breaks input into tokens<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#tokenizer-class-breaks-input-into-tokens-52">Tokenizer class - breaks input into tokens (52)</a></p>
</dd>
<dt class="field-odd">WeaveAction call method to weave<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#weaveaction-call-method-to-weave-62">WeaveAction call method to weave (62)</a></p>
</dd>
<dt class="field-even">WeaveAction subclass initiates the weave action<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#weaveaction-subclass-initiates-the-weave-action-61">WeaveAction subclass initiates the weave action (61)</a></p>
</dd>
<dt class="field-odd">WeaveAction summary<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#weaveaction-summary-63">WeaveAction summary (63)</a></p>
</dd>
<dt class="field-even">Weaver Subclass – Uses Jinja templates to weave documentation<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#weaver-subclass-uses-jinja-templates-to-weave-documentation-22">Weaver Subclass – Uses Jinja templates to weave documentation (22)</a></p>
</dd>
<dt class="field-odd">Web class – describes the overall “web” of chunks<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#web-class-describes-the-overall-web-of-chunks-3">Web class – describes the overall “web” of chunks (3)</a>, → <a class="reference internal" href="#web-class-describes-the-overall-web-of-chunks-4">Web class – describes the overall “web” of chunks (4)</a>, → <a class="reference internal" href="#web-class-describes-the-overall-web-of-chunks-5">Web class – describes the overall “web” of chunks (5)</a>, → <a class="reference internal" href="#web-class-describes-the-overall-web-of-chunks-6">Web class – describes the overall “web” of chunks (6)</a>, → <a class="reference internal" href="#web-class-describes-the-overall-web-of-chunks-7">Web class – describes the overall “web” of chunks (7)</a></p>
</dd>
<dt class="field-even">WebReader class - parses the input file, building the Web structure<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#webreader-class-parses-the-input-file-building-the-web-structure-35">WebReader class - parses the input file, building the Web structure (35)</a></p>
</dd>
<dt class="field-odd">WebReader command literals<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#webreader-command-literals-50">WebReader command literals (50)</a></p>
</dd>
<dt class="field-even">WebReader handle a command string<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#webreader-handle-a-command-string-36">WebReader handle a command string (36)</a>, → <a class="reference internal" href="#webreader-handle-a-command-string-46">WebReader handle a command string (46)</a></p>
</dd>
<dt class="field-odd">WebReader load the web<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#webreader-load-the-web-49">WebReader load the web (49)</a></p>
</dd>
<dt class="field-even">WebReader location in the input stream<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#webreader-location-in-the-input-stream-47">WebReader location in the input stream (47)</a></p>
</dd>
<dt class="field-odd">add a reference command to the current chunk<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#add-a-reference-command-to-the-current-chunk-42">add a reference command to the current chunk (42)</a></p>
</dd>
<dt class="field-even">add an expression command to the current chunk<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#add-an-expression-command-to-the-current-chunk-44">add an expression command to the current chunk (44)</a></p>
</dd>
<dt class="field-odd">assign user identifiers to the current chunk<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#assign-user-identifiers-to-the-current-chunk-41">assign user identifiers to the current chunk (41)</a></p>
</dd>
<dt class="field-even">double at-sign replacement, append this character to previous TextCommand<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#double-at-sign-replacement-append-this-character-to-previous-textcommand-45">double at-sign replacement, append this character to previous TextCommand (45)</a></p>
</dd>
<dt class="field-odd">finish a chunk, start a new Chunk adding it to the web<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#finish-a-chunk-start-a-new-chunk-adding-it-to-the-web-40">finish a chunk, start a new Chunk adding it to the web (40)</a></p>
</dd>
<dt class="field-even">include another file<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#include-another-file-39">include another file (39)</a></p>
</dd>
<dt class="field-odd">start a NamedChunk or NamedDocumentChunk, adding it to the web<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#start-a-namedchunk-or-nameddocumentchunk-adding-it-to-the-web-38">start a NamedChunk or NamedDocumentChunk, adding it to the web (38)</a></p>
</dd>
<dt class="field-even">start an OutputChunk, adding it to the web<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#start-an-outputchunk-adding-it-to-the-web-37">start an OutputChunk, adding it to the web (37)</a></p>
</dd>
<dt class="field-odd">weave.py custom weaver definition to customize the Weaver being used<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#weave-py-custom-weaver-definition-to-customize-the-weaver-being-used-88">weave.py custom weaver definition to customize the Weaver being used (88)</a></p>
</dd>
<dt class="field-even">weave.py overheads for correct operation of a script<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#weave-py-overheads-for-correct-operation-of-a-script-87">weave.py overheads for correct operation of a script (87)</a></p>
</dd>
<dt class="field-odd">weaver.py processing<span class="colon">:</span></dt>
<dd class="field-odd"><p>load and weave the document:
→ <a class="reference internal" href="#weaver-py-processing-load-and-weave-the-document-89">weaver.py processing: load and weave the document (89)</a></p>
</dd>
</dl>
</section>
<section id="user-identifiers">
<h3><a class="toc-backref" href="#id92" role="doc-backlink">User Identifiers</a><a class="headerlink" href="#user-identifiers" title="Link to this heading">¶</a></h3>
<dl class="field-list simple">
<dt class="field-odd">Action<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#action-base-class-has-common-features-of-all-actions-55">Action base class has common features of all actions (55)</a></p>
</dd>
<dt class="field-even">ActionSequence<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#actionsequence-subclass-that-holds-a-sequence-of-other-actions-58">ActionSequence subclass that holds a sequence of other actions (58)</a></p>
</dd>
<dt class="field-odd">Application<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#application-class-for-overall-cli-operation-71">Application Class for overall CLI operation (71)</a></p>
</dd>
<dt class="field-even">Chunk<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#chunk-class-hierarchy-used-to-describe-individual-chunks-9">Chunk class hierarchy – used to describe individual chunks (9)</a></p>
</dd>
<dt class="field-odd">Error<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#error-class-defines-the-errors-raised-53">Error class defines the errors raised (53)</a></p>
</dd>
<dt class="field-even">LoadAction<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#loadaction-subclass-loads-the-document-web-67">LoadAction subclass loads the document web (67)</a></p>
</dd>
<dt class="field-odd">NamedChunk<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#chunk-class-hierarchy-used-to-describe-individual-chunks-9">Chunk class hierarchy – used to describe individual chunks (9)</a></p>
</dd>
<dt class="field-even">NamedDocumentChunk<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#chunk-class-hierarchy-used-to-describe-individual-chunks-9">Chunk class hierarchy – used to describe individual chunks (9)</a></p>
</dd>
<dt class="field-odd">OutputChunk<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#chunk-class-hierarchy-used-to-describe-individual-chunks-9">Chunk class hierarchy – used to describe individual chunks (9)</a></p>
</dd>
<dt class="field-even">TangleAction<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#tangleaction-subclass-initiates-the-tangle-action-64">TangleAction subclass initiates the tangle action (64)</a></p>
</dd>
<dt class="field-odd">Tokenizer<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#tokenizer-class-breaks-input-into-tokens-52">Tokenizer class - breaks input into tokens (52)</a></p>
</dd>
<dt class="field-even">TypeId<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#the-typeid-class-to-help-the-template-engine-12">The TypeId Class – to help the template engine (12)</a></p>
</dd>
<dt class="field-odd">TypeIdMeta<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#the-typeid-class-to-help-the-template-engine-12">The TypeId Class – to help the template engine (12)</a></p>
</dd>
<dt class="field-even">WeaveAction<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#weaveaction-subclass-initiates-the-weave-action-61">WeaveAction subclass initiates the weave action (61)</a></p>
</dd>
<dt class="field-odd">Web<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#web-class-describes-the-overall-web-of-chunks-3">Web class – describes the overall “web” of chunks (3)</a>, → <a class="reference internal" href="#web-class-describes-the-overall-web-of-chunks-7">Web class – describes the overall “web” of chunks (7)</a></p>
</dd>
<dt class="field-even">WebReader<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#webreader-class-parses-the-input-file-building-the-web-structure-35">WebReader class - parses the input file, building the Web structure (35)</a></p>
</dd>
<dt class="field-odd">__version__<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#overheads-84">Overheads (84)</a></p>
</dd>
<dt class="field-even">addIndent<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#emitter-indent-control-set-clear-and-reset-31">Emitter indent control: set, clear and reset (31)</a></p>
</dd>
<dt class="field-odd">argparse<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#imports-70">Imports (70)</a></p>
</dd>
<dt class="field-even">builtins<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#imports-43">Imports (43)</a></p>
</dd>
<dt class="field-odd">clrIndent<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#emitter-indent-control-set-clear-and-reset-31">Emitter indent control: set, clear and reset (31)</a></p>
</dd>
<dt class="field-even">codeBlock<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#emitter-write-a-block-of-code-with-proper-indents-30">Emitter write a block of code with proper indents (30)</a></p>
</dd>
<dt class="field-odd">datetime<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#imports-81">Imports (81)</a></p>
</dd>
<dt class="field-even">duration<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#action-final-summary-of-what-was-done-57">Action final summary of what was done (57)</a></p>
</dd>
<dt class="field-odd">expect<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#webreader-handle-a-command-string-46">WebReader handle a command string (46)</a></p>
</dd>
<dt class="field-even">handleCommand<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#webreader-handle-a-command-string-36">WebReader handle a command string (36)</a></p>
</dd>
<dt class="field-odd">load<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#webreader-load-the-web-49">WebReader load the web (49)</a></p>
</dd>
<dt class="field-even">location<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#webreader-location-in-the-input-stream-47">WebReader location in the input stream (47)</a></p>
</dd>
<dt class="field-odd">logging<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#imports-75">Imports (75)</a></p>
</dd>
<dt class="field-even">logging.config<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#imports-75">Imports (75)</a></p>
</dd>
<dt class="field-odd">os<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#imports-81">Imports (81)</a></p>
</dd>
<dt class="field-even">parse<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#webreader-load-the-web-49">WebReader load the web (49)</a></p>
</dd>
<dt class="field-odd">parseArgs<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#application-parse-command-line-73">Application parse command line (73)</a></p>
</dd>
<dt class="field-even">perform<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#action-call-method-actually-does-the-real-work-56">Action call method actually does the real work (56)</a>, → <a class="reference internal" href="#actionsequence-call-method-delegates-the-sequence-of-ations-59">ActionSequence call method delegates the sequence of ations (59)</a>, → <a class="reference internal" href="#weaveaction-call-method-to-weave-62">WeaveAction call method to weave (62)</a>, → <a class="reference internal" href="#tangleaction-call-method-does-tangling-of-the-output-files-65">TangleAction call method does tangling of the output files (65)</a>, → <a class="reference internal" href="#loadaction-call-method-loads-the-input-files-68">LoadAction call method loads the input files (68)</a></p>
</dd>
<dt class="field-odd">platform<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#imports-43">Imports (43)</a></p>
</dd>
<dt class="field-even">process<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#application-class-process-all-files-74">Application class process all files (74)</a></p>
</dd>
<dt class="field-odd">re<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#imports-51">Imports (51)</a></p>
</dd>
<dt class="field-even">resetIndent<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#emitter-indent-control-set-clear-and-reset-31">Emitter indent control: set, clear and reset (31)</a></p>
</dd>
<dt class="field-odd">setIndent<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#emitter-indent-control-set-clear-and-reset-31">Emitter indent control: set, clear and reset (31)</a></p>
</dd>
<dt class="field-even">shlex<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#imports-70">Imports (70)</a></p>
</dd>
<dt class="field-odd">summary<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#action-final-summary-of-what-was-done-57">Action final summary of what was done (57)</a>, → <a class="reference internal" href="#actionsequence-summary-summarizes-each-step-60">ActionSequence summary summarizes each step (60)</a>, → <a class="reference internal" href="#weaveaction-summary-63">WeaveAction summary (63)</a>, → <a class="reference internal" href="#tangleaction-summary-method-provides-total-lines-tangled-66">TangleAction summary method provides total lines tangled (66)</a>, → <a class="reference internal" href="#loadaction-summary-provides-lines-read-69">LoadAction summary provides lines read (69)</a></p>
</dd>
<dt class="field-even">sys<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#imports-43">Imports (43)</a>, → <a class="reference internal" href="#imports-81">Imports (81)</a></p>
</dd>
<dt class="field-odd">time<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#imports-81">Imports (81)</a></p>
</dd>
<dt class="field-even">tomllib<span class="colon">:</span></dt>
<dd class="field-even"><p>→ <a class="reference internal" href="#imports-81">Imports (81)</a></p>
</dd>
<dt class="field-odd">types<span class="colon">:</span></dt>
<dd class="field-odd"><p>→ <a class="reference internal" href="#imports-81">Imports (81)</a></p>
</dd>
</dl>
<hr class="docutils" />
<div class="small docutils container">
<blockquote>
<div><p>Created by src/pyweb.py at Thu Oct 24 08:58:40 2024.</p>
</div></blockquote>
<p>Source pyweb.w modified Sun Oct 20 13:50:05 2024.</p>
<blockquote>
<div><p>pyweb.__version__ ‘3.3’.</p>
<p>Working directory ‘/Users/slott/Documents/Projects/py-web-tool’.</p>
</div></blockquote>
</div>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">PyWebTool</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">pyWeb Literate Programming 3.3</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#installing">Installing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#using">Using</a></li>
<li class="toctree-l2"><a class="reference internal" href="#more-advanced-usage">More Advanced Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-py-web-lp-markup-language">The <strong>py-web-lp</strong> Markup Language</a></li>
<li class="toctree-l2"><a class="reference internal" href="#architecture-and-design-overview">Architecture and Design Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implementation">Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#handy-scripts">Handy Scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="#to-do">To Do</a></li>
<li class="toctree-l2"><a class="reference internal" href="#change-log">Change Log</a></li>
<li class="toctree-l2"><a class="reference internal" href="#indices">Indices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="pyweb_test.html">pyWeb Literate Programming 3.3 - Test Suite</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="index.html" title="previous chapter">pyWeb Literate Programming</a></li>
      <li>Next: <a href="pyweb_test.html" title="next chapter">pyWeb Literate Programming 3.3 - Test Suite</a></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2022, S.Lott.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="_sources/pyweb.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>